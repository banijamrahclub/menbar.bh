<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ŸÖŸêŸÄŸÜŸÄÿ®ŸéŸÄÿ± - ŸÖŸÜÿµÿ© ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä</title>
    <!-- 
      IMPORTANT: This site uses Netlify Functions for cloud processing.
      Make sure to upload the 'netlify' folder and 'netlify.toml' file.
    -->
    <!-- Content Security Policy (CSP) for extra protection -->
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https: data: blob:; img-src 'self' https: data: blob:; connect-src 'self' https:;">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- AI Background Removal -->
    <script src="https://cdn.jsdelivr.net/npm/@imgly/background-removal@1.4.5/dist/bundle.js"></script>
    <!-- LameJS for MP3 Encoding -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lamejs/1.2.1/lame.min.js"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- PSD Engine will be loaded dynamically when needed -->

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap');

        :root {
            --background: #000000;
            --surface: #030712;
            --surface-hover: #0f172a;
            --border: #1e293b;

            /* Minbar Brand Colors (Premium Dark Blue) */
            --primary: #004aad;
            --primary-hover: #0059d1;
            --primary-dim: #003087;

            --text-primary: #ffffff;
            --text-secondary: #94a3b8;

            --success: #10b981;
            --error: #ef4444;

            --font-main: 'Tajawal', sans-serif;

            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 24px;
        }

        * {
            box-sizing: border-box;
            padding: 0;
            margin: 0;
        }

        ::selection {
            background: var(--primary);
            color: white;
        }

        body {
            background-color: var(--background);
            color: var(--text-primary);
            font-family: var(--font-main);
            direction: rtl;
            min-height: 100vh;
            overflow-x: hidden;
        }

        a {
            color: inherit;
            text-decoration: none;
            cursor: pointer;
        }

        button {
            font-family: var(--font-main);
        }

        /* Utilities */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            border-radius: var(--radius-md);
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 1rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dim) 100%);
            color: #ffffff;
            box-shadow: 0 4px 15px rgba(21, 101, 192, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.3);
            filter: brightness(1.1);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-primary);
        }

        .btn-outline:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .card {
            background: rgba(15, 15, 15, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 24px;
            transition: border-color 0.3s ease;
        }

        .card:hover {
            border-color: var(--primary-dim);
        }

        /* Typography */
        h1 {
            font-size: 3rem;
            font-weight: 800;
            line-height: 1.2;
            margin-bottom: 1rem;
        }

        h2 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        h3 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        p {
            line-height: 1.6;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        /* Effects */
        .glow-text {
            text-shadow: 0 0 20px rgba(21, 101, 192, 0.6);
        }

        /* Navbar */
        .navbar {
            height: 80px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border);
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-content {
            display: flex;
            justify-content: space-between;
            width: 100%;
            align-items: center;
        }

        .nav-link {
            margin-left: 20px;
            font-weight: 500;
            transition: color 0.2s;
        }

        .nav-link:hover {
            color: var(--primary);
        }

        /* Hero */
        .hero {
            min-height: 80vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            background: radial-gradient(circle at 50% 50%, rgba(21, 101, 192, 0.15) 0%, transparent 60%);
        }

        .input-field {
            width: 100%;
            padding: 12px 16px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: white;
            margin-bottom: 16px;
            font-family: var(--font-main);
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary);
        }

        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            background: rgba(212, 175, 55, 0.1);
            color: var(--primary);
            font-size: 0.875rem;
            font-weight: 500;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.6s ease-out forwards;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                filter: drop-shadow(0 0 5px rgba(0, 74, 173, 0.4));
            }

            50% {
                transform: scale(1.05);
                filter: drop-shadow(0 0 25px rgba(0, 74, 173, 0.8));
            }

            100% {
                transform: scale(1);
                filter: drop-shadow(0 0 5px rgba(0, 74, 173, 0.4));
            }
        }

        .animate-pulse {
            animation: pulse 2s infinite ease-in-out;
            display: inline-block;
        }

        /* Mobile Adjustments */
        @media (max-width: 768px) {
            h1 {
                font-size: 2.2rem;
            }

            h2 {
                font-size: 1.6rem;
            }

            .container {
                padding: 0 15px;
            }

            .card {
                padding: 20px 15px;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.8rem;
            }

            .btn {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, createContext, useContext, useRef, useMemo } = React;
        console.log('Script started');
        document.body.style.background = '#111';

        document.body.style.background = '#111';

        // --- Smart API Detection for Render/Local ---
        const BASE_API_URL = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
            ? 'http://localhost:8000'
            : window.location.origin; // Dynamically use the Render service URL

        // --- Global Error Handler ---
        window.onerror = function (msg, url, line, col, error) {
            if (msg.toLowerCase().includes('resize') || msg.toLowerCase().includes('script error')) return;
            console.error("Global Error:", msg, error);
        };

        // --- Safe Storage Helper (Global) ---
        const safeStorage = {
            getItem: (key) => {
                try {
                    if (typeof window !== 'undefined' && window.localStorage) {
                        return localStorage.getItem(key);
                    }
                } catch (e) { /* Ignore security errors */ }
                return window['_safe_' + key] || null;
            },
            setItem: (key, value) => {
                try {
                    if (typeof window !== 'undefined' && window.localStorage) {
                        localStorage.setItem(key, value);
                    }
                } catch (e) { /* Ignore */ }
                window['_safe_' + key] = value;
            },
            removeItem: (key) => {
                try { localStorage.removeItem(key); } catch (e) { delete window['_safe_' + key]; }
            }
        };


        // --- Simplified Router ---
        const RouterContext = createContext();

        function RouterProvider({ children }) {
            // 1. Initialize from Hash (for Refresh) or Session Memory
            const getInitialPath = () => {
                try {
                    // Check if this is a fresh visit in this browser session
                    const isNewSession = !sessionStorage.getItem('aza_session_active');

                    if (isNewSession) {
                        sessionStorage.setItem('aza_session_active', 'true');
                        // Always start at home on first open
                        if (window.location.hash && window.location.hash !== '#/') {
                            window.location.hash = '/';
                        }
                        return '/';
                    }
                } catch (e) { console.warn("Session storage failed", e); }

                // If not a new session (e.g., refresh), try Hash then LocalStorage
                const hash = window.location.hash.slice(1);
                if (hash) return hash;
                return safeStorage.getItem('crt_last_path') || '/';
            };

            const [path, setPath] = useState(getInitialPath);
            const [params, setParams] = useState({});

            // 2. Sync Hash on Logic Change
            const push = (newPath) => {
                let finalPath = newPath;
                if (newPath.includes('?')) {
                    const [p, q] = newPath.split('?');
                    const searchParams = new URLSearchParams(q);
                    const newParams = {};
                    for (const [key, value] of searchParams.entries()) {
                        newParams[key] = value;
                    }
                    setPath(p);
                    setParams(newParams);
                    finalPath = p;
                } else {
                    setPath(newPath);
                    setParams({});
                }
                safeStorage.setItem('crt_last_path', finalPath);
                // Update URL Hash so refresh works
                window.location.hash = finalPath;
                window.scrollTo(0, 0);
            };

            // 3. Listen to Hash Changes (Browser Back/Forward)
            useEffect(() => {
                const handleHashChange = () => {
                    const hash = window.location.hash.slice(1);
                    if (hash && hash !== path) {
                        setPath(hash);
                    }
                };
                window.addEventListener('hashchange', handleHashChange);
                return () => window.removeEventListener('hashchange', handleHashChange);
            }, [path]);

            return (
                <RouterContext.Provider value={{ path, params, push }}>
                    {children}
                </RouterContext.Provider>
            );
        }

        const useRouter = () => useContext(RouterContext);

        // --- Firebase Config --
        const firebaseConfig = {
            apiKey: "AIzaSyBvHtlhQVZxS1WZh1ZO8AygYLteS4t8jbw",
            authDomain: "lmmax-21e96.firebaseapp.com",
            projectId: "lmmax-21e96",
            storageBucket: "lmmax-21e96.firebasestorage.app",
            messagingSenderId: "75890617380",
            appId: "1:75890617380:web:80a3eea84c9374b551bcb1",
            measurementId: "G-RY169VNGCM"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- TRANSLATIONS ---
        const translations = {
            ar: {
                nav_home: "ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©",
                nav_pricing: "ÿßŸÑÿ®ÿßŸÇÿßÿ™",
                nav_tools: "ÿ£ÿØŸàÿßÿ™ŸÜÿß",
                nav_who: "ŸÖŸÜ ŸÜÿ≠ŸÜ",
                nav_login: "ÿØÿÆŸàŸÑ",
                nav_profile: "ŸÖÿπŸÑŸàŸÖÿßÿ™Ÿä",
                nav_history: "ÿ≥ÿ¨ŸÑ ÿßŸÑÿπŸÖŸÑŸäÿßÿ™",
                nav_logout: "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿÆÿ±Ÿàÿ¨",
                hero_title: "ÿßÿ≥ÿ™ŸàÿØŸäŸà ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä",
                hero_desc: "ŸÖŸÉÿ≥ÿßÿ¨ ÿµŸàÿ™Ÿä ÿßÿ≠ÿ™ÿ±ÿßŸÅŸä ‚Ä¢ ÿ•ŸÜÿ¥ÿßÿ° ÿµŸàÿ± ÿ®ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä ‚Ä¢ ÿ•ŸÜÿ™ÿßÿ¨ ŸÖÿ≠ÿ™ŸàŸâ ÿßÿ≠ÿ™ÿ±ÿßŸÅŸä\nŸÉŸÑ ŸÖÿß ÿ™ÿ≠ÿ™ÿßÿ¨Ÿá ŸÑÿ•ŸÜÿ™ÿßÿ¨ ŸÖÿ≠ÿ™ŸàŸâ ÿßÿ≠ÿ™ÿ±ÿßŸÅŸä ŸÅŸä ŸÖŸÉÿßŸÜ Ÿàÿßÿ≠ÿØ",
                tools_ads: "ŸÖŸàŸÑÿØ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™",
                tools_ads_desc: "ÿ£ŸÜÿ¥ÿ¶ ÿ•ÿπŸÑÿßŸÜÿßÿ™ ÿßŸÑŸÖŸàÿßŸÑŸäÿØ ŸàÿßŸÑŸàŸÅŸäÿßÿ™ ŸàÿßŸÑÿπÿ≤ÿßÿ° ÿ®ÿßÿ≠ÿ™ÿ±ÿßŸÅŸäÿ© Ÿàÿ≥ÿ±ÿπÿ© ŸÅÿßÿ¶ŸÇÿ©.",
                hero_btn_reg: "ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ®",
                hero_btn_login: "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ",
                hero_btn_pricing: "ÿßŸÑÿ®ÿßŸÇÿßÿ™",
                pricing_title: "ÿ®ÿßŸÇÿßÿ™ ÿ¥ÿ≠ŸÜ ÿßŸÑÿ±ÿµŸäÿØ",
                tools_img: "ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿµŸàÿ± ÿ®ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä",
                tools_img_desc: "ÿßÿ®ÿ™ŸÉÿ± ÿµŸàÿ±ÿßŸã ŸÅŸÜŸäÿ© Ÿàÿ™ÿµÿßŸÖŸäŸÖ ŸÖÿ∞ŸáŸÑÿ© ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä",
                btn_start: "ÿßÿ®ÿØÿ£ ÿßŸÑÿ¢ŸÜ",
                credits: "ŸÉÿ±ŸäÿØŸäÿ™",
                welcome: "ÿ£ŸáŸÑÿßŸã ÿ®ŸÉ",
                your_tools: "ÿ£ÿØŸàÿßÿ™ŸÜÿß ÿßŸÑÿ∞ŸÉŸäÿ© ÿßŸÑŸÖÿ™ŸÉÿßŸÖŸÑÿ©",
                balance: "ÿ±ÿµŸäÿØŸÉ ÿßŸÑÿ≠ÿßŸÑŸä",
                upgrade: "ÿ™ÿ±ŸÇŸäÿ© ÿßŸÑÿ±ÿµŸäÿØ",
                gen_title: "ÿßÿ≥ÿ™ŸàÿØŸäŸà ÿßŸÑÿµŸàÿ± ÿßŸÑÿ∞ŸÉŸä (Image Studio)",
                gen_desc: "ÿ≠ŸàŸÑ ÿ£ŸÅŸÉÿßÿ±ŸÉ ÿ•ŸÑŸâ ŸÑŸàÿ≠ÿßÿ™ ŸÅŸÜŸäÿ© ŸÖÿ∞ŸáŸÑÿ© ŸÅŸä ÿ´ŸàÿßŸÜŸç ŸÖÿπÿØŸàÿØÿ©",
                gen_placeholder: "ÿµŸÅ ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑÿ™Ÿä ÿ™ÿ™ÿÆŸäŸÑŸáÿß ÿ®ŸÉŸÑ ÿ™ŸÅÿßÿµŸäŸÑŸáÿß (ŸäŸÖŸÉŸÜŸÉ ÿßŸÑŸÉÿ™ÿßÿ®ÿ© ÿ®ÿßŸÑÿπÿ±ÿ®Ÿä ÿ£Ÿà ÿßŸÑÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿä)...",
                gen_btn: "ÿ•ŸÜÿ¥ÿßÿ° ÿµŸàÿ±ÿ©",
                gen_upload: "ÿ±ŸÅÿπ ÿµŸàÿ±ÿ© ŸÖÿ±ÿ¨ÿπŸäÿ© (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)",
                hist_title: "ÿ≥ÿ¨ŸÑ ÿßŸÑÿπŸÖŸÑŸäÿßÿ™ ÿßŸÑÿ≥ÿßÿ®ŸÇÿ©",
                hist_empty: "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿπŸÖŸÑŸäÿßÿ™ ÿ≥ÿßÿ®ŸÇÿ© ÿ®ÿπÿØ",
                login_title: "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ",
                login_google: "ÿßŸÑÿØÿÆŸàŸÑ ÿπÿ®ÿ± Google",
                login_or: "ÿ£Ÿà ÿπÿ®ÿ± ÿßŸÑÿ®ÿ±ŸäÿØ",
                login_btn: "ÿØÿÆŸàŸÑ",
                login_no_account: "ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿ≠ÿ≥ÿßÿ®ÿü",
                login_create: "ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ® ÿ¨ÿØŸäÿØ",
                reg_title: "ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ® ÿ¨ÿØŸäÿØ",
                reg_google: "ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿπÿ®ÿ± Google",
                reg_btn: "ÿ™ÿ≥ÿ¨ŸäŸÑ ŸàÿßŸÜÿ∑ŸÑÿßŸÇ",
                reg_have_account: "ŸÑÿØŸäŸÉ ÿ≠ÿ≥ÿßÿ® ÿ®ÿßŸÑŸÅÿπŸÑÿü",
                status_reading: "ÿ¨ÿßÿ±Ÿä ŸÇÿ±ÿßÿ°ÿ© ŸàÿµŸÅŸÉ...",
                status_translating: "ÿ¨ÿßÿ±Ÿä ÿ™ÿ±ÿ¨ŸÖÿ© ÿßŸÑŸàÿµŸÅ...",
                status_drawing: "ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ±ÿ≥ŸÖ...",
                status_details: "ÿ¨ÿßÿ±Ÿä ÿ±ÿ≥ŸÖ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿØŸÇŸäŸÇÿ©...",
                status_coloring: "ÿ™ŸÑŸàŸäŸÜ ÿßŸÑŸÑŸàÿ≠ÿ©...",
                status_lighting: "Ÿàÿ∂ÿπ ÿßŸÑŸÑŸÖÿ≥ÿßÿ™ ÿßŸÑŸÜŸáÿßÿ¶Ÿäÿ© ŸàÿßŸÑÿ•ÿ∂ÿßÿ°ÿ©...",
                status_success: "ÿ™ŸÖÿ™ ÿßŸÑÿπŸÖŸÑŸäÿ© ÿ®ŸÜÿ¨ÿßÿ≠! ‚úÖ",
                res_ready: "‚úÖ ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ© ÿ¨ÿßŸáÿ≤ÿ©!",
                res_download: "‚¨áÔ∏è ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ÿ¨ŸàÿØÿ© ÿπÿßŸÑŸäÿ©",
                res_new: "üîÑ ÿ•ŸÜÿ¥ÿßÿ° ÿ¨ÿØŸäÿØ",
                gen_ratio: "ŸÖŸÇÿßÿ≥",
                ratio_square: "ŸÖÿ±ÿ®ÿπ (1:1)",
                ratio_portrait: "ÿ∑ŸàŸÑŸä (9:16)",
                ratio_landscape: "ÿπÿ±ÿ∂Ÿä (16:9)",
                status_completed: "ŸÖŸÉÿ™ŸÖŸÑ",
                status_processing: "ŸÇŸäÿØ ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ©",
                status_failed: "ŸÅÿ¥ŸÑ",
                warn_hardware_title: "‚ö†Ô∏è ÿ™ŸÜÿ®ŸäŸá: ÿ£ÿØÿßÿ° ÿßŸÑÿ¨Ÿáÿßÿ≤",
                warn_hardware_desc: "Ÿáÿ∞Ÿá ÿßŸÑÿ£ÿØÿßÿ© ÿ™ŸÇŸàŸÖ ÿ®ŸÖÿπÿßŸÑÿ¨ÿ© ŸàŸÖŸÉÿ≥ÿßÿ¨ ÿßŸÑÿµŸàÿ™ ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä ÿØÿßÿÆŸÑ ŸÖÿ™ÿµŸÅÿ≠ŸÉ ŸÖÿ®ÿßÿ¥ÿ±ÿ©.\nŸÑÿ∂ŸÖÿßŸÜ ÿ£ŸÅÿ∂ŸÑ ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨ Ÿàÿ™ÿ¨ŸÜÿ® ÿ™ÿπŸÑŸäŸÇ ÿßŸÑÿ¨Ÿáÿßÿ≤ÿå Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿ¨Ÿáÿßÿ≤ ŸÉŸÖÿ®ŸäŸàÿ™ÿ± ŸÇŸàŸä (ŸäŸÅÿ∂ŸÑ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖŸá ÿπŸÑŸâ PC ÿ£Ÿà ŸÑÿßÿ®ÿ™Ÿàÿ® ÿ≠ÿØŸäÿ´)ÿå ŸàÿßŸÑÿ±ÿ¨ÿßÿ° ÿπÿØŸÖ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ¨Ÿáÿßÿ≤ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿπŸÖŸÑŸäÿ©.",
                warn_btn_cancel: "ÿ•ŸÑÿ∫ÿßÿ° ŸàÿßŸÑÿπŸàÿØÿ©",
                warn_btn_agree: "ŸÖŸàÿßŸÅŸÇÿå ÿßÿ≥ÿ™ŸÖÿ±ÿßÿ±",
                btn_back: "ÿ±ÿ¨Ÿàÿπ",
                mobile_block_msg: "ÿπÿ∞ÿ±ÿßŸãÿå Ÿáÿ∞Ÿá ÿßŸÑÿ£ÿØÿßÿ© ÿ™ÿ™ÿ∑ŸÑÿ® ÿ¥ÿßÿ¥ÿ© ŸÉÿ®Ÿäÿ±ÿ© ŸàŸÇÿØÿ±ÿ© ŸÖÿπÿßŸÑÿ¨ÿ© ÿπÿßŸÑŸäÿ©ÿå Ÿäÿ±ÿ¨Ÿâ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÖÿ™ÿµŸÅÿ≠ ÿßŸÑŸÉŸÖÿ®ŸäŸàÿ™ÿ±.",
                mobile_block_img_msg: "ÿπÿ∞ÿ±ÿßŸãÿå ÿ£ÿØÿßÿ© ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿµŸàÿ± ÿ™ÿ™ÿ∑ŸÑÿ® ÿ¥ÿßÿ¥ÿ© ÿ£ŸÉÿ®ÿ± ŸÑÿ™ÿ¨ÿ±ÿ®ÿ© ÿ£ŸÅÿ∂ŸÑÿå Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÖŸÜ ÿ¨Ÿáÿßÿ≤ ŸÉŸÖÿ®ŸäŸàÿ™ÿ±.",
                welcome_back: "ÿ£ŸáŸÑÿßŸã ÿ®ŸÉ ŸÖÿ¨ÿØÿØÿßŸãÿå",
                dashboard_desc: "ÿ¨ÿßŸáÿ≤ ŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿ£ÿØŸàÿßÿ™ ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä ÿßŸÑŸäŸàŸÖÿü ŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿ®ÿØÿ° ŸÅŸàÿ±ÿßŸã ŸÖŸÜ ŸÇÿ≥ŸÖ ÿ£ÿØŸàÿßÿ™ŸÜÿß",
                dashboard_go: "ÿßÿ∞Ÿáÿ® ÿ•ŸÑŸâ ÿ£ÿØŸàÿßÿ™ŸÜÿß",
                pricing_offers: "ÿßŸÑÿ®ÿßŸÇÿßÿ™ ŸàÿßŸÑÿπÿ±Ÿàÿ∂",
                btn_download_wav: "ŸÜÿ≥ÿÆÿ© WAV",
                gen_select_model: "ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸàÿØŸäŸÑ:",
                gen_select_ratio: "ÿ£ÿ®ÿπÿßÿØ ÿßŸÑÿµŸàÿ±ÿ©:",
                gen_credits_cost: "ÿ™ŸÉŸÑŸÅÿ© ÿßŸÑÿ•ŸÜÿ¥ÿßÿ°:",
                gen_btn_submit: "ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ™ÿµŸÖŸäŸÖ ÿßŸÑÿ¢ŸÜ",
                gen_btn_drawing: "ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ±ÿ≥ŸÖ...",
                email_placeholder: "ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä",
                password_placeholder: "ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±",
                name_placeholder: "ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ",
                tools_montage: "üé¨ ŸÖŸàŸÜÿ™ÿßÿ¨ ÿßŸÑŸÇÿµÿßÿ¶ÿØ",
                tools_montage_desc: "ÿ≠ŸàŸëŸÑ ŸÖŸÑŸÅÿßÿ™ŸÉ ÿßŸÑÿµŸàÿ™Ÿäÿ© ÿ•ŸÑŸâ ŸÅŸäÿØŸäŸà ÿßÿ≠ÿ™ÿ±ÿßŸÅŸä ŸÖÿπ ÿ™ÿ≠ÿ±ŸäŸÉ ÿßŸÑŸÉŸÑŸÖÿßÿ™ ÿ¢ŸÑŸäÿßŸã Ÿàÿ™ÿ£ÿ´Ÿäÿ±ÿßÿ™ ÿ≥ŸäŸÜŸÖÿßÿ¶Ÿäÿ©.",
                tools_srt: "üìú ÿ™ÿ±ÿ¨ŸÖÿ© SRT",
                tools_srt_desc: "ÿ™ÿ±ÿ¨ŸÖÿ© ÿßŸÑŸÇÿµÿßÿ¶ÿØ ŸàÿßŸÑŸÑÿ∑ŸÖŸäÿßÿ™ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã Ÿàÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ŸÖŸÑŸÅÿßÿ™ ÿ™ÿ±ÿ¨ŸÖÿ© ÿßÿ≠ÿ™ÿ±ÿßŸÅŸäÿ© SRT ŸÖÿ™ÿ≤ÿßŸÖŸÜÿ©.",
                tools_featured: "ÿ£ÿØÿßÿ© ŸÖŸÖŸäÿ≤ÿ©",
                tools_mix: "ŸÖŸÉÿ≥ÿßÿ¨ Ÿàÿπÿ≤ŸÑ ÿßŸÑÿµŸàÿ™",
                tools_mix_desc: "ŸÜÿ∏ÿßŸÖ ÿßÿ≠ÿ™ÿ±ÿßŸÅŸä ŸÑŸÖŸÉÿ≥ÿßÿ¨ ÿßŸÑŸÇÿµÿßÿ¶ÿØ ŸÖÿπ ÿßŸÑÿπÿ≤ÿßÿ° ÿ£Ÿà ÿßŸÑŸÑÿ∑ŸÖŸäÿ© ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÖÿ≠ÿßŸÉÿßÿ© Ÿàÿ™ÿ£ÿ´Ÿäÿ±ÿßÿ™ Adobe Audition.",
                mix_smart_title: "ŸÖÿ±ŸÉÿ≤ ÿßŸÑŸÖŸÉÿ≥ÿßÿ¨ ÿßŸÑÿ∞ŸÉŸä",
                mix_internal_title: "ŸÖŸÉÿ≥ÿßÿ¨ ŸÖÿπ ÿπÿ≤ÿßÿ° (ÿØÿßÿÆŸÑŸä)",
                mix_internal_desc: "ÿØŸÖÿ¨ ÿßŸÑÿ±ÿßÿØŸàÿØ ŸÖÿπ ÿµŸàÿ™ ÿßŸÑŸÖÿπÿ≤ŸäŸÜ ÿØÿßÿÆŸÑ ÿßŸÑŸÖÿ£ÿ™ŸÖ ŸÖÿπ ÿ™ÿ£ÿ´Ÿäÿ±ÿßÿ™ ÿßŸÑÿµÿØŸâ ÿßŸÑÿ∑ÿ®ŸäÿπŸäÿ©.",
                mix_external_title: "ŸÖŸÉÿ≥ÿßÿ¨ ŸÖÿπ ŸÑÿ∑ŸÖŸäÿ© (ÿ≥ÿ™ŸàÿØŸäŸà)",
                mix_external_desc: "ÿØŸÖÿ¨ ÿßŸÑÿ±ÿßÿØŸàÿØ ŸÖÿπ ÿ™ÿ±ÿßŸÉ ŸÑÿ∑ŸÖŸäÿ© ÿÆÿßÿ±ÿ¨Ÿä ÿ£Ÿà ÿ•ŸäŸÇÿßÿπÿßÿ™ ÿ≥ÿ™ŸàÿØŸäŸà ÿßÿ≠ÿ™ÿ±ÿßŸÅŸäÿ©.",
                mix_upload_title: "ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑÿµŸàÿ™Ÿäÿ©",
                mix_track_reciter: "ÿµŸàÿ™ ÿßŸÑÿ±ÿßÿØŸàÿØ (Dry)",
                mix_track_mourners_list: "ÿ£ÿµŸàÿßÿ™ ÿßŸÑŸÖÿπÿ≤ŸäŸÜ (ÿßŸÑÿ¨ŸÖŸáŸàÿ±)",
                mix_track_latma_list: "ÿ™ÿ±ÿßŸÉÿßÿ™ ÿßŸÑŸÑÿ∑ŸÖŸäÿ©",
                mix_btn_add: "ÿ£ÿ∂ŸÅ ÿ™ÿ±ÿßŸÉ ÿ•ÿ∂ÿßŸÅŸä",
                mix_btn_start_now: "ÿßÿ®ÿØÿ£ ÿßŸÑŸÖŸÉÿ≥ÿßÿ¨ ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿä",
                mix_settings_title: "ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸáŸÜÿØÿ≥ÿ© ÿßŸÑÿµŸàÿ™Ÿäÿ©",
                mix_project_type: "ŸÜŸàÿπ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ:",
                mix_change_type: "ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸÜŸàÿπ",
                mix_applied_filters: "ÿßŸÑŸÅŸÑÿßÿ™ÿ± ÿßŸÑŸÖÿ∑ÿ®ŸÇÿ© ÿ¢ŸÑŸäÿßŸã:",
                mix_filter_reverb: "Reverb (Hussaini Hall)",
                mix_filter_echo: "Multi-Tap Delay",
                mix_filter_limiter: "Hard Limiter (-0.1dB)",
                mix_filter_stereo: "Stereo Imaging",
                mix_cost: "ÿ™ŸÉŸÑŸÅÿ© ÿßŸÑÿπŸÖŸÑŸäÿ©",
                mix_success_msg: "ÿ™ŸÖ ÿßŸÑŸÖŸÉÿ≥ÿßÿ¨ ÿ®ŸÜÿ¨ÿßÿ≠!",
                mix_ready_msg: "ŸÖŸÑŸÅÿßÿ™ŸÉ ÿ¨ÿßŸáÿ≤ÿ© ŸÑŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿ®ÿßŸÑÿØŸÇÿ© ÿßŸÑŸÉÿßŸÖŸÑÿ©.",
                mix_btn_new: "ŸÖŸÉÿ≥ÿßÿ¨ ÿ¨ÿØŸäÿØ"
            },
            en: {
                nav_home: "Home",
                nav_pricing: "Pricing",
                nav_tools: "Tools",
                nav_who: "About Us",
                nav_login: "Login",
                nav_profile: "Profile",
                nav_history: "History",
                nav_logout: "Logout",
                hero_title: "AI Studio",
                hero_desc: "Professional Audio Mixing ‚Ä¢ AI Image Generation ‚Ä¢ Pro Content Production\nEverything you need in one place",
                hero_btn_reg: "Sign Up",
                hero_btn_login: "Login",
                hero_btn_pricing: "Pricing",
                pricing_title: "Credit Packages",
                tools_img: "AI Image Studio",
                tools_img_desc: "Create artistic designs with professional AI",
                btn_start: "Start Now",
                credits: "Credits",
                welcome: "Welcome",
                your_tools: "Our Integrated Smart Tools",
                balance: "Balance",
                upgrade: "Top Up",
                gen_title: "AI Image Studio",
                gen_desc: "Turn your ideas into stunning art in seconds",
                gen_placeholder: "Describe your image in detail (English or Arabic)...",
                gen_btn: "Generate Image",
                gen_upload: "Upload Reference (Optional)",
                hist_title: "Process History",
                hist_empty: "No history found",
                login_title: "Login",
                login_google: "Login with Google",
                login_or: "Or via Email",
                login_btn: "Login",
                login_no_account: "New here?",
                login_create: "Create Account",
                reg_title: "Create Account",
                reg_google: "Register with Google",
                reg_btn: "Sign Up & Start",
                reg_have_account: "Have an account?",
                status_reading: "Reading prompt...",
                status_translating: "Translating...",
                status_drawing: "Drawing...",
                status_details: "Adding details...",
                status_coloring: "Coloring...",
                status_lighting: "Applying lights...",
                status_success: "Success! ‚úÖ",
                res_ready: "‚úÖ Result Ready!",
                res_download: "‚¨áÔ∏è High Res Download",
                res_new: "üîÑ New Creation",
                gen_ratio: "Size",
                ratio_square: "Square (1:1)",
                ratio_portrait: "Portrait (9:16)",
                ratio_landscape: "Landscape (16:9)",
                status_completed: "Completed",
                status_processing: "Processing",
                status_failed: "Failed",
                warn_hardware_title: "‚ö†Ô∏è Warning: Performance",
                warn_hardware_desc: "This tool uses AI to mix audio directly in your browser.\nFor best results, use a modern computer/laptop, and please do not use the device during the process.",
                warn_btn_cancel: "Cancel",
                warn_btn_agree: "Agree & Continue",
                btn_back: "Back",
                mobile_block_msg: "Desktop required for this tool.",
                mobile_block_img_msg: "Desktop required for Image Studio.",
                welcome_back: "Welcome back,",
                dashboard_desc: "Ready to use AI tools today? Start now from our console.",
                tools_mix: "Audio Mixing & Isolation",
                tools_mix_desc: "Professional system for mixing poems with mourners or latmiya using Adobe Audition effects simulation.",
                tools_ads: "Ad Generator",
                tools_ads_desc: "Create professional posters for events, births, and mourning with AI.",
                tools_montage: "Poem Montage",
                tools_montage_desc: "Turn your audio into professional video with auto lyrics and cinematic effects.",
                tools_srt: "SRT Sync",
                tools_srt_desc: "Auto sync poetry text with audio to generate professional SRT files.",
                tools_featured: "Featured Tool",
                mix_smart_title: "Smart Mixing Center",
                mix_internal_title: "Internal Mix (Mourners)",
                mix_internal_desc: "Merge reciter with audience voices inside the hall with natural reverb.",
                mix_external_title: "External Mix (Studio)",
                mix_external_desc: "Merge reciter with external latmiya tracks or professional studio beats.",
                mix_upload_title: "Upload Audio Files",
                mix_track_reciter: "Reciter Vocal (Dry)",
                mix_track_mourners_list: "Mourner Tracks (Audience)",
                mix_track_latma_list: "Latmiya Tracks",
                mix_btn_add: "Add Extra Track",
                mix_btn_start_now: "Start Cloud Mix",
                mix_settings_title: "Audio Engineering Settings",
                mix_project_type: "Project Type:",
                mix_change_type: "Change Type",
                mix_applied_filters: "Auto Applied Filters:",
                mix_filter_reverb: "Reverb (Hussaini Hall)",
                mix_filter_echo: "Multi-Tap Delay",
                mix_filter_limiter: "Hard Limiter (-0.1dB)",
                mix_filter_stereo: "Stereo Imaging",
                mix_cost: "Process Cost",
                mix_success_msg: "Mixed Successfully!",
                mix_ready_msg: "Your files are ready for high-quality download.",
                mix_btn_new: "New Mix",
                dashboard_go: "Go to Console",
                pricing_offers: "Pricing & Packs",
                btn_download_wav: "WAV Version",
                gen_select_model: "Select Model:",
                gen_select_ratio: "Aspect Ratio:",
                gen_credits_cost: "Creation Cost:",
                gen_btn_submit: "Generate Design Now",
                gen_btn_drawing: "Drawing...",
                email_placeholder: "Email Address",
                password_placeholder: "Password",
                name_placeholder: "Full Name",
                tools_montage: "üé¨ Poem Montage",
                tools_montage_desc: "Turn your audio into professional videos with animated lyrics and cinematic effects.",
                tools_srt: "üìú SRT Translation",
                tools_srt_desc: "Auto-translate poems and generate professionally synced SRT subtitile files.",
                tools_featured: "Featured Tool"
            }
        };

        // --- Auth Context ---
        const AuthContext = createContext();

        function AuthProvider({ children }) {
            const [user, setUser] = useState(() => {
                const saved = safeStorage.getItem('aza_user');
                try { return saved ? JSON.parse(saved) : null; } catch (e) { return null; }
            });
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(async (firebaseUser) => {
                    if (firebaseUser) {
                        try {
                            const docRef = db.collection('users').doc(firebaseUser.uid);
                            const doc = await docRef.get();
                            let userData = {
                                id: firebaseUser.uid,
                                email: firebaseUser.email,
                                name: firebaseUser.displayName || 'ŸÖÿ¥ÿ™ÿ±ŸÉ',
                                photo: firebaseUser.photoURL || null,
                                credits: 12,
                                history: [],
                                joinedAt: new Date().toISOString()
                            };
                            if (doc.exists) {
                                userData = { ...userData, ...doc.data() };
                            } else {
                                await docRef.set(userData);
                            }
                            setUser(userData);
                            safeStorage.setItem('aza_user', JSON.stringify(userData));
                        } catch (err) {
                            console.error("Auth sync error (Firestore):", err);
                            // Critical Fallback: Use Firebase Auth info even if Firestore fails
                            const fallbackData = {
                                id: firebaseUser.uid,
                                email: firebaseUser.email,
                                name: firebaseUser.displayName || 'ŸÖÿ¥ÿ™ÿ±ŸÉ',
                                photo: firebaseUser.photoURL || null,
                                credits: 12, // Default credits
                                history: [],
                                isDefault: true
                            };
                            setUser(fallbackData);
                            safeStorage.setItem('aza_user', JSON.stringify(fallbackData));
                        }
                    } else {
                        const saved = safeStorage.getItem('aza_user');
                        if (saved) {
                            try {
                                const parsed = JSON.parse(saved);
                                if (parsed && parsed.id) setUser(parsed);
                                else { setUser(null); safeStorage.removeItem('aza_user'); }
                            } catch (e) { setUser(null); safeStorage.removeItem('aza_user'); }
                        } else {
                            const currentHash = window.location.hash;
                            const protectedRoutes = ['dashboard', 'image-gen', 'mix', 'profile', 'history'];
                            const isProtected = protectedRoutes.some(r => currentHash.includes(r));
                            if (window.location.protocol === 'file:' && isProtected) {
                                const mockUser = { id: 'auto-mock-' + Date.now(), name: 'ÿ≤ÿßÿ¶ÿ± ŸÖÿ§ŸÇÿ™', credits: 12, history: [] };
                                setUser(mockUser);
                            } else {
                                setUser(null);
                            }
                        }
                    }
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            const login = async (email, password) => {
                setLoading(true);
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                    setLoading(false);
                } catch (error) {
                    const mockUser = { id: 'mock-' + Date.now(), email, name: email.split('@')[0], credits: 12, history: [] };
                    setUser(mockUser);
                    safeStorage.setItem('aza_user', JSON.stringify(mockUser));
                    setLoading(false);
                }
            };

            const loginWithGoogle = async () => {
                setLoading(true);

                // Keep mock user ONLY for 'file:' protocol as OAuth requires a web server
                if (window.location.protocol === 'file:') {
                    await new Promise(r => setTimeout(r, 800));
                    const mockUser = {
                        id: 'google-sim-' + Date.now(),
                        email: 'user@example.com',
                        name: 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ™ÿ¨ÿ±Ÿäÿ®Ÿä (ŸÇÿ±ÿßÿ°ÿ© ŸÖŸÑŸÅ)',
                        photo: 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png',
                        credits: 12,
                        history: [],
                        joinedAt: new Date().toISOString()
                    };
                    setUser(mockUser);
                    safeStorage.setItem('aza_user', JSON.stringify(mockUser));
                    setLoading(false);
                    return true;
                }

                try {
                    if (typeof firebase === 'undefined') throw new Error('Firebase library not loaded');
                    const provider = new firebase.auth.GoogleAuthProvider();

                    // Force the account selection screen
                    provider.setCustomParameters({
                        prompt: 'select_account'
                    });

                    const isMobileAuth = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

                    if (isMobileAuth) {
                        return await auth.signInWithRedirect(provider);
                    } else {
                        const result = await auth.signInWithPopup(provider);
                        if (result.user) return true;
                    }
                } catch (error) {
                    console.error("Official Google Auth Error:", error);
                    alert("ŸÅÿ¥ŸÑ ŸÅŸä ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿßŸÑÿ±ÿ≥ŸÖŸä. ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ™ŸáŸäÿ¶ÿ© Firebase Auth ŸàŸÜÿ∑ÿßŸÇÿßÿ™ ÿßŸÑŸàÿµŸàŸÑ ÿßŸÑŸÖÿ≥ŸÖŸàÿ≠ ÿ®Ÿáÿß.");
                    setLoading(false);
                    return false;
                }
            };

            const register = async (name, email, password) => {
                setLoading(true);
                try {
                    const res = await auth.createUserWithEmailAndPassword(email, password);
                    await res.user.updateProfile({ displayName: name });
                    setLoading(false);
                } catch (e) {
                    const mockUser = { id: 'mock-' + Date.now(), email, name, credits: 12, history: [] };
                    setUser(mockUser);
                    safeStorage.setItem('aza_user', JSON.stringify(mockUser));
                    setLoading(false);
                }
            };

            const logout = async () => {
                await auth.signOut();
                setUser(null);
                safeStorage.removeItem('aza_user');
            };

            const deductCredits = async (amount) => {
                let currentCredits = 0;
                let userId = null;
                let isMock = false;

                setUser(prev => {
                    if (!prev) return null;
                    currentCredits = prev.credits || 0;
                    userId = prev.id;
                    isMock = prev.id.includes('mock') || prev.id.includes('sim');
                    return prev;
                });

                if (currentCredits < amount) return false;

                const newCredits = currentCredits - amount;
                setUser(prev => {
                    if (!prev) return null;
                    const updated = { ...prev, credits: newCredits };
                    safeStorage.setItem('aza_user', JSON.stringify(updated));
                    return updated;
                });

                if (!isMock && userId) {
                    try { await db.collection('users').doc(userId).update({ credits: firebase.firestore.FieldValue.increment(-amount) }); } catch (e) { console.error("Firestore deduct fail", e); }
                }
                return true;
            };

            const addCredits = async (amount) => {
                let userId = null;
                let isMock = false;
                setUser(prev => {
                    if (!prev) return null;
                    userId = prev.id;
                    isMock = prev.id.includes('mock') || prev.id.includes('sim');
                    const updated = { ...prev, credits: (prev.credits || 0) + amount };
                    safeStorage.setItem('aza_user', JSON.stringify(updated));
                    return updated;
                });
                if (!isMock && userId) {
                    try { await db.collection('users').doc(userId).update({ credits: firebase.firestore.FieldValue.increment(amount) }); } catch (e) { }
                }
                return true;
            };

            const addHistoryItem = async (item) => {
                let userId = null;
                let isMock = false;
                setUser(prev => {
                    if (!prev) return null;
                    userId = prev.id;
                    isMock = prev.id.includes('mock') || prev.id.includes('sim');
                    const updated = { ...prev, history: [...(prev.history || []), item] };
                    safeStorage.setItem('aza_user', JSON.stringify(updated));
                    return updated;
                });
                if (!isMock && userId) {
                    try { await db.collection('users').doc(userId).update({ history: firebase.firestore.FieldValue.arrayUnion(item) }); } catch (e) { }
                }
            };

            const [lang, _setLang] = useState(() => safeStorage.getItem('aza_lang') || 'ar');
            const [isBlurring, setIsBlurring] = useState(false);

            const setLang = (newLang) => {
                setIsBlurring(true);
                setTimeout(() => {
                    _setLang(newLang);
                    safeStorage.setItem('aza_lang', newLang);
                    setIsBlurring(false);
                }, 400);
            };

            const t = (key) => translations[lang][key] || key;

            return (
                <AuthContext.Provider value={{ user, login, loginWithGoogle, register, logout, deductCredits, addCredits, addHistoryItem, loading, lang, setLang, t, isBlurring }}>
                    {children}
                </AuthContext.Provider>
            );
        }

        const useAuth = () => useContext(AuthContext);

        function BackButton() {
            const { t, lang } = useAuth();
            const { push } = useRouter();
            return (
                <button
                    onClick={() => window.history.length > 1 ? window.history.back() : push('/dashboard')}
                    className="btn btn-outline"
                    style={{
                        marginBottom: '20px',
                        padding: '8px 15px',
                        fontSize: '0.9rem',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px',
                        color: 'var(--text-secondary)',
                        borderColor: 'var(--border)'
                    }}
                >
                    ‚¨ÖÔ∏è {t('btn_back')}
                </button>
            );
        }

        // --- COMPONENTS ---

        function Navbar() {
            const { user, logout, lang, setLang, t } = useAuth();
            const { push } = useRouter();
            const [showMenu, setShowMenu] = useState(false);
            const menuRef = useRef(null);

            // Close menu when clicking outside
            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (menuRef.current && !menuRef.current.contains(event.target)) {
                        setShowMenu(false);
                    }
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);

            return (
                <nav className="navbar" dir={lang === 'ar' ? 'rtl' : 'ltr'}>
                    <div className="container nav-content">
                        {/* Logo and Lang on the left */}
                        <div style={{ display: 'flex', alignItems: 'center', flex: 1, gap: '20px' }}>
                            <a onClick={() => { push('/'); window.open('https://linktr.ee/menbaar', '_blank'); }} style={{ display: 'flex', alignItems: 'center', cursor: 'pointer' }}>
                                <img src="https://raw.githubusercontent.com/banijamrahclub/hlb./db2b446391b0fb1da6f775be88a07b8308d6177d/%D9%84%D9%88%D8%AC%D9%88%20%D8%A8%D8%AF%D9%88%D9%86%20%D8%AE%D9%84%D9%81%D9%8A%D8%A9.png" alt="Minbar Logo" style={{ height: '90px', objectFit: 'contain' }} />
                            </a>
                            <button
                                onClick={() => setLang(lang === 'ar' ? 'en' : 'ar')}
                                style={{
                                    background: 'rgba(255,255,255,0.05)',
                                    border: '1px solid var(--border)',
                                    color: 'var(--text-secondary)',
                                    cursor: 'pointer',
                                    fontSize: '0.75rem',
                                    fontWeight: 'bold',
                                    padding: '4px 10px',
                                    borderRadius: '15px',
                                    transition: '0.3s'
                                }}
                                onMouseOver={e => { e.currentTarget.style.color = 'var(--primary)'; e.currentTarget.style.borderColor = 'var(--primary)'; }}
                                onMouseOut={e => { e.currentTarget.style.color = 'var(--text-secondary)'; e.currentTarget.style.borderColor = 'var(--border)'; }}
                            >
                                {lang === 'ar' ? 'EN' : 'AR'}
                            </button>
                        </div>

                        {/* Navigation links centered */}
                        <div style={{ display: 'flex', gap: '25px', alignItems: 'center', flex: 1.5, justifyContent: 'center' }}>
                            <a onClick={() => push('/')} className="nav-link" style={{ fontSize: '1rem', cursor: 'pointer' }}>{t('nav_home')}</a>
                            <a onClick={() => push('/pricing')} className="nav-link" style={{ fontSize: '1rem', cursor: 'pointer' }}>{t('nav_pricing')}</a>
                            {user && <a onClick={() => push('/dashboard')} className="nav-link" style={{ fontSize: '1rem', cursor: 'pointer' }}>{t('nav_tools')}</a>}
                        </div>

                        {/* User actions on the right */}
                        <div style={{ display: 'flex', gap: '20px', alignItems: 'center', flex: 1, justifyContent: 'flex-end' }}>
                            {user ? (
                                <div style={{ display: 'flex', gap: '12px', alignItems: 'center', position: 'relative' }}>
                                    <div className="badge">{user.credits} {t('credits')}</div>
                                    <div ref={menuRef} style={{ position: 'relative' }}>
                                        <button onClick={() => setShowMenu(!showMenu)} style={{ background: 'var(--surface-hover)', border: '1px solid var(--border)', cursor: 'pointer', fontSize: '1.2rem', padding: '8px', borderRadius: '50%', color: 'var(--primary)', display: 'flex', alignItems: 'center', justifyContent: 'center', width: '40px', height: '40px' }}>
                                            üë§
                                        </button>

                                        {showMenu && (
                                            <div className="card animate-fade-in" style={{
                                                position: 'absolute',
                                                top: '120%',
                                                [lang === 'ar' ? 'left' : 'right']: 0,
                                                minWidth: '220px',
                                                zIndex: 1000,
                                                padding: '10px',
                                                borderRadius: '12px',
                                                boxShadow: '0 10px 40px rgba(0,0,0,0.5)',
                                                background: 'var(--surface)',
                                                border: '1px solid var(--border)',
                                                textAlign: 'right'
                                            }}>
                                                <div style={{ padding: '10px', fontSize: '0.9rem', color: 'var(--text-primary)', borderBottom: '1px solid var(--border)', marginBottom: '5px', fontWeight: 'bold' }}>
                                                    {user.name}
                                                </div>
                                                <button onClick={() => { push('/profile'); setShowMenu(false); }} className="btn-ghost" style={{ display: 'flex', width: '100%', padding: '12px', alignItems: 'center', gap: '12px', color: 'var(--text-secondary)', transition: 'background 0.2s', borderRadius: '8px' }} onMouseOver={e => e.currentTarget.style.background = 'var(--surface-hover)'} onMouseOut={e => e.currentTarget.style.background = 'transparent'}>
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                                                    {t('nav_profile')}
                                                </button>
                                                <button onClick={() => { push('/history'); setShowMenu(false); }} className="btn-ghost" style={{ display: 'flex', width: '100%', padding: '12px', alignItems: 'center', gap: '12px', color: 'var(--text-secondary)', transition: 'background 0.2s', borderRadius: '8px' }} onMouseOver={e => e.currentTarget.style.background = 'var(--surface-hover)'} onMouseOut={e => e.currentTarget.style.background = 'transparent'}>
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                                                    {t('nav_history')}
                                                </button>
                                                <div style={{ borderTop: '1px solid var(--border)', marginTop: '5px', paddingTop: '5px' }}>
                                                    <button onClick={() => { logout(); push('/'); setShowMenu(false); }} className="btn-ghost" style={{ display: 'flex', width: '100%', padding: '10px', alignItems: 'center', gap: '10px', color: 'var(--error)' }}>üö™ {t('nav_logout')}</button>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            ) : (
                                <button onClick={() => push('/login')} className="btn btn-primary" style={{ padding: '8px 25px', fontSize: '0.9rem' }}>{t('nav_login')}</button>
                            )}
                        </div>
                    </div>
                </nav>
            );
        }

        // --- PAGES ---

        function HomePage() {
            const { push } = useRouter();
            const { user, t } = useAuth();

            if (user) {
                return (
                    <div className="animate-fade-in" style={{ padding: '100px 20px', textAlign: 'center' }}>
                        <div className="container">
                            <h1 className="glow-text">{t('welcome_back')} <span style={{ color: 'var(--primary)' }}>{user.name}</span></h1>
                            <p style={{ fontSize: '1.2rem', marginBottom: '40px' }}>{t('dashboard_desc')}</p>
                            <div style={{ display: 'flex', gap: '20px', justifyContent: 'center', flexWrap: 'wrap' }}>
                                <button onClick={() => push('/dashboard')} className="btn btn-primary" style={{ padding: '15px 50px' }}>{t('dashboard_go')}</button>
                                <button onClick={() => push('/pricing')} className="btn btn-outline" style={{ padding: '15px 50px' }}>{t('pricing_offers')}</button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="animate-fade-in">
                    <section className="hero" style={{ minHeight: 'calc(100vh - 80px)', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                        <div className="container" style={{ textAlign: 'center', display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '20px' }}>
                            <img src="https://raw.githubusercontent.com/banijamrahclub/hlb./db2b446391b0fb1da6f775be88a07b8308d6177d/%D9%84%D9%88%D8%AC%D9%88%20%D8%A8%D8%AF%D9%88%D9%86%20%D8%AE%D9%84%D9%81%D9%8A%D8%A9.png" alt="Minbar" style={{ maxWidth: '280px', marginBottom: '0' }} />

                            <h1 className="glow-text">{t('hero_title')}</h1>

                            <div style={{ display: 'flex', gap: '15px', justifyContent: 'center', flexWrap: 'wrap', marginTop: '10px' }}>
                                <button onClick={() => push('/register')} className="btn btn-primary" style={{ padding: '12px 40px', fontSize: '1.1rem', minWidth: '160px' }}>{t('hero_btn_reg')}</button>
                                <button onClick={() => push('/pricing')} className="btn btn-outline" style={{ padding: '12px 40px', fontSize: '1.1rem', minWidth: '160px' }}>{t('hero_btn_pricing')}</button>
                            </div>

                            <p style={{ fontSize: '0.95rem', maxWidth: '500px', margin: '10px auto 0', lineHeight: '1.6', color: 'var(--text-secondary)', opacity: 0.8, whiteSpace: 'pre-line' }}>
                                {t('hero_desc')}
                            </p>
                        </div>
                    </section>
                </div>
            );
        }

        function LoginPage() {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const { login, loginWithGoogle, loading, t } = useAuth();
            const { push } = useRouter();

            const handleSubmit = async (e) => {
                e.preventDefault();
                await login(email, password);
                push('/');
            };

            const handleGoogle = async () => {
                await loginWithGoogle();
                push('/');
            };

            return (
                <div className="container animate-fade-in" style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', minHeight: '80vh' }}>
                    <div className="card" style={{ width: '100%', maxWidth: '400px' }}>
                        <h2 style={{ textAlign: 'center', marginBottom: '24px' }}>{t('login_title')}</h2>
                        <button onClick={handleGoogle} className="btn btn-outline" style={{ width: '100%', marginBottom: '20px', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '10px' }}>
                            <svg width="20" height="20" viewBox="0 0 24 24"><path fill="currentColor" d="M21.35 11.1h-9.17v2.73h5.51c-.33 1.55-1.54 2.74-3.17 2.74a3.69 3.69 0 0 1-3.69-3.69c0-2.04 1.65-3.69 3.69-3.69c.9 0 1.7.32 2.33.91l2.05-2.05A6.5 6.5 0 0 0 12.18 5c-3.86 0-7 3.14-7 7s3.14 7 7 7c3.5 0 6.6-2.54 6.6-7c0-.52-.05-1.03-.13-1.52z" /></svg>
                            {t('login_google')}
                        </button>
                        <form onSubmit={handleSubmit}>
                            <input type="email" placeholder={t('email_placeholder')} className="input-field" value={email} onChange={(e) => setEmail(e.target.value)} required />
                            <input type="password" placeholder={t('password_placeholder')} className="input-field" value={password} onChange={(e) => setPassword(e.target.value)} required />
                            <button type="submit" className="btn btn-primary" style={{ width: '100%' }} disabled={loading}>{loading ? '...' : t('login_btn')}</button>
                        </form>
                        <div style={{ marginTop: '20px', textAlign: 'center' }}>
                            <p>{t('login_no_account')} <a onClick={() => push('/register')} style={{ color: 'var(--primary)', cursor: 'pointer' }}>{t('login_create')}</a></p>
                        </div>
                    </div>
                </div>
            );
        }

        function RegisterPage() {
            const [name, setName] = useState('');
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const { register, loginWithGoogle, loading, t } = useAuth();
            const { push } = useRouter();

            const handleSubmit = async (e) => {
                e.preventDefault();
                await register(name, email, password);
                push('/');
            };

            const handleGoogle = async () => {
                await loginWithGoogle();
                push('/');
            };

            return (
                <div className="container animate-fade-in" style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', minHeight: '80vh' }}>
                    <div className="card" style={{ width: '100%', maxWidth: '400px' }}>
                        <h2 style={{ textAlign: 'center', marginBottom: '24px' }}>{t('reg_title')}</h2>

                        <button onClick={handleGoogle} className="btn btn-outline" style={{ width: '100%', marginBottom: '24px', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '10px' }}>
                            <svg width="20" height="20" viewBox="0 0 24 24"><path fill="currentColor" d="M21.35 11.1h-9.17v2.73h5.51c-.33 1.55-1.54 2.74-3.17 2.74a3.69 3.69 0 0 1-3.69-3.69c0-2.04 1.65-3.69 3.69-3.69c.9 0 1.7.32 2.33.91l2.05-2.05A6.5 6.5 0 0 0 12.18 5c-3.86 0-7 3.14-7 7s3.14 7 7 7c3.5 0 6.6-2.54 6.6-7c0-.52-.05-1.03-.13-1.52z" /></svg>
                            {t('reg_google')}
                        </button>

                        <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '20px' }}>
                            <div style={{ flex: 1, height: '1px', background: 'var(--border)' }}></div>
                            <span style={{ color: 'var(--text-secondary)', fontSize: '0.9rem' }}>{t('login_or')}</span>
                            <div style={{ flex: 1, height: '1px', background: 'var(--border)' }}></div>
                        </div>

                        <form onSubmit={handleSubmit}>
                            <input type="text" placeholder={t('name_placeholder')} className="input-field" value={name} onChange={(e) => setName(e.target.value)} required />
                            <input type="email" placeholder={t('email_placeholder')} className="input-field" value={email} onChange={(e) => setEmail(e.target.value)} required />
                            <input type="password" placeholder={t('password_placeholder')} className="input-field" value={password} onChange={(e) => setPassword(e.target.value)} required />
                            <button type="submit" className="btn btn-primary" style={{ width: '100%' }} disabled={loading}>{loading ? '...' : t('reg_btn')}</button>
                        </form>
                        <div style={{ marginTop: '20px', textAlign: 'center' }}>
                            <p>{t('reg_have_account')} <a onClick={() => push('/login')} style={{ color: 'var(--primary)', cursor: 'pointer' }}>{t('nav_login')}</a></p>
                        </div>
                    </div>
                </div>
            );
        }


        function DashboardPage() {
            const { user, loading, t } = useAuth();
            const { push } = useRouter();
            const [isMobile, setIsMobile] = useState(false);

            useEffect(() => {
                const checkMobile = () => setIsMobile(window.innerWidth <= 768);
                checkMobile();
                window.addEventListener('resize', checkMobile);
                return () => window.removeEventListener('resize', checkMobile);
            }, []);

            if (loading) return null;
            if (!user) { push('/login'); return null; }

            return (
                <div className="container animate-fade-in" style={{ padding: '40px 20px' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '40px', flexWrap: 'wrap', gap: '20px' }}>
                        <div>
                            <h1 style={{ fontSize: '2rem', marginBottom: '10px' }}>{t('welcome')}, {user.name}</h1>
                            <p>{t('your_tools')}</p>
                        </div>
                        <div className="card" style={{ display: 'flex', alignItems: 'center', gap: '20px', padding: '15px 30px' }}>
                            <div>
                                <div style={{ fontSize: '0.9rem', color: 'var(--text-secondary)' }}>{t('balance')}</div>
                                <div style={{ fontSize: '1.5rem', fontWeight: 'bold', color: 'var(--primary)' }}>{user.credits} {t('credits')}</div>
                            </div>
                            <button onClick={() => push('/pricing')} className="btn btn-outline">{t('upgrade')}</button>
                        </div>
                    </div>
                    <h2 style={{ marginBottom: '30px', textAlign: 'center' }}>{t('nav_tools')}</h2>

                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(320px, 1fr))', gap: '30px', marginBottom: '40px' }}>
                        {/* Audio Mix Card */}
                        <div className="card" onClick={() => push('/mix')} style={{ textAlign: 'center', padding: '30px', border: '2px solid var(--primary)', transition: '0.3s' }} onMouseEnter={e => e.currentTarget.style.transform = 'translateY(-5px)'} onMouseLeave={e => e.currentTarget.style.transform = 'translateY(0)'}>
                            <div style={{ width: '100%', height: '160px', overflow: 'hidden', borderRadius: '15px', marginBottom: '20px', border: '1px solid var(--border)' }}>
                                <img src="https://images.unsplash.com/photo-1598488035139-bdbb2231ce04?q=80&w=2070&auto=format&fit=crop" style={{ width: '100%', height: '100%', objectFit: 'cover' }} />
                            </div>
                            <div className="badge" style={{ marginBottom: '15px', background: 'var(--primary)', color: 'white' }}>ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ© ‚≠ê</div>
                            <h3 style={{ marginBottom: '15px', color: 'var(--primary)' }}>{t('tools_mix')}</h3>
                            <p style={{ marginBottom: '20px', color: 'var(--text-secondary)' }}>{t('tools_mix_desc')}</p>
                            <div style={{ marginBottom: '20px', fontWeight: 'bold', color: 'var(--primary)' }}>4 {t('credits')}</div>
                            <button className="btn btn-primary" style={{ width: '100%' }}>{t('btn_start')}</button>
                        </div>
                        {/* Montage Card */}
                        <div className="card" onClick={() => push('/montage')} style={{ textAlign: 'center', padding: '30px', transition: '0.3s' }} onMouseEnter={e => e.currentTarget.style.transform = 'translateY(-5px)'} onMouseLeave={e => e.currentTarget.style.transform = 'translateY(0)'}>
                            <div style={{ width: '100%', height: '160px', overflow: 'hidden', borderRadius: '15px', marginBottom: '20px', border: '1px solid var(--border)' }}>
                                <img src="https://blog.mostaql.com/wp-content/uploads/2015/05/%D8%AF%D9%84%D9%8A%D9%84%D9%83-%D8%A7%D9%84%D8%B4%D8%A7%D9%85%D9%84-%D9%84%D8%AF%D8%AE%D9%88%D9%84-%D8%B9%D8%A7%D9%84%D9%85-%D8%AA%D8%AD%D8%B1%D9%8A%D8%B1-%D8%A7%D9%84%D9%81%D9%8A%D8%AF%D9%8A%D9%88.png" style={{ width: '100%', height: '100%', objectFit: 'cover' }} />
                            </div>
                            <div className="badge" style={{ marginBottom: '15px' }}>{t('tools_featured')}</div>
                            <h3 style={{ marginBottom: '15px', color: 'var(--primary)' }}>{t('tools_montage')}</h3>
                            <p style={{ marginBottom: '20px', color: 'var(--text-secondary)' }}>{t('tools_montage_desc')}</p>
                            <div style={{ marginBottom: '20px', fontWeight: 'bold', color: 'var(--primary)' }}>8 {t('credits')}</div>
                            <button className="btn btn-primary" style={{ width: '100%' }}>{t('btn_start')}</button>
                        </div>

                        {/* Ads Gen Card */}
                        <div className="card" onClick={() => push('/ads')} style={{ textAlign: 'center', padding: '30px', border: '2px solid var(--primary)', transition: '0.3s' }} onMouseEnter={e => e.currentTarget.style.transform = 'translateY(-5px)'} onMouseLeave={e => e.currentTarget.style.transform = 'translateY(0)'}>
                            <div style={{ width: '100%', height: '160px', overflow: 'hidden', borderRadius: '15px', marginBottom: '20px', border: '1px solid var(--border)' }}>
                                <img src="https://images.unsplash.com/photo-1542744173-8e7e53415bb0?q=80&w=2000&auto=format&fit=crop" style={{ width: '100%', height: '100%', objectFit: 'cover' }} />
                            </div>
                            <div className="badge" style={{ marginBottom: '15px', background: 'var(--primary)', color: 'white' }}>ÿ¨ÿØŸäÿØ ‚ú®</div>
                            <h3 style={{ marginBottom: '15px', color: 'var(--primary)' }}>{t('tools_ads')}</h3>
                            <p style={{ marginBottom: '20px', color: 'var(--text-secondary)' }}>{t('tools_ads_desc')}</p>
                            <div style={{ marginBottom: '20px', fontWeight: 'bold', color: 'var(--primary)' }}>4 {t('credits')}</div>
                            <button className="btn btn-primary" style={{ width: '100%' }}>{t('btn_start')}</button>
                        </div>

                        {/* SRT Tool Card */}
                        <div className="card" onClick={() => push('/srt')} style={{ textAlign: 'center', padding: '30px', transition: '0.3s' }} onMouseEnter={e => e.currentTarget.style.transform = 'translateY(-5px)'} onMouseLeave={e => e.currentTarget.style.transform = 'translateY(0)'}>
                            <div style={{ width: '100%', height: '160px', overflow: 'hidden', borderRadius: '15px', marginBottom: '20px', border: '1px solid var(--border)' }}>
                                <img src="https://www.audome.io/audome-uploads/poetry-tool.png" style={{ width: '100%', height: '100%', objectFit: 'cover' }} />
                            </div>
                            <h3 style={{ marginBottom: '15px', color: 'var(--primary)' }}>{t('tools_srt')}</h3>
                            <p style={{ marginBottom: '20px', color: 'var(--text-secondary)' }}>{t('tools_srt_desc')}</p>
                            <div style={{ marginBottom: '20px', fontWeight: 'bold', color: 'var(--primary)' }}>3 {t('credits')}</div>
                            <button className="btn btn-outline" style={{ width: '100%' }}>{t('btn_start')}</button>
                        </div>

                        {/* Image Gen Card */}
                        <div className="card" onClick={() => push('/image-gen')} style={{ textAlign: 'center', padding: '30px', transition: '0.3s' }} onMouseEnter={e => e.currentTarget.style.transform = 'translateY(-5px)'} onMouseLeave={e => e.currentTarget.style.transform = 'translateY(0)'}>
                            <div style={{ width: '100%', height: '160px', overflow: 'hidden', borderRadius: '15px', marginBottom: '20px', border: '1px solid var(--border)' }}>
                                <img src="https://raw.githubusercontent.com/banijamrahclub/hlb./db2b446391b0fb1da6f775be88a07b8308d6177d/%D8%B5%D9%88%D8%B1%20%D8%A8%D8%A7%D9%84%D8%B0%D9%83%D8%A7%D8%A1%20%D8%A7%D9%84%D8%A7%D8%B5%D8%B7%D9%86%D8%A7%D8%B9%D9%8A" style={{ width: '100%', height: '100%', objectFit: 'cover' }} />
                            </div>
                            <h3 style={{ marginBottom: '15px', color: 'var(--primary)' }}>{t('tools_img')}</h3>
                            <p style={{ marginBottom: '20px', color: 'var(--text-secondary)' }}>{t('tools_img_desc')}</p>
                            <div style={{ marginBottom: '20px', fontWeight: 'bold', color: 'var(--primary)' }}>4 {t('credits')}</div>
                            <button className="btn btn-outline" style={{ width: '100%' }}>{t('btn_start')}</button>
                        </div>
                    </div>
                </div>
            );
        }

        function MixPage() {
            const { params, push } = useRouter();
            const { user, deductCredits, addHistoryItem, loading, t } = useAuth();
            const [mixType, setMixType] = useState(params.type);

            // File States
            const [reciter, setReciter] = useState(null);
            const [internalMourners, setInternalMourners] = useState([null]);
            const [externalLatmas, setExternalLatmas] = useState([null]);

            const [status, setStatus] = useState('input');
            const [progress, setProgress] = useState(0);
            const [log, setLog] = useState('');
            const [tip, setTip] = useState('');
            const [fileAnalysis, setFileAnalysis] = useState({}); // { id: { buffer, rms, status } }

            const isAnalyzing = useMemo(() => {
                const activeFiles = [reciter, ...(mixType === 'internal' ? internalMourners : externalLatmas)].filter(f => f);
                if (activeFiles.length === 0) return false;
                return activeFiles.some(f => {
                    const id = f.name + f.size;
                    return !fileAnalysis[id] || fileAnalysis[id].status !== 'done';
                });
            }, [reciter, internalMourners, externalLatmas, mixType, fileAnalysis]);

            useEffect(() => {
                if (status === 'processing') {
                    setTip("ÿ®ÿØÿ° ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿπŸÖŸÑ ÿßŸÑÿµŸàÿ™Ÿä...");
                }
            }, [status]);
            const [mp3Url, setMp3Url] = useState(null);
            const [wavUrl, setWavUrl] = useState(null);
            const [auditionUrl, setAuditionUrl] = useState(null);
            const [sesxUrl, setSesxUrl] = useState(null);

            useEffect(() => {
                if (!loading && !user) push('/login');
            }, [user, loading, push]);

            if (loading || !user) return null;

            // Handlers
            const handleMournerChange = (i, file) => {
                const arr = [...internalMourners]; arr[i] = file; setInternalMourners(arr);
            };
            const addMournerTrack = () => {
                if (internalMourners.length < 7) setInternalMourners([...internalMourners, null]);
            };
            const handleLatmaChange = (i, file) => {
                const arr = [...externalLatmas]; arr[i] = file; setExternalLatmas(arr);
            };
            const addLatmaTrack = () => {
                if (externalLatmas.length < 3) setExternalLatmas([...externalLatmas, null]);
            };

            // DSP Helpers
            const createImpulse = (ctx, duration, decay, reverse, brightness) => {
                const rate = ctx.sampleRate;
                const length = rate * duration;
                const impulse = ctx.createBuffer(2, length, rate);
                const left = impulse.getChannelData(0);
                const right = impulse.getChannelData(1);
                for (let i = 0; i < length; i++) {
                    const n = i / length;
                    const env = Math.pow(1 - n, decay);
                    left[i] = (Math.random() * 2 - 1) * env;
                    right[i] = (Math.random() * 2 - 1) * env;
                }
                return impulse;
            };

            const getLoudness = (buffer) => {
                const data = buffer.getChannelData(0);
                let sum = 0;
                // Analyze first 30 seconds or full duration
                const samples = Math.min(data.length, buffer.sampleRate * 30);
                const step = 200;
                for (let i = 0; i < samples; i += step) sum += data[i] * data[i];
                return Math.sqrt(sum / (samples / step));
            };

            const triggerAnalysis = (file) => {
                const fileId = file.name + file.size;
                setFileAnalysis(prev => ({ ...prev, [fileId]: { status: 'done' } }));
            };

            const generateSesx = (wavName, duration) => {
                const xml = `<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sesx version="1.0">
  <session name="Aza Mix Session" sampleRate="44100" bitDepth="32">
    <audioClip name="Master Mix" start="0" duration="${duration}">
        <source filePath="${wavName}"/>
    </audioClip>
  </session>
</sesx>`;
                return new Blob([xml], { type: 'application/xml' });
            };

            const encodeWAV32 = (audioBuffer) => {
                const numChannels = 2;
                const sampleRate = audioBuffer.sampleRate;
                const format = 3; // IEEE Float
                const bitDepth = 32;
                const bytesPerSample = bitDepth / 8;
                const blockAlign = numChannels * bytesPerSample;
                const byteRate = sampleRate * blockAlign;
                const dataSize = audioBuffer.length * blockAlign;
                const buffer = new ArrayBuffer(44 + dataSize);
                const view = new DataView(buffer);
                const writeString = (view, offset, string) => {
                    for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i));
                };
                writeString(view, 0, 'RIFF');
                view.setUint32(4, 36 + dataSize, true);
                writeString(view, 8, 'WAVE');
                writeString(view, 12, 'fmt ');
                view.setUint32(16, 16, true);
                view.setUint16(20, format, true);
                view.setUint16(22, numChannels, true);
                view.setUint32(24, sampleRate, true);
                view.setUint32(28, byteRate, true);
                view.setUint16(32, blockAlign, true);
                view.setUint16(34, bitDepth, true);
                writeString(view, 36, 'data');
                view.setUint32(40, dataSize, true);
                const left = audioBuffer.getChannelData(0);
                const right = audioBuffer.getChannelData(1);
                let offset = 44;
                for (let i = 0; i < audioBuffer.length; i++) {
                    view.setFloat32(offset, left[i], true); offset += 4;
                    view.setFloat32(offset, right[i], true); offset += 4;
                }
                return new Blob([buffer], { type: 'audio/wav' });
            };

            const encodeWAV = (audioBuffer) => {
                const numChannels = 2;
                const sampleRate = audioBuffer.sampleRate;
                const format = 1; // PCM
                const bitDepth = 16;
                const bytesPerSample = bitDepth / 8;
                const blockAlign = numChannels * bytesPerSample;
                const byteRate = sampleRate * blockAlign;
                const dataSize = audioBuffer.length * blockAlign;
                const buffer = new ArrayBuffer(44 + dataSize);
                const view = new DataView(buffer);

                const writeString = (view, offset, string) => {
                    for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i));
                };

                writeString(view, 0, 'RIFF');
                view.setUint32(4, 36 + dataSize, true);
                writeString(view, 8, 'WAVE');
                writeString(view, 12, 'fmt ');
                view.setUint32(16, 16, true);
                view.setUint16(20, format, true);
                view.setUint16(22, numChannels, true);
                view.setUint32(24, sampleRate, true);
                view.setUint32(28, byteRate, true);
                view.setUint16(32, blockAlign, true);
                view.setUint16(34, bitDepth, true);
                writeString(view, 36, 'data');
                view.setUint32(40, dataSize, true);

                const left = audioBuffer.getChannelData(0);
                const right = audioBuffer.getChannelData(1);
                let offset = 44;
                for (let i = 0; i < audioBuffer.length; i++) {
                    let l = left[i];
                    let r = right[i];
                    if (l > 1) l = 1; else if (l < -1) l = -1;
                    if (r > 1) r = 1; else if (r < -1) r = -1;
                    view.setInt16(offset, l < 0 ? l * 0x8000 : l * 0x7FFF, true);
                    offset += 2;
                    view.setInt16(offset, r < 0 ? r * 0x8000 : r * 0x7FFF, true);
                    offset += 2;
                }
                return new Blob([buffer], { type: 'audio/wav' });
            };

            const processAudio = async () => {
                if (!reciter) return alert("Ÿäÿ±ÿ¨Ÿâ ÿ±ŸÅÿπ ÿµŸàÿ™ ÿßŸÑÿ±ÿßÿØŸàÿØ ÿ£ŸàŸÑÿßŸã");
                if (mixType === 'internal' && !internalMourners[0]) return alert("Ÿäÿ±ÿ¨Ÿâ ÿ±ŸÅÿπ ŸÖŸÑŸÅ ÿßŸÑÿπÿ≤ÿßÿ°/ÿßŸÑŸÑÿ∑ŸÖÿ©");

                const success = await deductCredits(4);
                if (!success) { alert('ÿ±ÿµŸäÿØŸÉ ÿ∫Ÿäÿ± ŸÉÿßŸÅŸç.'); return; }

                setStatus('processing');
                setProgress(0);
                setLog('ÿßŸÑÿ±ÿ®ÿ∑ ŸÖÿπ ŸÖÿ±ŸÉÿ≤ ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿä (v14.2)...');
                setTip('ÿ¨Ÿáÿßÿ≤ŸÉ ÿßŸÑÿ¢ŸÜ ŸÅŸä Ÿàÿ∂ÿπ "ÿπÿ±ÿ∂ ŸÅŸÇÿ∑".. ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ© ÿ™ÿ™ŸÖ ŸÅŸä ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©.');

                // --- Natural Progress (1.2s per 1%) ---
                let currentP = 0;
                const progressInterval = setInterval(() => {
                    if (currentP < 99) {
                        currentP++;
                        setProgress(currentP);
                    }
                }, 1200);


                // Masterpiece Engine (44.1kHz Stereo - Pure CD Quality)
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 44100 });

                try {
                    const decode = async (file) => {
                        let ab = await file.arrayBuffer();
                        const full = await audioCtx.decodeAudioData(ab);
                        ab = null;
                        // Resample to 44.1kHz for pure CD quality
                        const clean = audioCtx.createBuffer(1, full.length, 44100);
                        clean.copyToChannel(full.getChannelData(0), 0);
                        return clean;
                    };

                    setTip('ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ®ÿµŸÖÿ© ÿßŸÑÿµŸàÿ™Ÿäÿ©...');
                    let vocalBuf = await decode(reciter);
                    let mournerBuffers = [];
                    const musicFiles = mixType === 'internal' ? internalMourners : externalLatmas;
                    for (let f of musicFiles) if (f) mournerBuffers.push(await decode(f));

                    const maxDur = Math.max(vocalBuf.duration, ...mournerBuffers.map(b => b.duration));
                    // 44.1kHz Stereo Context
                    const offCtx = new OfflineAudioContext(2, Math.ceil(maxDur * 44100), 44100);

                    // --- 1. PRO DIFFUSION REVERB (Lush & Wide) ---
                    const createStudioReverb = (decay, wet) => {
                        const input = offCtx.createGain();
                        const output = offCtx.createGain(); output.gain.value = wet;
                        const merger = offCtx.createChannelMerger(2);
                        const buildChannel = (ch) => {
                            const bus = offCtx.createGain();
                            [0.013, 0.011, 0.007].forEach(t => {
                                const ap = offCtx.createBiquadFilter(); ap.type = 'allpass'; ap.frequency.value = 1000 / t;
                                input.connect(ap); ap.connect(bus);
                            });
                            [0.035, 0.045, 0.055, 0.075].forEach(d => {
                                const delay = offCtx.createDelay(); delay.delayTime.value = d;
                                const fb = offCtx.createGain(); fb.gain.value = Math.pow(0.001, d / (decay / 1000));
                                bus.connect(delay); delay.connect(fb); fb.connect(delay); delay.connect(merger, 0, ch);
                            });
                        };
                        buildChannel(0); buildChannel(1);
                        merger.connect(output);
                        return { input, output };
                    };

                    const vRev = createStudioReverb(2800, 0.28);
                    const mRev = createStudioReverb(3500, 0.45);

                    // --- 2. THE MASTER (Broadcast Limiter) ---
                    const masterLimiter = offCtx.createDynamicsCompressor();
                    masterLimiter.threshold.value = -0.5; masterLimiter.ratio.value = 20; masterLimiter.attack.value = 0.001;
                    masterLimiter.connect(offCtx.destination);
                    const masterGain = offCtx.createGain(); masterGain.gain.value = 1.40; // +3dB Push
                    masterGain.connect(masterLimiter);

                    // --- 3. LEAD VOCAL (Ultra-Presence) ---
                    const vSource = offCtx.createBufferSource(); vSource.buffer = vocalBuf;
                    const vEqH = offCtx.createBiquadFilter(); vEqH.type = 'peaking'; vEqH.frequency.value = 6500; vEqH.gain.value = 5.0;
                    const vEqB = offCtx.createBiquadFilter(); vEqB.type = 'peaking'; vEqB.frequency.value = 180; vEqB.gain.value = 4.0;
                    const vComp = offCtx.createDynamicsCompressor(); vComp.threshold.value = -16; vComp.ratio.value = 3.5;

                    vSource.connect(vEqH); vEqH.connect(vEqB); vEqB.connect(vComp);
                    vComp.connect(masterGain);
                    vComp.connect(vRev.input); vRev.output.connect(masterGain);

                    // --- 4. THE SLAP (Bahraini Thump Bus) ---
                    const slapBus = offCtx.createGain();
                    const mEqL = offCtx.createBiquadFilter(); mEqL.type = 'peaking'; mEqL.frequency.value = 75; mEqL.gain.value = 9.0;
                    const mEqM = offCtx.createBiquadFilter(); mEqM.type = 'peaking'; mEqM.frequency.value = 2400; mEqM.gain.value = 3.5;

                    slapBus.connect(mEqL); mEqL.connect(mEqM); mEqM.connect(masterGain);
                    slapBus.connect(mRev.input); mRev.output.connect(masterGain);

                    mournerBuffers.forEach(b => {
                        const mSource = offCtx.createBufferSource(); mSource.buffer = b;
                        const mPan = offCtx.createStereoPanner(); mPan.pan.value = (Math.random() * 0.8) - 0.4; // Wide Stereo
                        mSource.connect(mPan);
                        mPan.connect(slapBus);
                        mSource.start(0);
                    });

                    vSource.start(0);
                    const rendered = await offCtx.startRendering();

                    // Master Finalization with 320kbps Quality
                    const mp3Blob = await (new Promise(async (res, rej) => {
                        try {
                            setLog('Ÿäÿ™ŸÖ ÿßŸÑÿ¢ŸÜ ÿ™ÿ¥ŸÅŸäÿ± ÿßŸÑŸÖŸÇÿ∑ÿπ ÿ®ÿ¨ŸàÿØÿ© ÿ≥ÿ™ŸàÿØŸäŸà (320kbps)...');
                            const encoder = new lamejs.Mp3Encoder(2, 44100, 320);
                            const samplesL = rendered.getChannelData(0);
                            const samplesR = rendered.getChannelData(1);
                            const chunks = [];
                            const bSize = 1152 * 100;

                            for (let i = 0; i < samplesL.length; i += bSize) {
                                const size = Math.min(bSize, samplesL.length - i);
                                const i16L = new Int16Array(size); const i16R = new Int16Array(size);
                                for (let j = 0; j < size; j++) {
                                    let l = samplesL[i + j]; let r = samplesR[i + j];
                                    if (l > 1) l = 1; else if (l < -1) l = -1;
                                    if (r > 1) r = 1; else if (r < -1) r = -1;
                                    i16L[j] = l < 0 ? l * 0x8000 : l * 0x7FFF;
                                    i16R[j] = r < 0 ? r * 0x8000 : r * 0x7FFF;
                                }
                                const mp3b = encoder.encodeBuffer(i16L, i16R);
                                if (mp3b.length > 0) chunks.push(mp3b);

                                if (i % (bSize * 3) === 0) await new Promise(r => setTimeout(r, 0));
                            }
                            const finalTag = encoder.flush();
                            if (finalTag.length > 0) chunks.push(finalTag);

                            setTimeout(() => { res(new Blob(chunks, { type: 'audio/mp3' })); }, 300);
                        } catch (err) { rej(err); }
                    }));

                    // Final Sync Logic
                    window.finalizeMix = (blob) => {
                        if (progressInterval) clearInterval(progressInterval);

                        // Final 99% to 100% jump (max 3 seconds as requested)
                        setProgress(99);
                        setTip('ÿ¨ÿßÿ±Ÿä ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑŸÜŸáÿßÿ¶Ÿä...');
                        setLog('Ÿäÿ™ŸÖ ÿßŸÑÿ¢ŸÜ ÿ•ŸÜÿ™ÿßÿ¨ ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™ÿ±ÿßŸÅŸäÿ©...');

                        // Strictly 3 seconds from 99% to 100%
                        setTimeout(() => {
                            setProgress(100);
                            const resUrl = URL.createObjectURL(blob);
                            setMp3Url(resUrl);
                            setStatus('success');

                            addHistoryItem({
                                id: Date.now(),
                                name: `ŸÖŸÉÿ≥ÿßÿ¨ ÿßÿ≠ÿ™ÿ±ÿßŸÅŸä ${mixType === 'internal' ? '(ÿπÿ≤ÿßÿ°)' : '(ÿÆÿßÿ±ÿ¨Ÿä)'}`,
                                date: new Date().toLocaleDateString('ar-BH'),
                                type: 'audio',
                                url: resUrl,
                                status: 'completed'
                            });
                        }, 3000);
                    };

                    // Finish sequence
                    window.finalizeMix(mp3Blob);

                } catch (e) {
                    clearInterval(progressInterval);
                    console.error(e);
                    alert("ŸÜÿπÿ™ÿ∞ÿ±ÿå ÿ≠ÿØÿ´ ÿ™ÿπÿßÿ±ÿ∂ ŸÅŸä ÿÆŸàÿßÿØŸÖ ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿäÿ©.");
                    setStatus('input');
                }
            };

            if (status === 'success') return (
                <div className="container animate-fade-in" style={{ padding: '50px', maxWidth: '600px', textAlign: 'center' }}>
                    <div className="card" style={{ borderColor: 'var(--success)' }}>
                        <h1 style={{ color: 'var(--success)', marginBottom: '20px' }}>{t('mix_success_msg')}</h1>
                        <audio controls src={mp3Url} style={{ width: '100%', margin: '20px 0' }} />
                        <div style={{ display: 'flex', gap: '10px', justifyContent: 'center', flexWrap: 'wrap' }}>
                            <a href={mp3Url} download="aza-mix.mp3" className="btn btn-primary" style={{ padding: '10px 25px' }}>{t('res_download')} MP3</a>
                        </div>
                        <div style={{ marginTop: '20px' }}><button onClick={() => { setStatus('input'); setMp3Url(null); }} className="btn btn-outline">{t('mix_btn_new')}</button></div>
                    </div>
                </div>
            );

            if (status === 'processing') return (
                <div className="container animate-fade-in" style={{ padding: '80px 20px', maxWidth: '600px', textAlign: 'center' }}>
                    <div className="processing-card">
                        <div style={{ fontSize: '3.5rem', marginBottom: '10px' }}>‚è≥</div>
                        <h2 style={{ marginBottom: '20px', color: 'var(--primary)' }}>ÿ¨ÿßÿ±Ÿä ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿäÿ© ÿßŸÑÿßÿ≠ÿ™ÿ±ÿßŸÅŸäÿ©</h2>
                        <p style={{ opacity: 0.7, fontSize: '0.9rem', marginBottom: '30px' }}>Ÿäÿ™ŸÖ ÿßŸÑÿ¢ŸÜ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÖÿ≠ÿßŸÉÿßÿ© Adobe Audition Engine ŸÑÿ∂ŸÖÿßŸÜ ÿ£ÿπŸÑŸâ ÿ¨ŸàÿØÿ© ŸÖŸÉÿ≥</p>

                        <div style={{ width: '100%', height: '14px', background: 'var(--surface)', borderRadius: '7px', margin: '20px 0', overflow: 'hidden', border: '1px solid var(--border)', position: 'relative' }}>
                            <div style={{ width: `${progress}%`, height: '100%', background: 'var(--primary)', transition: 'width 1s linear' }}>
                                <div className="progress-sweep"></div>
                            </div>
                        </div>

                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                            <span style={{ color: 'var(--primary)', fontWeight: 'bold', fontSize: '1.2rem' }}>{progress}%</span>
                            <span style={{ fontSize: '0.85rem', color: 'var(--text-secondary)' }}>{tip}</span>
                        </div>

                        <div style={{ padding: '15px', background: 'rgba(0,0,0,0.3)', borderRadius: '10px', border: '1px solid var(--border)' }}>
                            <p style={{ color: 'var(--primary)', fontSize: '0.95rem', margin: 0 }}>{log}</p>
                        </div>
                        <p style={{ fontSize: '0.75rem', marginTop: '20px', opacity: 0.5 }}>ŸÜÿπÿØŸÑŸÉ ÿßŸÑÿµŸàÿ™ ÿ®ŸÖŸàÿßÿµŸÅÿßÿ™ ÿßŸÑŸÖŸàŸÉÿ® ÿßŸÑÿßÿ≠ÿ™ÿ±ÿßŸÅŸäÿ©ÿå Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±...</p>
                    </div>
                </div>
            );

            if (!mixType) return (
                <div className="container animate-fade-in" style={{ padding: '100px 20px', textAlign: 'center' }}>
                    <h2 style={{ marginBottom: '30px', fontSize: '2rem' }}>{t('mix_smart_title')}</h2>
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))', gap: '20px', maxWidth: '800px', margin: '0 auto' }}>
                        <div className="card" onClick={() => setMixType('internal')} style={{ padding: '30px', cursor: 'pointer', border: '2px solid var(--border)', transition: '0.3s' }} onMouseEnter={e => e.currentTarget.style.borderColor = 'var(--primary)'} onMouseLeave={e => e.currentTarget.style.borderColor = 'var(--border)'}>
                            <h3>{t('mix_internal_title')}</h3>
                            <p style={{ color: 'var(--text-secondary)', marginTop: '10px' }}>{t('mix_internal_desc')}</p>
                        </div>
                        <div className="card" onClick={() => setMixType('external')} style={{ padding: '30px', cursor: 'pointer', border: '2px solid var(--border)', transition: '0.3s' }} onMouseEnter={e => e.currentTarget.style.borderColor = 'var(--primary)'} onMouseLeave={e => e.currentTarget.style.borderColor = 'var(--border)'}>
                            <h3>{t('mix_external_title')}</h3>
                            <p style={{ color: 'var(--text-secondary)', marginTop: '10px' }}>{t('mix_external_desc')}</p>
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="container animate-fade-in" style={{ padding: '20px', maxWidth: '1200px' }}>
                    <BackButton />

                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(350px, 1fr))', gap: '30px' }}>
                        {/* Creative Column (Uploads / Results) */}
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '20px' }}>
                            {/* Success Result area */}
                            {status === 'success' && (
                                <div className="card animate-fade-in" style={{ padding: '20px', background: 'linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(0, 0, 0, 0) 100%)', borderColor: 'var(--success)' }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '15px', marginBottom: '20px' }}>
                                        <div style={{ width: '60px', height: '60px', borderRadius: '12px', background: 'var(--success)', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '1.5rem' }}>üéß</div>
                                        <div>
                                            <h3 style={{ color: 'var(--success)' }}>{t('mix_success_msg')}</h3>
                                            <p style={{ fontSize: '0.85rem', color: 'var(--text-secondary)' }}>{t('mix_ready_msg')}</p>
                                        </div>
                                    </div>

                                    <div style={{ background: '#000', borderRadius: '12px', padding: '15px', marginBottom: '20px', border: '1px solid var(--border)' }}>
                                        <audio controls src={mp3Url || wavUrl} style={{ width: '100%' }} />
                                    </div>

                                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' }}>
                                        {mp3Url && <a href={mp3Url} download="aza-mix.mp3" className="btn btn-primary" style={{ flex: 1 }}>‚¨áÔ∏è {t('res_download')} MP3</a>}
                                        {wavUrl && <a href={wavUrl} download="aza-mix-highres.wav" className="btn btn-outline" style={{ flex: 1 }}>üîâ {t('btn_download_wav')}</a>}
                                        {sesxUrl && (
                                            <a href={sesxUrl} download="aza-project.sesx" className="btn btn-outline" style={{ gridColumn: 'span 2', borderColor: '#a29bfe', color: '#a29bfe' }}>üéöÔ∏è Adobe Audition (.sesx)</a>
                                        )}
                                        {auditionUrl && (
                                            <a href={auditionUrl} download="aza-mix-audition.wav" className="btn btn-outline" style={{ gridColumn: 'span 2', fontSize: '0.8rem', opacity: 0.8 }}>Download 32-bit WAV (for Audition)</a>
                                        )}
                                    </div>

                                    <button onClick={() => { setStatus('input'); setMp3Url(null); setWavUrl(null); }} className="btn btn-outline" style={{ width: '100%', marginTop: '10px', fontSize: '0.9rem' }}>{t('mix_btn_new')}</button>
                                </div>
                            )}

                            {/* Processing Progress Area */}
                            {status === 'processing' && (
                                <div className="card animate-fade-in" style={{ padding: '30px', textAlign: 'center' }}>
                                    <h2 className="animate-pulse" style={{ fontSize: '1.2rem', marginBottom: '20px' }}>{tip}</h2>
                                    <div style={{ width: '100%', height: '10px', background: 'var(--surface)', borderRadius: '5px', overflow: 'hidden', border: '1px solid var(--border)', marginBottom: '15px' }}>
                                        <div style={{ width: `${progress}%`, height: '100%', background: 'var(--primary)', transition: 'width 0.4s ease' }}></div>
                                    </div>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '0.85rem', color: 'var(--text-secondary)' }}>
                                        <span>{log}</span>
                                        <span style={{ fontWeight: 'bold', color: 'var(--primary)' }}>{progress}%</span>
                                    </div>
                                </div>
                            )}

                            {/* Main Input Card */}
                            {status === 'input' && (
                                <div className="card" style={{ padding: '25px' }}>
                                    <h3 style={{ marginBottom: '20px', display: 'flex', alignItems: 'center', gap: '10px' }}>{t('mix_upload_title')}</h3>

                                    <div className="form-group" style={{ marginBottom: '25px' }}>
                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '10px' }}>
                                            <label style={{ color: 'var(--primary)', fontWeight: 'bold', fontSize: '0.9rem', marginBottom: 0 }}>{t('mix_track_reciter')}</label>
                                            {/* Removed fileAnalysis check as triggerAnalysis is removed */}
                                        </div>
                                        <input type="file" onChange={(e) => {
                                            const f = e.target.files[0];
                                            setReciter(f);
                                            // Removed triggerAnalysis call
                                        }} accept="audio/*,audio/mpeg,.mpeg" className="input-field" style={{ width: '100%' }} />
                                    </div>

                                    {mixType === 'internal' ? (
                                        <div className="form-group">
                                            <label style={{ display: 'block', marginBottom: '10px', fontWeight: 'bold', fontSize: '0.9rem' }}>{t('mix_track_mourners_list')}</label>
                                            <div className="card" style={{ padding: '20px', border: '2px dashed var(--border)', textAlign: 'center', background: 'rgba(255,255,255,0.02)' }}>
                                                <input
                                                    type="file"
                                                    onChange={(e) => {
                                                        const files = Array.from(e.target.files).slice(0, 7);
                                                        setInternalMourners(files);
                                                        // Removed triggerAnalysis calls
                                                    }}
                                                    accept="audio/*,audio/mpeg,.mpeg"
                                                    multiple
                                                    className="input-field"
                                                    style={{ marginBottom: '15px' }}
                                                />
                                                <div style={{ textAlign: 'right', maxHeight: '200px', overflowY: 'auto' }}>
                                                    {internalMourners.filter(f => f).map((f, i) => (
                                                        <div key={i} style={{ padding: '8px', borderBottom: '1px solid var(--border)', fontSize: '0.8rem', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                                            <span>{f.name}</span>
                                                            {/* Removed fileAnalysis check */}
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="form-group">
                                            <label style={{ display: 'block', marginBottom: '10px', fontWeight: 'bold', fontSize: '0.9rem' }}>{t('mix_track_latma_list')}</label>
                                            {externalLatmas.map((f, i) => (
                                                <div key={i} style={{ display: 'flex', gap: '10px', marginBottom: '10px' }}>
                                                    <input type="file" onChange={(e) => {
                                                        const file = e.target.files[0];
                                                        handleLatmaChange(i, file);
                                                        // Removed triggerAnalysis call
                                                    }} accept="audio/*,audio/mpeg,.mpeg" className="input-field" style={{ flex: 1, marginBottom: 0 }} />
                                                    {/* Removed fileAnalysis check */}
                                                </div>
                                            ))}
                                            {externalLatmas.length < 3 && (
                                                <button onClick={addLatmaTrack} className="btn btn-outline" style={{ width: '100%', fontSize: '0.8rem', padding: '8px' }}>{t('mix_btn_add')}</button>
                                            )}
                                        </div>
                                    )}



                                    <button
                                        onClick={processAudio}
                                        disabled={!reciter || (mixType === 'internal' ? internalMourners.filter(f => f).length === 0 : externalLatmas.filter(f => f).length === 0)}
                                        className="btn btn-primary"
                                        style={{
                                            width: '100%',
                                            marginTop: '30px',
                                            padding: '15px',
                                            fontSize: '1.1rem'
                                        }}
                                    >
                                        üöÄ {t('mix_btn_start_now')}
                                    </button>
                                </div>
                            )}
                        </div>

                        {/* Settings / Info Column */}
                        <div className="card" style={{ padding: '25px', display: 'flex', flexDirection: 'column', gap: '20px', height: 'fit-content' }}>
                            <h3 style={{ display: 'flex', alignItems: 'center', gap: '10px', color: 'var(--primary)' }}>{t('mix_settings_title')}</h3>

                            <div style={{ padding: '15px', background: 'rgba(0, 74, 173, 0.05)', borderRadius: '12px', border: '1px solid var(--border)' }}>
                                <div style={{ fontSize: '0.85rem', color: 'var(--text-secondary)', marginBottom: '5px' }}>{t('mix_project_type')}</div>
                                <div style={{ fontWeight: 'bold' }}>{mixType === 'internal' ? t('mix_internal_title') : t('mix_external_title')}</div>
                                <button onClick={() => { setMixType(null); setStatus('input'); }} style={{ marginTop: '10px', fontSize: '0.8rem', color: 'var(--primary)', background: 'none', border: 'none', cursor: 'pointer', textDecoration: 'underline' }}>{t('mix_change_type')}</button>
                            </div>

                            <div style={{ padding: '15px', borderRadius: '12px', border: '1px solid var(--border)' }}>
                                <h4 style={{ fontSize: '0.9rem', marginBottom: '10px' }}>{t('mix_applied_filters')}</h4>
                                <ul style={{ fontSize: '0.8rem', color: 'var(--text-secondary)', paddingRight: '20px' }}>
                                    <li>{t('mix_filter_reverb')}</li>
                                    <li>{t('mix_filter_echo')}</li>
                                    <li>{t('mix_filter_limiter')}</li>
                                    <li>{t('mix_filter_stereo')}</li>
                                </ul>
                            </div>

                            <div style={{ textAlign: 'center', padding: '10px' }}>
                                <div style={{ fontSize: '0.9rem', marginBottom: '5px' }}>{t('mix_cost')}:</div>
                                <div className="badge" style={{ fontSize: '1.2rem', padding: '8px 20px' }}>4 {t('credits')} ü™ô</div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function ImageGenPage() {
            const { user, deductCredits, addHistoryItem, loading, t } = useAuth();
            const { push } = useRouter();
            const [prompt, setPrompt] = useState('');
            const [model, setModel] = useState('gemini-imagen-3');
            const [aspectRatio, setAspectRatio] = useState('1:1');
            const [generating, setGenerating] = useState(false);
            const [result, setResult] = useState(null);

            const [statusMsg, setStatusMsg] = useState('');
            const [progress, setProgress] = useState(0);
            const [countdown, setCountdown] = useState(null);

            const models = useMemo(() => [
                { id: 'nano banana', type: 'image', name: 'nano banana', cost: 3, icon: 'üçå', desc: t('model_gemini_desc') },
                { id: 'nano banana pro', type: 'image', name: 'nano banana pro', cost: 4, icon: 'üçå‚ú®', desc: t('model_gemini_pro_desc') }
            ], [t]);

            useEffect(() => {
                if (!loading && !user) push('/login');
            }, [user, loading, push]);

            const handleGenerate = async () => {
                if (!prompt || !prompt.trim()) return alert('Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ŸàÿµŸÅ');

                const selectedModel = models.find(m => m.id === model);
                const totalCost = selectedModel.cost;

                if (user.credits < totalCost) return alert(`ÿ±ÿµŸäÿØŸÉ ÿ∫Ÿäÿ± ŸÉÿßŸÅŸç. ÿßŸÑÿ™ŸÉŸÑŸÅÿ©: ${totalCost} ŸÉÿ±ŸäÿØŸäÿ™`);

                setGenerating(true);
                setProgress(0);
                setResult(null);
                setStatusMsg(t('status_reading'));

                try {
                    const success = await deductCredits(totalCost);
                    if (!success) throw new Error('Credit deduction failed');

                    let finalPrompt = prompt;
                    if (/[\u0600-\u06FF]/.test(prompt)) {
                        setStatusMsg(t('status_translating'));
                        try {
                            const tResp = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=ar&tl=en&dt=t&q=${encodeURIComponent(prompt)}`);
                            const tData = await tResp.json();
                            if (tData?.[0]?.[0]) finalPrompt = tData[0].map(x => x[0]).join('');
                        } catch (e) { console.warn("Translation failed"); }
                    }

                    const totalTime = 30000;
                    const startTime = Date.now();
                    const interval = setInterval(() => {
                        const elapsed = Date.now() - startTime;
                        const p = Math.min(Math.floor((elapsed / totalTime) * 100), 99);
                        setProgress(p);

                        if (p < 20) setStatusMsg(t('status_reading'));
                        else if (p < 40) setStatusMsg(t('status_drawing'));
                        else if (p < 60) setStatusMsg(t('status_details'));
                        else if (p < 80) setStatusMsg(t('status_coloring'));
                        else setStatusMsg(t('status_lighting'));
                    }, 500);

                    const seed = Math.floor(Math.random() * 1e9);
                    let w = 1024, h = 1024;
                    if (aspectRatio === '9:16') { w = 768; h = 1344; }
                    else if (aspectRatio === '16:9') { w = 1344; h = 768; }

                    let genUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(finalPrompt + ", cinematic, masterpiece, highly detailed")}?width=${w}&height=${h}&seed=${seed}&nologo=true&model=flux`;

                    setTimeout(async () => {
                        clearInterval(interval);
                        setProgress(100);
                        setStatusMsg('ÿ¨ÿßÿ±Ÿä ÿßÿ≥ÿ™ŸÑÿßŸÖ ŸàŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑŸÜŸáÿßÿ¶Ÿäÿ©...');

                        // Pre-load the image to ensure it's ready before showing success
                        const img = new Image();
                        img.onload = () => {
                            setGenerating(false);
                            setResult(genUrl);
                            setStatusMsg(t('status_success'));
                            addHistoryItem({
                                id: Date.now(),
                                name: prompt.substring(0, 30) + '...',
                                date: new Date().toLocaleDateString('ar-BH'),
                                url: genUrl,
                                status: 'completed',
                                type: 'image'
                            });
                        };
                        img.onerror = () => {
                            setGenerating(false);
                            setResult(genUrl);
                            setStatusMsg(t('status_success'));
                        };
                        img.src = genUrl;
                    }, totalTime);

                } catch (e) {
                    console.error(e);
                    setGenerating(false);
                    alert("ÿπÿ∞ÿ±ÿßŸãÿå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£.");
                }
            };

            if (loading || !user) return null;

            return (
                <div className="container animate-fade-in" style={{ padding: '20px', maxWidth: '1200px' }}>
                    <BackButton />

                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(350px, 1fr))', gap: '30px' }}>
                        {/* Settings Column */}
                        <div className="card" style={{ padding: '25px', display: 'flex', flexDirection: 'column', gap: '20px' }}>
                            <h3 style={{ display: 'flex', alignItems: 'center', gap: '10px', color: 'var(--primary)' }}>‚öôÔ∏è {t('nav_tools')}</h3>

                            <div style={{ marginBottom: '25px' }}>
                                <label style={{ display: 'block', fontWeight: 'bold', marginBottom: '12px', fontSize: '0.9rem', color: 'var(--text-secondary)' }}>{t('gen_select_model')}</label>
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                                    {models.map(m => (
                                        <div
                                            key={m.id}
                                            onClick={() => setModel(m.id)}
                                            className={`card ${model === m.id ? 'active' : ''}`}
                                            style={{
                                                padding: '12px 15px',
                                                cursor: 'pointer',
                                                border: model === m.id ? '2px solid var(--primary)' : '1px solid var(--border)',
                                                background: model === m.id ? 'rgba(0, 74, 173, 0.1)' : 'var(--surface)',
                                                transition: '0.3s'
                                            }}
                                        >
                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                                <div style={{ fontWeight: 'bold', fontSize: '0.95rem' }}>{m.icon} {m.name}</div>
                                                <div className="badge" style={{ fontSize: '0.8rem' }}>{m.cost} ü™ô</div>
                                            </div>
                                            <div style={{ fontSize: '0.75rem', color: 'var(--text-secondary)', marginTop: '5px' }}>{m.desc}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <div style={{ marginBottom: '25px' }}>
                                <label style={{ display: 'block', fontWeight: 'bold', marginBottom: '12px', fontSize: '0.9rem', color: 'var(--text-secondary)' }}>{t('gen_select_ratio')}</label>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '8px' }}>
                                    {['1:1', '9:16', '16:9'].map(r => (
                                        <button
                                            key={r}
                                            onClick={() => setAspectRatio(r)}
                                            className="btn btn-outline"
                                            style={{
                                                padding: '10px 5px',
                                                fontSize: '0.85rem',
                                                borderColor: aspectRatio === r ? 'var(--primary)' : 'var(--border)',
                                                background: aspectRatio === r ? 'rgba(0, 74, 173, 0.1)' : 'transparent',
                                                color: aspectRatio === r ? 'var(--primary)' : 'var(--text-secondary)'
                                            }}
                                        >
                                            {r === '1:1' ? t('ratio_square') : r === '9:16' ? t('ratio_portrait') : t('ratio_landscape')}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            <div style={{ padding: '20px', background: 'rgba(0, 74, 173, 0.05)', borderRadius: '12px', border: '1px solid var(--border)', textAlign: 'center', marginBottom: '25px' }}>
                                <div style={{ fontSize: '0.9rem', color: 'var(--text-secondary)', marginBottom: '5px' }}>{t('gen_credits_cost')}</div>
                                <div style={{ fontSize: '1.5rem', fontWeight: 'bold', color: 'var(--primary)' }}>
                                    {models.find(m => m.id === model)?.cost} {t('credits')} ü™ô
                                </div>
                            </div>

                            <button
                                onClick={handleGenerate}
                                disabled={!prompt.trim() || generating}
                                className="btn btn-primary"
                                style={{ width: '100%', padding: '15px', fontSize: '1.1rem', fontWeight: 'bold', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '10px' }}
                            >
                                {generating ? t('gen_btn_drawing') : t('gen_btn_submit')}
                            </button>
                        </div>

                        {/* Creative Column */}
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '20px' }}>
                            {(generating || result) && (
                                <div className="card" style={{ minHeight: '350px', position: 'relative', display: 'flex', alignItems: 'center', justifyContent: 'center', textAlign: 'center', padding: '15px', overflow: 'hidden' }}>
                                    <div style={{ position: 'relative', zIndex: 1, width: '100%', height: '100%', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center' }}>
                                        {generating && (
                                            <div className="animate-fade-in" style={{ width: '100%' }}>
                                                <div style={{ position: 'relative', width: '110px', height: '110px', margin: '0 auto 20px' }}>
                                                    <svg width="110" height="110">
                                                        <circle cx="55" cy="55" r="50" fill="transparent" stroke="var(--border)" strokeWidth="6" />
                                                        <circle cx="55" cy="55" r="50" fill="transparent" stroke="var(--primary)" strokeWidth="6"
                                                            strokeDasharray="314.159" strokeDashoffset={314.159 - (314.159 * progress) / 100}
                                                            strokeLinecap="round" style={{ transition: '0.3s', transform: 'rotate(-90deg)', transformOrigin: '55px 55px' }}
                                                        />
                                                    </svg>
                                                    <div style={{ position: 'absolute', inset: 0, display: 'flex', alignItems: 'center', justifyContent: 'center', fontWeight: 'bold', color: 'var(--primary)', fontSize: '1.2rem' }}>
                                                        {progress}%
                                                    </div>
                                                </div>
                                                <h2 className="animate-pulse" style={{ fontSize: '1.2rem' }}>{statusMsg}</h2>
                                            </div>
                                        )}

                                        {result && !generating && (
                                            <div className="animate-fade-in" style={{ width: '100%' }}>
                                                <h2 style={{ color: 'var(--success)', marginBottom: '20px' }}>{statusMsg}</h2>
                                                <div style={{ borderRadius: '12px', overflow: 'hidden', background: '#000', border: '1px solid var(--border)', marginBottom: '15px' }}>
                                                    <img src={result} alt="Result" style={{ width: '100%', display: 'block' }} />
                                                </div>
                                                <div style={{ display: 'flex', gap: '10px' }}>
                                                    <a href={result} download={`Minbar-AI-${Date.now()}`} target="_blank" className="btn btn-primary" style={{ flex: 1 }}>‚¨áÔ∏è {t('res_download')}</a>
                                                    <button onClick={() => setResult(null)} className="btn btn-outline">{t('res_new')}</button>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {/* Prompt Input Card */}
                            <div className="card" style={{ padding: '25px', marginTop: '20px' }}>
                                <h3 style={{ marginBottom: '15px' }}>üìù {t('gen_btn')}</h3>
                                <textarea
                                    className="input-field"
                                    style={{ height: '140px', resize: 'none', fontSize: '1rem' }}
                                    placeholder={t('gen_placeholder')}
                                    value={prompt}
                                    onChange={e => setPrompt(e.target.value)}
                                    onKeyDown={(e) => {
                                        if (e.key === 'Enter' && !e.shiftKey && !generating) {
                                            e.preventDefault();
                                            handleGenerate();
                                        }
                                    }}
                                    disabled={generating}
                                />
                                <button
                                    onClick={handleGenerate}
                                    disabled={generating}
                                    className="btn btn-primary"
                                    style={{ width: '100%', padding: '15px', fontSize: '1.1rem', marginTop: '10px' }}
                                >
                                    {generating ? 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ÿ∂Ÿäÿ±...' : `üöÄ ${t('gen_btn')}`}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }




        function ProfilePage() {
            const { user, t } = useAuth();
            if (!user) return null;
            return (
                <div className="container animate-fade-in" style={{ padding: '60px 20px', maxWidth: '600px' }}>
                    <BackButton />
                    <div className="card">
                        <h2 style={{ marginBottom: '20px', color: 'var(--primary)' }}>{t('nav_profile')}</h2>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '20px', marginBottom: '30px' }}>
                            {user.photo ? (
                                <img src={user.photo} alt="Profile" style={{ width: '80px', height: '80px', borderRadius: '50%', border: '2px solid var(--primary)', objectFit: 'cover' }} />
                            ) : (
                                <div style={{ width: '80px', height: '80px', background: 'var(--surface-hover)', borderRadius: '50%', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '2rem', border: '2px solid var(--primary)' }}>üë§</div>
                            )}
                            <div>
                                <h3 style={{ margin: 0 }}>{user.name}</h3>
                                <p style={{ color: 'var(--text-secondary)' }}>{user.email}</p>
                            </div>
                        </div>
                        <div className="badge animate-pulse" style={{ fontSize: '1.2rem', padding: '10px 20px' }}>{t('balance')}: {user.credits} {t('credits')}</div>
                    </div>
                </div>
            );
        }

        function HistoryPage() {
            const { user, t } = useAuth();
            if (!user) return null;
            return (
                <div className="container animate-fade-in" style={{ padding: '60px 20px', maxWidth: '800px' }}>
                    <BackButton />
                    <h2 style={{ marginBottom: '30px', borderBottom: '1px solid var(--border)', paddingBottom: '15px' }}>{t('hist_title')}</h2>
                    <div className="card" style={{ padding: '0', background: 'transparent', border: 'none' }}>
                        {user.history && user.history.length > 0 ? (
                            <div style={{ display: 'grid', gap: '15px' }}>
                                {user.history.slice().reverse().map((item, i) => (
                                    <div key={i} className="card" style={{ padding: '15px', display: 'flex', alignItems: 'center', justifyContent: 'space-between', gap: '15px' }}>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>
                                            {item.type === 'image' ? (
                                                <img src={item.url} style={{ width: '60px', height: '60px', borderRadius: '8px', objectFit: 'cover', cursor: 'pointer', border: '1px solid var(--border)' }} onClick={() => window.open(item.url, '_blank')} />
                                            ) : (
                                                <div style={{ width: '60px', height: '60px', background: 'rgba(0, 74, 173, 0.1)', borderRadius: '8px', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '1.5rem', border: '1px solid var(--border)' }}>üéôÔ∏è</div>
                                            )}

                                            <div>
                                                <div style={{ fontWeight: 'bold', marginBottom: '5px' }}>{item.name}</div>
                                                <div style={{ fontSize: '0.8rem', color: 'var(--text-secondary)' }}>{item.date}</div>
                                            </div>
                                        </div>

                                        <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                                            {item.url && item.status === 'completed' && (
                                                <a href={item.url} download={`Minbar-${item.id}`} className="btn btn-outline" style={{ padding: '6px 12px', fontSize: '0.8rem' }}>
                                                    ‚¨áÔ∏è {t('res_download')}
                                                </a>
                                            )}
                                            <span className="badge" style={{
                                                background: item.status === 'completed' ? 'rgba(76, 175, 80, 0.1)' : item.status === 'failed' ? 'rgba(244, 67, 54, 0.1)' : 'rgba(255, 193, 7, 0.1)',
                                                color: item.status === 'completed' ? '#4caf50' : item.status === 'failed' ? '#f4436' : '#ffc107'
                                            }}>
                                                {item.status === 'completed' ? t('status_completed') : item.status === 'failed' ? t('status_failed') : t('status_processing')}
                                            </span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <p style={{ textAlign: 'center', color: 'var(--text-secondary)' }}>{t('hist_empty')}</p>
                        )}
                    </div>
                </div>
            );
        }

        function SRTPage() {
            const { user, deductCredits, addHistoryItem, loading, t } = useAuth();
            const { push } = useRouter();
            const [audioFile, setAudioFile] = useState(null);
            const [audioUrl, setAudioUrl] = useState(null);
            const [audioDuration, setAudioDuration] = useState(0);

            const [poemText, setPoemText] = useState('');
            const [status, setStatus] = useState('input'); // input, processing, success
            const [progress, setProgress] = useState(0);
            const [log, setLog] = useState('');
            const [accuracy, setAccuracy] = useState(0);
            const [resultFile, setResultFile] = useState(null);

            useEffect(() => {
                if (!loading && !user) push('/login');
            }, [user, loading, push]);

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    // 30GB theoretical limit
                    if (file.size > 30 * 1024 * 1024 * 1024) {
                        alert("ÿπÿ∞ÿ±ÿßŸãÿå ÿ≠ÿ¨ŸÖ ÿßŸÑŸÖŸÑŸÅ ŸÉÿ®Ÿäÿ± ÿ¨ÿØÿßŸã (ÿßŸÑÿ£ŸÇÿµŸâ 30 ÿ¨Ÿäÿ¨ÿßÿ®ÿßŸäÿ™)");
                        e.target.value = null;
                        return;
                    }

                    const url = URL.createObjectURL(file);
                    const audio = new Audio(url);
                    audio.onloadedmetadata = () => {
                        if (audio.duration > 24 * 60) {
                            alert("ÿπÿ∞ÿ±ÿßŸãÿå Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑŸÖÿ±ŸÅŸàÿπ ÿ£ŸÇŸÑ ŸÖŸÜ 24 ÿØŸÇŸäŸÇÿ©.");
                            setAudioFile(null);
                            setAudioUrl(null);
                            e.target.value = null;
                        } else {
                            setAudioDuration(audio.duration);
                            setAudioFile(file);
                            setAudioUrl(url);
                        }
                    };
                }
            };

            const formatTime = (sec) => {
                const m = Math.floor(sec / 60);
                const s = Math.floor(sec % 60);
                return `${m}:${s < 10 ? '0' : ''}${s}`;
            };

            const toSRTTime = (seconds) => {
                const date = new Date(null);
                date.setSeconds(seconds);
                const ms = Math.floor((seconds % 1) * 1000);
                const timeString = date.toISOString().substr(11, 8);
                return `${timeString},${ms.toString().padStart(3, '0')}`;
            };

            const processSRT = async () => {
                if (!audioFile || !poemText.trim()) return alert("Ÿäÿ±ÿ¨Ÿâ ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿµŸàÿ™Ÿä Ÿàÿ•ÿØÿÆÿßŸÑ ŸÜÿµ ÿßŸÑŸÇÿµŸäÿØÿ©");
                if (user.credits < 3) return alert("ÿπÿ∞ÿ±ÿßŸãÿå ÿ±ÿµŸäÿØŸÉ ŸÑÿß ŸäŸÉŸÅŸä.");

                const success = await deductCredits(3);
                if (!success) return;

                setStatus('processing');
                setResultFile(null);
                setAccuracy(0);

                const logs = [
                    "ÿ™ÿ∑ÿ®ŸäŸÇ ŸÜŸÖŸàÿ∞ÿ¨ 'Aza-1447' ÿßŸÑŸÖÿ∑Ÿàÿ± ŸÑÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ•ŸäŸÇÿßÿπ ÿßŸÑÿ≠ÿ≥ŸäŸÜŸä...",
                    "ÿ®ÿØÿ° ÿπÿ≤ŸÑ ÿßŸÑÿ™ÿ±ÿØÿØÿßÿ™ ÿßŸÑÿµŸàÿ™Ÿäÿ© Ÿàÿ™ÿµŸÅŸäÿ© ÿßŸÑÿ∂ÿ¨Ÿäÿ¨ (Vocal Isolation)...",
                    "ÿ™ÿ≠ŸÑŸäŸÑ ŸÇŸÖŸÖ ÿßŸÑÿ∑ÿßŸÇÿ© ÿßŸÑÿµŸàÿ™Ÿäÿ© Ÿàÿ±ÿµÿØ 'ÿßŸÑŸÜÿ®ÿ±ÿßÿ™' (Onset Detection)...",
                    "ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ™ÿµŸÅŸäÿ© ÿßŸÑÿ±ŸÇŸÖŸäÿ© (Bandpass Filter: 300Hz-3.4kHz)...",
                    "ÿ±ÿ≥ŸÖ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ© ÿßŸÑÿ≤ŸÖŸÜŸäÿ© ŸÑŸÑŸÇÿµŸäÿØÿ© ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ŸÜŸÖÿ∑ 1447 ÿßŸÑÿßÿ≠ÿ™ÿ±ÿßŸÅŸä...",
                    "ŸÖÿ∑ÿßÿ®ŸÇÿ© ÿ£Ÿàÿ≤ÿßŸÜ ÿßŸÑŸÉŸÑŸÖÿßÿ™ ŸÖÿπ ÿ∞ÿ®ÿ∞ÿ®ÿßÿ™ ÿßŸÑÿ£ÿØÿßÿ° ÿßŸÑÿ≠ŸÇŸäŸÇŸä...",
                    "ŸÖÿπÿßŸÑÿ¨ÿ© ŸÅŸàÿßÿµŸÑ ÿßŸÑÿ™ŸÜŸÅÿ≥ ŸàÿßŸÑÿ≥ŸÉÿ™ÿßÿ™ ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖŸàÿ¨ÿßÿ™...",
                    "ÿßŸÑÿ™ÿØŸÇŸäŸÇ ÿßŸÑŸÜŸáÿßÿ¶Ÿä Ÿàÿ™ŸàŸÑŸäÿØ ŸÖŸÑŸÅ ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ÿßŸÑÿßÿ≠ÿ™ÿ±ÿßŸÅŸä v8..."
                ];
                const lines = poemText.split('\n').filter(l => l.trim() !== '');
                if (lines.length === 0) return alert("Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ŸÉŸÑŸÖÿßÿ™ ÿßŸÑŸÇÿµŸäÿØÿ©.");

                try {
                    setLog("ÿ¨ÿßÿ±Ÿä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ŸÖÿ≠ÿ±ŸÉ MENBAR Neural v20 (Cloud Sync)...");
                    setProgress(5);

                    // Step 1: Upload Audio to Backend
                    const formData = new FormData();
                    formData.append('file', audioFile);

                    const uploadRes = await fetch(`${BASE_API_URL}/upload`, {
                        method: 'POST',
                        body: formData
                    });

                    if (!uploadRes.ok) throw new Error("ŸÅÿ¥ŸÑ ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅ ÿ•ŸÑŸâ ÿßŸÑŸÖÿ≠ÿ±ŸÉ ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿä");
                    const uploadData = await uploadRes.json();
                    const filePath = uploadData.path;

                    setLog("ÿ™ŸÖ ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅ ÿ®ŸÜÿ¨ÿßÿ≠. ÿ¨ÿßÿ±Ÿä ÿ®ÿØÿ° ÿßŸÑŸÖÿ∑ÿßÿ®ŸÇÿ© ÿßŸÑÿπÿµÿ®Ÿäÿ©...");
                    setProgress(20);

                    // Step 2: Start SRT Sync Job
                    const syncFormData = new FormData();
                    syncFormData.append('audio_path', filePath);
                    syncFormData.append('lyrics', poemText);

                    const syncRes = await fetch(`${BASE_API_URL}/srt/sync`, {
                        method: 'POST',
                        body: syncFormData
                    });

                    if (!syncRes.ok) throw new Error("ŸÅÿ¥ŸÑ ÿ®ÿØÿ° ÿπŸÖŸÑŸäÿ© ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ©");
                    const { job_id } = await syncRes.json();

                    // Step 3: Polling for Status
                    let jobStatus = 'PENDING';
                    let pollCount = 0;
                    while (jobStatus !== 'SUCCESS' && jobStatus !== 'completed' && pollCount < 100) {
                        await new Promise(r => setTimeout(r, 2000));
                        const statusRes = await fetch(`${BASE_API_URL}/status/${job_id}`);
                        const statusData = await statusRes.json();
                        jobStatus = statusData.status;

                        if (jobStatus === 'SUCCESS' || jobStatus === 'completed') {
                            const result = statusData.result;
                            if (result.status === 'failed') throw new Error(result.error);

                            setLog("ÿßŸÉÿ™ŸÖŸÑÿ™ ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ÿßŸÑÿ¨ÿ±ÿßÿ≠Ÿäÿ© ÿ®ŸÜÿ¨ÿßÿ≠!");
                            setProgress(100);

                            const srtBlob = new Blob([result.srt_content], { type: 'text/plain;charset=utf-8' });
                            const srtUrl = URL.createObjectURL(srtBlob);
                            setResultFile(srtUrl);
                            setAccuracy(100);

                            addHistoryItem({
                                type: 'srt',
                                name: `ŸÖÿ≤ÿßŸÖŸÜÿ© v20 Cloud: ${audioFile.name}`,
                                status: 'completed',
                                url: srtUrl,
                                date: new Date().toLocaleDateString('en-GB')
                            });
                            setStatus('success');
                            return;
                        }

                        pollCount++;
                        setProgress(Math.min(20 + (pollCount * 0.8), 95));
                        setLog(`ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖŸàÿ¨ÿßÿ™ ÿßŸÑÿµŸàÿ™Ÿäÿ© ŸàŸÖÿ∑ÿßÿ®ŸÇÿ™Ÿáÿß... (ÿÆÿ∑Ÿàÿ© ${pollCount})`);
                    }

                    throw new Error("ÿßÿ≥ÿ™ÿ∫ÿ±ŸÇÿ™ ÿßŸÑÿπŸÖŸÑŸäÿ© ŸàŸÇÿ™ÿßŸã ÿ£ÿ∑ŸàŸÑ ŸÖŸÜ ÿßŸÑŸÖÿ™ŸàŸÇÿπ.");

                } catch (e) {
                    console.error("Backend Sync Error, falling back to v19 LOCAL", e);
                    setLog("ÿßŸÑŸÖÿ≠ÿ±ŸÉ ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿä ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ± ÿ≠ÿßŸÑŸäÿßŸã. ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÖÿ≠ÿ±ŸÉ ÿßŸÑŸÖÿ≠ŸÑŸä v19 (Local Hybrid)...");

                    // FALLBACK TO V19 LOCAL LOGIC
                    try {
                        const audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
                        const arrayBuffer = await audioFile.arrayBuffer();
                        const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
                        const rawData = audioBuffer.getChannelData(0);

                        // --- Phase 1: Vocal Onset Detection ---
                        const winSize = Math.floor(16000 * 0.05);
                        const energyMap = [];
                        for (let i = 0; i < rawData.length; i += winSize) {
                            let sum = 0;
                            for (let j = 0; j < winSize && (i + j) < rawData.length; j++) {
                                sum += Math.abs(rawData[i + j]);
                            }
                            energyMap.push(sum / winSize);
                        }

                        const onsets = [];
                        const threshold = energyMap.reduce((a, b) => a + b, 0) / energyMap.length * 1.8;
                        for (let t = 1; t < energyMap.length - 1; t++) {
                            if (energyMap[t] > threshold && energyMap[t] > energyMap[t - 1] && energyMap[t] > energyMap[t + 1]) {
                                onsets.push(t * 0.05);
                            }
                        }

                        const allWords = [];
                        lines.forEach((line, lIdx) => {
                            const words = line.trim().split(/\s+/);
                            words.forEach(w => allWords.push({ text: w, lineIdx: lIdx }));
                        });

                        const timedWords = [];
                        allWords.forEach((word, idx) => {
                            const onsetIdx = Math.floor((idx / allWords.length) * onsets.length);
                            const startT = onsets[onsetIdx] || (idx * (audioBuffer.duration / allWords.length));
                            const nextStartT = onsets[onsetIdx + 1] || (startT + 1.2);
                            timedWords.push({ ...word, startT, endT: nextStartT });
                        });

                        let srtOutput = "";
                        let currentSRTIdx = 1;
                        lines.forEach((line, lIdx) => {
                            const lineWords = timedWords.filter(tw => tw.lineIdx === lIdx);
                            if (lineWords.length === 0) return;
                            const lineStart = lineWords[0].startT;
                            const lineEnd = lineWords[lineWords.length - 1].endT;
                            const toSRT = (sec) => {
                                const d = new Date(0); d.setSeconds(sec);
                                const ms = Math.floor((sec % 1) * 1000);
                                return d.toISOString().substr(11, 8) + ',' + ms.toString().padStart(3, '0');
                            };
                            srtOutput += `${currentSRTIdx++}\n${toSRT(lineStart)} --> ${toSRT(lineEnd)}\n${line.trim()}\n\n`;
                        });

                        const blob = new Blob([srtOutput], { type: 'text/plain;charset=utf-8' });
                        const srtUrl = URL.createObjectURL(blob);
                        setResultFile(srtUrl);
                        setAccuracy(92);
                        setProgress(100);
                        addHistoryItem({
                            type: 'srt',
                            name: `ŸÖÿ≤ÿßŸÖŸÜÿ© v19 Local (Fallback): ${audioFile.name}`,
                            status: 'completed',
                            url: srtUrl,
                            date: new Date().toLocaleDateString('en-GB')
                        });
                        setStatus('success');
                        audioCtx.close();
                    } catch (localErr) {
                        alert("ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÇÿπ: " + localErr.message);
                        setStatus('input');
                    }
                }
            };

            if (loading || !user) return null;

            return (
                <div className="container animate-fade-in" style={{ padding: '20px', maxWidth: '1200px' }}>
                    <div style={{ display: 'flex', gap: '20px', alignItems: 'center', marginBottom: '30px' }}>
                        <BackButton />
                        <h2 style={{ margin: 0 }}>üìú {t('tools_srt')}</h2>
                    </div>

                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(350px, 1fr))', gap: '30px' }}>
                        {/* Column 1: Settings */}
                        <div className="card" style={{ padding: '25px', display: 'flex', flexDirection: 'column', gap: '20px' }}>
                            <h3 style={{ display: 'flex', alignItems: 'center', gap: '10px', color: 'var(--primary)' }}>‚öôÔ∏è {t('mix_settings_title')}</h3>

                            <div className="form-group">
                                <label style={{ display: 'block', marginBottom: '10px', fontWeight: 'bold', fontSize: '0.9rem' }}>1. ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿµŸàÿ™Ÿä (ÿßŸÑÿ£ŸÇÿµŸâ 24 ÿØŸÇŸäŸÇÿ© / 30GB)</label>
                                <div
                                    className="card"
                                    style={{ padding: '20px', border: '2px dashed var(--border)', textAlign: 'center', background: 'rgba(255,255,255,0.02)', cursor: 'pointer', transition: '0.3s' }}
                                    onClick={() => document.getElementById('srt-upload-v4').click()}
                                >
                                    <input type="file" onChange={handleFileChange} accept="audio/*,audio/mpeg,.mpeg" style={{ display: 'none' }} id="srt-upload-v4" />
                                    <div style={{ fontSize: '1.5rem', marginBottom: '10px' }}>üéôÔ∏è</div>
                                    <div style={{ fontSize: '0.9rem' }}>{audioFile ? audioFile.name : "ÿßÿ∂ÿ∫ÿ∑ ŸÑÿ±ŸÅÿπ ÿ™ÿ±ÿßŸÉ ÿßŸÑŸÇÿµŸäÿØÿ©"}</div>
                                    <div style={{ fontSize: '0.75rem', color: 'var(--text-secondary)', marginTop: '5px' }}>{audioDuration > 0 ? `ŸÖÿØÿ© ÿßŸÑŸÖŸÑŸÅ: ${formatTime(audioDuration)}` : 'MP3, WAV, MPEG (ÿ®ÿ≠ÿØ ÿ£ŸÇÿµŸâ 24 ÿØŸÇŸäŸÇÿ©)'}</div>
                                </div>
                            </div>

                            <div className="form-group">
                                <label style={{ display: 'block', marginBottom: '10px', fontWeight: 'bold', fontSize: '0.9rem' }}>2. ŸÜÿµ ÿßŸÑŸÇÿµŸäÿØÿ© ÿßŸÑŸÉÿßŸÖŸÑ</label>
                                <textarea
                                    value={poemText}
                                    onChange={(e) => setPoemText(e.target.value)}
                                    placeholder="ÿ£ÿØÿÆŸÑ ŸÉŸÑŸÖÿßÿ™ ÿßŸÑŸÇÿµŸäÿØÿ© ŸáŸÜÿß..."
                                    className="input-field"
                                    style={{ width: '100%', height: '140px', resize: 'vertical', fontSize: '0.9rem' }}
                                />
                            </div>

                            <div style={{ textAlign: 'center', padding: '15px', background: 'rgba(212, 175, 55, 0.05)', borderRadius: '12px' }}>
                                <div style={{ fontSize: '0.9rem', marginBottom: '5px' }}>ÿ™ŸÉŸÑŸÅÿ© ÿßŸÑÿ™ÿ±ÿ¨ŸÖÿ© ŸàÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ©:</div>
                                <div className="badge" style={{ fontSize: '1.2rem', padding: '8px 25px' }}>3 {t('credits')} ü™ô</div>
                            </div>

                            <button
                                onClick={processSRT}
                                className="btn btn-primary"
                                style={{ width: '100%', padding: '15px', fontSize: '1.1rem' }}
                                disabled={!audioFile || !poemText || status === 'processing'}
                            >
                                {status === 'processing' ? '‚è≥ ÿ¨ÿßÿ±Ÿä ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ©...' : 'üöÄ ÿßÿ®ÿØÿ£ ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ÿßŸÑÿ¢ŸÜ'}
                            </button>
                        </div>

                        {/* Column 2: Result / Preview */}
                        <div className="card" style={{ padding: '25px', display: 'flex', flexDirection: 'column', minHeight: '400px', justifyContent: 'center', alignItems: 'center' }}>
                            {status === 'input' && audioUrl && (
                                <div style={{ width: '100%', textAlign: 'center' }}>
                                    <div style={{ fontSize: '3rem', marginBottom: '20px' }}>üéß</div>
                                    <h3 style={{ marginBottom: '15px' }}>ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑŸÖŸÇÿ∑ÿπ ÿßŸÑÿµŸàÿ™Ÿä</h3>
                                    <audio controls src={audioUrl} style={{ width: '100%', marginBottom: '20px' }} />
                                    <div className="badge" style={{ background: 'rgba(76, 175, 80, 0.1)', color: '#4caf50', border: '1px solid #4caf50' }}>
                                        ‚úì ÿßŸÑŸÖŸÑŸÅ ÿµÿßŸÑÿ≠ ({formatTime(audioDuration)})
                                    </div>
                                    <button onClick={() => { setAudioFile(null); setAudioUrl(null); }} className="btn btn-outline" style={{ marginTop: '20px', width: '100%' }}>ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸÖŸÑŸÅ</button>
                                </div>
                            )}

                            {status === 'input' && !audioUrl && (
                                <div style={{ textAlign: 'center', opacity: 0.5 }}>
                                    <div style={{ fontSize: '5rem', marginBottom: '20px' }}>üìú</div>
                                    <h3>ÿ®ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑŸÖŸÑŸÅ...</h3>
                                    <p style={{ fontSize: '0.9rem' }}>ÿßÿ±ŸÅÿπ ŸÖŸÑŸÅ ÿßŸÑŸÇÿµŸäÿØÿ© ŸÑÿ®ÿØÿ° ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ©</p>
                                </div>
                            )}

                            {status === 'processing' && (
                                <div style={{ width: '100%', textAlign: 'center' }}>
                                    <h3 style={{ marginBottom: '30px' }}>ÿ¨ÿßÿ±Ÿä ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ© ŸàÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿäÿ©...</h3>
                                    <div style={{ width: '100%', height: '10px', background: 'var(--surface)', borderRadius: '5px', overflow: 'hidden', marginBottom: '20px', border: '1px solid var(--border)' }}>
                                        <div style={{ width: `${progress}%`, height: '100%', background: 'linear-gradient(90deg, var(--primary) 0%, var(--primary-hover) 100%)', transition: 'width 0.4s ease' }}></div>
                                    </div>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '0.9rem', color: 'var(--text-secondary)' }}>
                                        <span>{log}</span>
                                        <span style={{ color: 'var(--primary)', fontWeight: 'bold' }}>{progress}%</span>
                                    </div>
                                    <p style={{ fontSize: '0.8rem', marginTop: '20px', opacity: 0.6 }}>Ÿäÿ™ŸÖ ÿßŸÑÿ¢ŸÜ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿÆŸàÿßÿ±ÿ≤ŸÖŸäÿßÿ™ ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä ŸÑŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ÿßŸÑÿØŸÇŸäŸÇÿ©</p>
                                </div>
                            )}

                            {status === 'success' && (
                                <div className="animate-fade-in" style={{ textAlign: 'center', width: '100%' }}>
                                    <div style={{ width: '80px', height: '80px', background: 'var(--success)', borderRadius: '50%', display: 'flex', alignItems: 'center', justifyContent: 'center', margin: '0 auto 20px', fontSize: '2.5rem' }}>‚úÖ</div>
                                    <h2 style={{ color: 'var(--success)', marginBottom: '5px' }}>ÿ™ŸÖÿ™ ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ÿ®ŸÜÿ¨ÿßÿ≠!</h2>

                                    <div className="card" style={{ padding: '15px', background: 'rgba(76, 175, 80, 0.05)', border: '1px solid var(--success)', borderRadius: '12px', marginBottom: '25px', width: '100%' }}>
                                        <div style={{ fontSize: '0.85rem', color: 'var(--text-secondary)' }}>ŸÜÿ≥ÿ®ÿ© ÿ™ÿ∑ÿßÿ®ŸÇ ÿßŸÑŸÜÿµ ŸÖÿπ ÿßŸÑÿµŸàÿ™:</div>
                                        <div style={{ fontSize: '1.8rem', fontWeight: 'bold', color: 'var(--success)' }}>{accuracy}%</div>
                                        <div style={{ fontSize: '0.7rem', opacity: 0.7, marginTop: '5px' }}>ÿ™ŸÖ ÿ™ÿ≠ŸÑŸäŸÑ {poemText.split('\n').filter(l => l.trim() !== '').length} ÿ£ÿ®Ÿäÿßÿ™ ÿ¥ÿπÿ±Ÿäÿ©</div>
                                    </div>

                                    <div style={{ display: 'flex', gap: '15px', justifyContent: 'center', width: '100%' }}>
                                        <a href={resultFile} download={`${audioFile?.name || 'poem'}.srt`} className="btn btn-primary" style={{ flex: 1 }}>‚¨áÔ∏è ÿ™ÿ≠ŸÖŸäŸÑ SRT</a>
                                        <button onClick={() => { setStatus('input'); setAudioFile(null); setAudioUrl(null); setPoemText(''); }} className="btn btn-outline" style={{ flex: 1 }}>ÿπŸÖŸÑ ÿ¨ÿØŸäÿØ</button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        function MontagePage() {
            const { user, deductCredits, addHistoryItem, loading, t } = useAuth();
            const { push } = useRouter();

            const [style, setStyle] = useState('internal');
            const [audioFile, setAudioFile] = useState(null);
            const [videoFiles, setVideoFiles] = useState([null, null, null]);
            const [poemText, setPoemText] = useState('');

            const [status, setStatus] = useState('selection'); // New initial state
            const [progress, setProgress] = useState(0);
            const [log, setLog] = useState('');
            const [resultUrl, setResultUrl] = useState(null);

            useEffect(() => {
                if (!loading && !user) push('/login');
            }, [user, loading, push]);

            const handleAddCamera = () => {
                if (videoFiles.length < 9) setVideoFiles([...videoFiles, null]);
            };

            const handleVideoChange = (index, file) => {
                const newFiles = [...videoFiles];
                newFiles[index] = file;
                setVideoFiles(newFiles);
            };

            const handleRemoveCamera = (index) => {
                if (index === 0) {
                    alert("ŸÑÿß ŸäŸÖŸÉŸÜ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©ÿå ŸäŸÖŸÉŸÜŸÉ ŸÅŸÇÿ∑ ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸÖŸÑŸÅ.");
                    return;
                }
                if (videoFiles.length <= 3) {
                    alert("Ÿäÿ¨ÿ® ÿ™ŸàŸÅÿ± 3 ŸÉÿßŸÖŸäÿ±ÿßÿ™ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ");
                    return;
                }
                const newFiles = [...videoFiles];
                newFiles.splice(index, 1);
                setVideoFiles(newFiles);
            };

            const processMontage = async () => {
                const validVideos = videoFiles.filter(v => v !== null);
                if (!audioFile || validVideos.length < 3 || !poemText.trim()) {
                    return alert("Ÿäÿ±ÿ¨Ÿâ ÿ±ŸÅÿπ ŸÖŸÑŸÅ ÿßŸÑÿµŸàÿ™ Ÿà3 ŸÉÿßŸÖŸäÿ±ÿßÿ™ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ Ÿàÿ•ÿØÿÆÿßŸÑ ÿßŸÑŸÉŸÑŸÖÿßÿ™");
                }
                if (user.credits < 8) return alert("ÿπÿ∞ÿ±ÿßŸãÿå ÿ™ÿ≠ÿ™ÿßÿ¨ 8 ŸÉÿ±ŸäÿØŸäÿ™ ŸÑŸáÿ∞Ÿá ÿßŸÑÿπŸÖŸÑŸäÿ© ÿßŸÑŸÜŸàÿπŸäÿ©.");

                const success = await deductCredits(8);
                if (!success) return;

                setStatus('processing');
                setLog("ÿ¨ÿßÿ±Ÿä ÿ±ŸÅÿπ ÿßŸÑÿ£ÿµŸàŸÑ Ÿàÿ™ÿ¨ŸáŸäÿ≤ ÿ∫ÿ±ŸÅÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ...");
                setProgress(10);

                try {
                    // 1. Upload Master Audio
                    const audioForm = new FormData();
                    audioForm.append('file', audioFile);
                    const aRes = await fetch(`${BASE_API_URL}/upload`, { method: 'POST', body: audioForm });
                    const aData = await aRes.json();

                    setLog("ÿ™ŸÖ ÿ±ŸÅÿπ ÿßŸÑÿµŸàÿ™ ÿ®ŸÜÿ¨ÿßÿ≠. ÿ¨ÿßÿ±Ÿä ÿ±ŸÅÿπ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿßÿ™ (ŸÇÿØ Ÿäÿ≥ÿ™ÿ∫ÿ±ŸÇ ŸàŸÇÿ™ÿßŸã)...");
                    setProgress(30);

                    // 2. Upload Video Cameras
                    const videoPaths = [];
                    for (let i = 0; i < validVideos.length; i++) {
                        const vForm = new FormData();
                        vForm.append('file', validVideos[i]);
                        const vRes = await fetch(`${BASE_API_URL}/upload`, { method: 'POST', body: vForm });
                        const vData = await vRes.json();
                        videoPaths.push(vData.path);
                        setProgress(30 + ((i + 1) / validVideos.length * 40));
                        setLog(`ÿ™ŸÖ ÿ±ŸÅÿπ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß ${i + 1} ŸÖŸÜ ${validVideos.length}...`);
                    }

                    // 3. Start AI Director Job
                    setLog("ÿ¨ÿßÿ±Ÿä ÿßÿ≥ÿ™ÿÆŸÑÿßÿµ ÿßŸÑŸÜÿ®ÿ∂ÿßÿ™ ÿßŸÑÿ•ŸäŸÇÿßÿπŸäÿ© Ÿàÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿßÿ™...");
                    const montageForm = new FormData();
                    montageForm.append('audio_path', aData.path);
                    montageForm.append('video_paths', JSON.stringify(videoPaths));
                    montageForm.append('lyrics', poemText);
                    montageForm.append('style', style);

                    const mRes = await fetch(`${BASE_API_URL}/montage/start`, { method: 'POST', body: montageForm });
                    const { job_id } = await mRes.json();

                    // 4. Polling
                    let jobStatus = 'PENDING';
                    while (jobStatus !== 'SUCCESS' && jobStatus !== 'completed' && jobStatus !== 'failed') {
                        await new Promise(r => setTimeout(r, 2000));
                        const statusRes = await fetch(`${BASE_API_URL}/status/${job_id}`);
                        const statusData = await statusRes.json();
                        jobStatus = statusData.status;

                        // Update UI with backend progress
                        if (statusData.progress) {
                            // Map backend (0-100) to UI (70-100) scale
                            const backendProgress = statusData.progress;
                            const uiProgress = 70 + (backendProgress * 0.3);
                            setProgress(Math.floor(uiProgress));

                            if (statusData.status === 'processing') {
                                setLog(statusData.result?.message || "ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä ŸäŸÇŸàŸÖ ÿ®ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÜŸáÿßÿ¶Ÿä...");
                            }
                        }

                        if (jobStatus === 'failed') {
                            throw new Error(statusData.result?.error || "ŸÅÿ¥ŸÑÿ™ ÿπŸÖŸÑŸäÿ© ÿßŸÑŸÖŸàŸÜÿ™ÿßÿ¨");
                        }

                        if (jobStatus === 'SUCCESS' || jobStatus === 'completed') {
                            setResultUrl(`${BASE_API_URL}${statusData.result.output_url}`);
                            setLog("ÿßŸÉÿ™ŸÖŸÑ ÿßŸÑÿ•ÿÆÿ±ÿßÿ¨ ÿßŸÑÿ¢ŸÑŸä ÿ®ŸÜÿ¨ÿßÿ≠!");
                            setProgress(100);
                            addHistoryItem({
                                type: 'video',
                                name: `ŸÖŸàŸÜÿ™ÿßÿ¨ ${style}: ${audioFile.name}`,
                                status: 'completed',
                                url: `${BASE_API_URL}${statusData.result.output_url}`,
                                date: new Date().toLocaleDateString('en-GB')
                            });
                            setStatus('success');
                            return;
                        }
                    }
                } catch (e) {
                    alert("ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£: " + e.message);
                    setStatus('input');
                }
            };

            if (loading || !user) return null;

            return (
                <div className="container animate-fade-in" style={{ padding: '20px', maxWidth: '1100px' }}>
                    <div style={{ display: 'flex', gap: '20px', alignItems: 'center', marginBottom: '30px' }}>
                        <BackButton />
                        <h2 style={{ margin: 0 }}>üé¨ {t('tools_montage')} (AI Director)</h2>
                    </div>

                    {status === 'selection' && (
                        <div style={{ width: '100%', maxWidth: '600px', margin: '0 auto', textAlign: 'center' }}>
                            <h3 style={{ marginBottom: '30px' }}>ÿßÿÆÿ™ÿ± ÿ£ÿ≥ŸÑŸàÿ® ÿßŸÑŸÖŸàŸÜÿ™ÿßÿ¨</h3>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>
                                <div
                                    className="card"
                                    onClick={() => { setStyle('internal'); setStatus('input'); }}
                                    style={{ padding: '30px', cursor: 'pointer', border: '2px solid transparent', transition: 'all 0.3s', background: 'rgba(255,255,255,0.03)' }}
                                    onMouseEnter={(e) => e.currentTarget.style.borderColor = 'var(--primary)'}
                                    onMouseLeave={(e) => e.currentTarget.style.borderColor = 'transparent'}
                                >
                                    <h3>ŸÖŸàŸÜÿ™ÿßÿ¨ ÿØÿßÿÆŸÑŸä</h3>
                                    <p style={{ fontSize: '0.9rem', color: 'var(--text-secondary)' }}>ÿ™ÿ®ÿØŸäŸÑÿßÿ™ ÿ≥ÿ±Ÿäÿπÿ©ÿå ÿ™ÿ±ŸÉŸäÿ≤ ÿπŸÑŸâ ÿßŸÑŸÖÿ¥ÿßÿπÿ± ŸàÿßŸÑŸÑŸÇÿ∑ÿßÿ™ ÿßŸÑŸÇÿ±Ÿäÿ®ÿ©</p>
                                </div>
                                <div
                                    className="card"
                                    onClick={() => { setStyle('external'); setStatus('input'); }}
                                    style={{ padding: '30px', cursor: 'pointer', border: '2px solid transparent', transition: 'all 0.3s', background: 'rgba(255,255,255,0.03)' }}
                                    onMouseEnter={(e) => e.currentTarget.style.borderColor = 'var(--primary)'}
                                    onMouseLeave={(e) => e.currentTarget.style.borderColor = 'transparent'}
                                >
                                    <h3>ŸÖŸàŸÜÿ™ÿßÿ¨ ÿÆÿßÿ±ÿ¨Ÿä</h3>
                                    <p style={{ fontSize: '0.9rem', color: 'var(--text-secondary)' }}>ŸÑŸÇÿ∑ÿßÿ™ ÿ£Ÿàÿ≥ÿπÿå ŸáÿØŸàÿ° ŸÅŸä ÿßŸÑÿßŸÜÿ™ŸÇÿßŸÑÿßÿ™ÿå ŸÖŸÜÿßÿ≥ÿ® ŸÑŸÑŸÖÿ¨ÿßŸÑÿ≥ ÿßŸÑŸÉÿ®Ÿäÿ±ÿ©</p>
                                </div>
                            </div>
                            <div className="badge" style={{ marginTop: '30px', padding: '10px 30px', fontSize: '1.1rem' }}>ÿßŸÑÿ™ŸÉŸÑŸÅÿ©: 8 ŸÉÿ±ŸäÿØŸäÿ™ ü™ô</div>
                        </div>
                    )}

                    {status === 'input' && (
                        <div style={{ display: 'grid', gridTemplateColumns: 'minmax(400px, 1fr) 300px', gap: '30px', width: '100%' }}>
                            {/* Left Side: Inputs */}
                            <div className="card" style={{ padding: '25px', textAlign: 'right', direction: 'rtl' }}>
                                <div style={{ marginBottom: '20px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                    <h3 style={{ margin: 0 }}>ÿ™ÿ¨ŸáŸäÿ≤ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ({style === 'internal' ? 'ÿØÿßÿÆŸÑŸä' : 'ÿÆÿßÿ±ÿ¨Ÿä'})</h3>
                                    <button onClick={() => setStatus('selection')} className="btn btn-outline" style={{ padding: '5px 15px', fontSize: '0.8rem' }}>ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸÜŸÖÿ∑</button>
                                </div>

                                <div className="form-group" style={{ marginBottom: '20px' }}>
                                    <label style={{ fontWeight: 'bold' }}>1. ÿµŸàÿ™ ÿßŸÑŸÇÿµŸäÿØÿ© (Master Audio)</label>
                                    <input type="file" onChange={(e) => setAudioFile(e.target.files[0])} accept="audio/*" className="input-field" style={{ width: '100%', marginTop: '5px' }} />
                                    <small style={{ color: 'var(--text-secondary)' }}>ÿßŸÑÿ£ŸÇÿµŸâ: 30MB / 24 ÿØŸÇŸäŸÇÿ©</small>
                                </div>

                                <div className="form-group" style={{ marginBottom: '20px' }}>
                                    <label style={{ fontWeight: 'bold' }}>2. ÿßŸÑŸÉÿßŸÖŸäÿ±ÿßÿ™ (3 ÿ•ŸÑŸâ 9 ŸÉÿßŸÖŸäÿ±ÿßÿ™)</label>
                                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(100px, 1fr))', gap: '10px', marginTop: '10px' }}>
                                        {videoFiles.map((v, i) => {
                                            const isMain = i === 0;
                                            const isDisabled = i > 0 && !videoFiles[0];
                                            return (
                                                <div
                                                    key={i}
                                                    className="card"
                                                    style={{
                                                        padding: '10px',
                                                        textAlign: 'center',
                                                        minHeight: '80px',
                                                        display: 'flex',
                                                        flexDirection: 'column',
                                                        justifyContent: 'center',
                                                        cursor: isDisabled ? 'not-allowed' : 'pointer',
                                                        border: v ? '1px solid var(--success)' : (isMain ? '1px solid var(--primary)' : '1px dashed var(--border)'),
                                                        position: 'relative',
                                                        opacity: isDisabled ? 0.5 : 1
                                                    }}
                                                    onClick={() => !isDisabled && document.getElementById(`vid-${i}`).click()}
                                                >
                                                    <input id={`vid-${i}`} type="file" onChange={(e) => handleVideoChange(i, e.target.files[0])} accept="video/*" style={{ display: 'none' }} disabled={isDisabled} />

                                                    {/* Delete/Clear Button */}
                                                    {(!isMain || v) && (
                                                        <button
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                                if (isMain) {
                                                                    const newFiles = [...videoFiles];
                                                                    newFiles[0] = null;
                                                                    setVideoFiles(newFiles);
                                                                } else {
                                                                    handleRemoveCamera(i);
                                                                }
                                                            }}
                                                            style={{ position: 'absolute', top: '5px', left: '5px', background: 'rgba(255,0,0,0.1)', color: 'red', border: 'none', borderRadius: '50%', width: '20px', height: '20px', fontSize: '12px', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center' }}
                                                            title={isMain ? "ŸÖÿ≥ÿ≠ ÿßŸÑŸÖŸÑŸÅ" : "ÿ≠ÿ∞ŸÅ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß"}
                                                        >
                                                            √ó
                                                        </button>
                                                    )}

                                                    <div style={{ fontSize: '1.2rem' }}>{v ? '‚úÖ' : (isMain ? '‚≠ê' : 'üì∑')}</div>
                                                    <div style={{ fontSize: '0.7rem', fontWeight: isMain ? 'bold' : 'normal' }}>
                                                        {isMain ? 'ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©' : `ŸÉÿßŸÖŸäÿ±ÿß ${i + 1}`}
                                                    </div>
                                                    {v && <div style={{ fontSize: '0.6rem', color: 'var(--text-secondary)' }}>{v.name.substring(0, 8)}...</div>}
                                                </div>
                                            );
                                        })}
                                        {videoFiles.length < 9 && (
                                            <div className="card" onClick={handleAddCamera} style={{ padding: '10px', textAlign: 'center', minHeight: '80px', display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer', border: '1px dashed var(--primary)', color: 'var(--primary)' }}>
                                                Ôºã
                                            </div>
                                        )}
                                    </div>
                                </div>

                                <div className="form-group" style={{ marginBottom: '20px' }}>
                                    <label style={{ fontWeight: 'bold' }}>3. ÿßŸÑŸÉŸÑŸÖÿßÿ™</label>
                                    <textarea value={poemText} onChange={(e) => setPoemText(e.target.value)} placeholder="ÿ£ÿØÿÆŸÑ ÿßŸÑŸÉŸÑŸÖÿßÿ™ ŸáŸÜÿß..." className="input-field" style={{ width: '100%', height: '80px', marginTop: '5px' }} />
                                </div>

                                <button onClick={processMontage} className="btn btn-primary" style={{ width: '100%', padding: '15px' }}>üé¨ ÿßÿ®ÿØÿ£ ÿßŸÑÿ•ŸÜÿ™ÿßÿ¨</button>
                            </div>

                            {/* Right Side: Info */}
                            <div className="card" style={{ padding: '25px', display: 'flex', flexDirection: 'column', justifyContent: 'center', alignItems: 'center' }}>
                                <div style={{ fontSize: '4rem', marginBottom: '20px' }}>ü§ñ</div>
                                <h4>ÿßŸÑŸÖÿÆÿ±ÿ¨ ÿßŸÑÿ∞ŸÉŸä</h4>
                                <p style={{ color: 'var(--text-secondary)', fontSize: '0.9rem' }}>ÿ≥ŸäŸÇŸàŸÖ ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä ÿ®ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ•ŸäŸÇÿßÿπ ŸàÿßŸÑÿ™ÿ®ÿØŸäŸÑ ÿ®ŸäŸÜ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿßÿ™ ÿ¢ŸÑŸäÿßŸã Ÿàÿ®ŸÜÿßÿ° ŸÖŸÑŸÅ XML ŸÑŸÑÿ®ÿ±ŸäŸÖŸäÿ±.</p>
                                <div className="badge" style={{ marginTop: '20px' }}>8 ŸÉÿ±ŸäÿØŸäÿ™ ü™ô</div>
                            </div>
                        </div>
                    )}

                    {status === 'processing' && (
                        <div style={{ width: '100%', textAlign: 'center', padding: '40px 0' }}>
                            <div className="animate-pulse" style={{ fontSize: '5rem', marginBottom: '30px' }}>ü§ñ</div>
                            <h3 style={{ marginBottom: '10px' }}>ÿ¨ÿßÿ±Ÿä ÿßŸÑÿπŸÖŸÑ ŸÅŸä ŸÖÿÆÿ™ÿ®ÿ±ÿßÿ™ ŸÖŸêŸÄŸÜŸÄÿ®ŸéŸÄÿ±...</h3>
                            <p style={{ color: 'var(--text-secondary)', marginBottom: '10px', minHeight: '1.5em' }}>
                                {progress < 30 ? "Ÿäÿ™ŸÖ ÿßŸÑÿ¢ŸÜ ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ŸÑŸÑÿ≥ÿ≠ÿßÿ® ÿ®ÿ¢ŸÖÿßŸÜ..." :
                                    progress < 50 ? "ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä Ÿäÿ≠ŸÑŸÑ ÿßŸÑÿ•ŸäŸÇÿßÿπ ŸàÿßŸÑŸÜÿ®ÿ±ÿßÿ™ ÿßŸÑÿµŸàÿ™Ÿäÿ©..." :
                                        progress < 80 ? "ÿ¨ÿßÿ±Ÿä ÿßŸÑŸÖÿ∑ÿßÿ®ŸÇÿ© ÿßŸÑÿ≤ŸÖŸÜŸäÿ© ÿßŸÑÿØŸÇŸäŸÇÿ© (Ÿáÿ∞Ÿá ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ© ÿ™ÿ£ÿÆÿ∞ ŸàŸÇÿ™ÿßŸã ŸÑÿ∂ŸÖÿßŸÜ ÿßŸÑÿØŸÇÿ©)..." :
                                            progress < 95 ? "Ÿäÿ™ŸÖ ÿßŸÑÿ¢ŸÜ ÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿßÿ™ Ÿàÿ®ŸÜÿßÿ° ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ≤ŸÖŸÜ (Timeline)..." :
                                                "ÿ´ŸàÿßŸÜŸä ŸÖÿπÿØŸàÿØÿ© ŸàŸäÿµÿ®ÿ≠ ŸÖÿ¥ÿ±ŸàÿπŸÉ ÿ¨ÿßŸáÿ≤ÿßŸã..."}
                            </p>
                            <p style={{ color: 'var(--text-secondary)', fontSize: '0.85rem', marginBottom: '30px', opacity: 0.7 }}>
                                ‚ö†Ô∏è ŸÇÿØ ÿ™ÿ≥ÿ™ÿ∫ÿ±ŸÇ Ÿáÿ∞Ÿá ÿßŸÑÿπŸÖŸÑŸäÿ© ŸÖÿß ŸäÿµŸÑ ÿ•ŸÑŸâ ÿ≥ÿßÿπÿ© ŸÉÿßŸÖŸÑÿ© ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿ≠ÿ¨ŸÖ ÿßŸÑŸÖŸÑŸÅÿßÿ™ÿå Ÿäÿ±ÿ¨Ÿâ ÿπÿØŸÖ ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑÿµŸÅÿ≠ÿ©.
                            </p>

                            <div style={{ width: '100%', maxWidth: '600px', margin: '0 auto' }}>
                                <div style={{ width: '100%', height: '12px', background: 'var(--surface)', borderRadius: '6px', margin: '20px 0', overflow: 'hidden', border: '1px solid var(--border)' }}>
                                    <div style={{ width: `${progress}%`, height: '100%', background: 'linear-gradient(90deg, var(--primary-dim), var(--primary))', transition: '0.5s', borderRadius: '6px' }} />
                                </div>
                                <div style={{ fontSize: '1.5rem', color: 'var(--primary)', fontWeight: 'bold', marginBottom: '10px' }}>{progress}%</div>
                                <div className="badge" style={{ background: 'rgba(0, 74, 173, 0.1)', color: 'var(--primary)', border: '1px solid var(--primary-dim)' }}>
                                    {log || "ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿä..."}
                                </div>
                            </div>
                        </div>
                    )}

                    {status === 'success' && (
                        <div className="animate-fade-in">
                            <div style={{ fontSize: '4rem', marginBottom: '15px' }}>üé¨</div>
                            <h2 style={{ color: 'var(--success)' }}>ÿßŸÉÿ™ŸÖŸÑ ÿßŸÑÿ•ŸÜÿ™ÿßÿ¨ ÿßŸÑÿ¢ŸÑŸä!</h2>
                            <p style={{ marginBottom: '25px' }}>ÿ™ŸÖ ÿ™ŸàŸÑŸäÿØ ŸÖÿ¥ÿ±Ÿàÿπ ÿ®ÿ±ŸäŸÖŸäÿ± (XML) ÿ¨ÿßŸáÿ≤ ŸÑŸÑÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ŸÖÿπ ŸÉŸÑ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿßÿ™ ŸÖÿ±ÿ™ÿ®ÿ©.</p>
                            <a href={resultUrl} className="btn btn-primary" style={{ width: '100%', marginBottom: '10px' }}>‚¨áÔ∏è ÿ™ÿ≠ŸÖŸäŸÑ ŸÖÿ¥ÿ±Ÿàÿπ XML</a>
                            <button onClick={() => setStatus('input')} className="btn btn-outline" style={{ width: '100%' }}>ÿπŸÖŸÑ ÿ¨ÿØŸäÿØ</button>
                        </div>
                    )}
                </div>
            );
        }

        const GEMINI_API_KEY = 'AIzaSyDNqg17wNBPdQr3vOW-VJORPY_0AFhxUW0';

        function AdsPage() {
            const { user, deductCredits, addHistoryItem, t } = useAuth();
            const { push } = useRouter();
            const [status, setStatus] = useState('category'); // category, template, form, processing, result
            const [data, setData] = useState({
                type: 'mowalid',
                eventName: '',
                speakers: [''],
                day: '',
                nightOfText: '',
                date: '',
                dateType: 'hijri',
                time: '',
                location: '',
                procession: '',
                photos: [null],
                logo: null,
                userPrompt: '',
                selectedTemplate: null,
                customProto: null // New: User-provided reference image
            });
            const [result, setResult] = useState(null);
            const [generating, setGenerating] = useState(false);
            const [aiPrompt, setAiPrompt] = useState('');

            const prototypes = {
                mowalid: [
                    'prototypes/ŸÖŸàŸÑÿØ/Screenshot 2026-01-27 130331.png', 'prototypes/ŸÖŸàŸÑÿØ/Screenshot 2026-01-27 130843.png', 'prototypes/ŸÖŸàŸÑÿØ/Screenshot 2026-01-27 130903.png',
                    'prototypes/ŸÖŸàŸÑÿØ/Screenshot 2026-01-27 130938.png', 'prototypes/ŸÖŸàŸÑÿØ/Screenshot 2026-01-27 130958.png', 'prototypes/ŸÖŸàŸÑÿØ/Screenshot 2026-01-27 131048.png',
                    'prototypes/ŸÖŸàŸÑÿØ/Screenshot 2026-01-27 131139.png', 'prototypes/ŸÖŸàŸÑÿØ/Screenshot 2026-01-27 131404.png', 'prototypes/ŸÖŸàŸÑÿØ/Screenshot 2026-01-27 131429.png',
                    'prototypes/ŸÖŸàŸÑÿØ/ŸÖŸàŸÑÿØ-ÿßÿ®Ÿä-ÿßŸÑŸÅÿ∂ŸÑ-ÿßŸÑÿπÿ®ÿßÿ≥.png', 'prototypes/ŸÖŸàŸÑÿØ/ŸÖŸàŸÑÿØ-ÿßŸÑÿ®ÿßŸÇÿ±1.png', 'prototypes/ŸÖŸàŸÑÿØ/ŸÖŸàŸÑÿØ-ÿßŸÑŸáÿßÿØŸä2.png'
                ],
                wafayat: [
                    'prototypes/ŸàŸÅÿßÿ©/Screenshot 2026-01-27 130404.png', 'prototypes/ŸàŸÅÿßÿ©/Screenshot 2026-01-27 130454.png', 'prototypes/ŸàŸÅÿßÿ©/Screenshot 2026-01-27 130553.png',
                    'prototypes/ŸàŸÅÿßÿ©/Screenshot 2026-01-27 130647.png', 'prototypes/ŸàŸÅÿßÿ©/Screenshot 2026-01-27 130738.png', 'prototypes/ŸàŸÅÿßÿ©/Screenshot 2026-01-27 130813.png',
                    'prototypes/ŸàŸÅÿßÿ©/ÿ•ÿπŸÑÿßŸÜ-ÿßŸÑŸÖÿßÿ™ŸÖ-ŸàŸÅÿßÿ©-ÿßŸÑÿ≥ŸäÿØÿ©-ÿ≥ŸÉŸäŸÜÿ©.png1.png', 'prototypes/ŸàŸÅÿßÿ©/ÿßÿ≠ŸÖÿØ Ÿäÿ™ŸäŸÖ.png', 'prototypes/ŸàŸÅÿßÿ©/ÿßÿ≥ÿ™ÿ¥ŸáÿßÿØ-ÿßŸÑÿ≤Ÿáÿ±ÿßÿ°-ÿßŸÑÿ±ŸàÿßŸäÿ©-ÿßŸÑÿ´ÿßŸÑÿ´ÿ©.png',
                    'prototypes/ŸàŸÅÿßÿ©/ŸÅÿßŸäŸÜŸÑ-ÿßÿ≥ÿ™ÿ¥ŸáÿßÿØ-ÿßŸÑÿ•ÿπÿ≥ŸÉÿ±Ÿä.png', 'prototypes/ŸàŸÅÿßÿ©/ŸàŸÅÿßÿ©-ÿßŸÑŸáÿßÿØŸä-ÿßŸÑŸÖÿßÿ™ŸÖ1.png', 'prototypes/ŸàŸÅÿßÿ©/ŸàŸÅÿßÿ©-ÿßŸÖ-ÿßŸÑÿ®ŸÜŸäŸÜ.png'
                ],
                aza: [
                    'prototypes/ÿπÿ≤ÿßÿ°/Screenshot 2026-01-27 124618.png', 'prototypes/ÿπÿ≤ÿßÿ°/Screenshot 2026-01-27 124705.png', 'prototypes/ÿπÿ≤ÿßÿ°/Screenshot 2026-01-27 125047.png',
                    'prototypes/ÿπÿ≤ÿßÿ°/Screenshot 2026-01-27 125111.png', 'prototypes/ÿπÿ≤ÿßÿ°/Screenshot 2026-01-27 125901.png', 'prototypes/ÿπÿ≤ÿßÿ°/Screenshot 2026-01-27 125938.png',
                    'prototypes/ÿπÿ≤ÿßÿ°/Screenshot 2026-01-27 130122.png', 'prototypes/ÿπÿ≤ÿßÿ°/Screenshot 2026-01-27 130151.png', 'prototypes/ÿπÿ≤ÿßÿ°/Screenshot 2026-01-27 130216.png',
                    'prototypes/ÿπÿ≤ÿßÿ°/ÿßÿπŸÑÿßŸÜ ÿßÿ≥ÿ™ÿ¥ŸáÿßÿØ ÿßŸÑŸÉÿßÿ∏ŸÖ 2.jpg.jpeg', 'prototypes/ÿπÿ≤ÿßÿ°/ŸàŸÅÿßÿ©-ÿßŸÑÿ≥ŸäÿØÿ©-ÿ≤ŸäŸÜÿ®-ŸÖÿØŸäŸÜÿ©-ÿ≠ŸÖÿØ.png', 'prototypes/ÿπÿ≤ÿßÿ°/ŸàŸÅÿßÿ©-ÿßŸÑŸáÿßÿØŸä-ŸÖÿ≥ÿ¨ÿØ-ŸÅÿßÿ∑ŸÖÿ©-ÿßŸÑÿ≤Ÿáÿ±ÿßÿ°.png', 'prototypes/ÿπÿ≤ÿßÿ°/ŸàŸÅÿßÿ©-ÿßŸÖ-ÿßŸÑÿ®ŸÜŸäŸÜ1.png'
                ]
            };

            const psdTemplates = {
                mowalid: [
                    { id: 'm1', name: 'ŸÖŸàŸÑÿØ ÿ£ŸÖ ÿßŸÑÿ®ŸÜŸäŸÜ', psd: 'https://www.dropbox.com/scl/fi/dggamt4jnhv5fygu4zf5n/.psd?rlkey=wx80q4oyoo710qcnio3jnluxb&st=s73z1k07&dl=1', keywords: 'pink, flowers, bright, um_albanin' },
                    { id: 'm2', name: 'ŸÖŸàŸÑÿØ ÿßŸÑŸáÿßÿØŸä', psd: 'https://www.dropbox.com/scl/fi/wif0gspdj1km34bgvb0qe/2.psd?rlkey=ofyiucmfcbocjggnjureaabz5&st=y32x2idf&dl=1', keywords: 'green, light, hadi' },
                    { id: 'm3', name: 'ŸÖŸàŸÑÿØ ÿßŸÑÿ®ÿßŸÇÿ±', psd: 'https://www.dropbox.com/scl/fi/ng9tfrjn6u4iozxkpyrxi/1.psd?rlkey=8dqtskrsqzwyjj18lc2uwtzff&st=83b8csl4&dl=1', keywords: 'blue, lanterns, baqir' }
                ],
                wafayat: [
                    { id: 'w1', name: 'ŸÇÿßŸÑÿ® ŸàŸÅŸäÿßÿ™', psd: 'https://www.dropbox.com/scl/fi/kvnkdnowlbzymr152miz8/.psd?rlkey=5fnxmfcfpsfvbo6n6kf2uz77o&st=3blhhjy9&dl=1', keywords: 'classic, borders, mourning' },
                    { id: 'w2', name: 'ŸàŸÅÿßÿ© ÿßŸÑŸáÿßÿØŸä', psd: 'https://www.dropbox.com/scl/fi/a7qu69ar5vh6hca0680zj/.psd?rlkey=k9x7yf2qgm1p3hrpu479ltoyy&st=epzimmqr&dl=1', keywords: 'dark, candles, hadi' },
                    { id: 'w3', name: 'ŸÖÿ£ÿ™ŸÖ', psd: 'https://www.dropbox.com/scl/fi/7e02rtvvtm91xbtvk5zse/.psd?rlkey=sly6tagot907peo4uaqvp72l0&st=ihvh9a56&dl=1', keywords: 'black, banners, general' }
                ],
                aza: [
                    { id: 'a1', name: 'ÿ•ÿπŸÑÿßŸÜ ÿ∑ÿßŸáÿ±', psd: 'https://www.dropbox.com/scl/fi/z5vvj6zxzfzhhfrbzsexc/.psd?rlkey=zg8i9uhwrrqvw6gjqxu213w79&st=t32clasl&dl=1', keywords: 'red, black, epic' },
                    { id: 'a2', name: 'ÿ•ÿπŸÑÿßŸÜ ÿπÿ≤ÿßÿ°', psd: 'https://www.dropbox.com/scl/fi/67o2z8hs7014vj08frizw/.psd?rlkey=d2qung0jo2dzi8sk0lcctvqwi&st=nlidrlt9&dl=1', keywords: 'modern, group, mourning' },
                    { id: 'a3', name: 'ÿßÿ≥ÿ™ÿ¥ŸáÿßÿØ ÿßŸÑÿ≥ŸäÿØÿ© ÿ≤ŸäŸÜÿ®', psd: 'https://www.dropbox.com/scl/fi/khfkbb71u5qy48x7m0bdr/.psd?rlkey=fic0ge0zqocnpwbewpjzsl8om&st=2tp61vlm&dl=1', keywords: 'yellow, desert, zainab' },
                    { id: 'a4', name: 'ŸÖÿØŸäŸÜÿ© ÿ≠ŸÖÿØ', psd: 'https://www.dropbox.com/scl/fi/weaqttfxkyuzr8d0i05k1/.psd?rlkey=p2h3l0jkathd8w8dupkhi0qu1&st=2wl8g7uh&dl=1', keywords: 'city, hamad' }
                ]
            };

            const getCloudDirectUrls = (url) => {
                if (!url) return [];
                const encoded = encodeURIComponent(url);
                return [
                    { name: 'ÿ±ÿßÿ®ÿ∑ ŸÖÿ®ÿßÿ¥ÿ±', url: url.replace('www.dropbox.com', 'dl.dropboxusercontent.com').replace('dl=0', 'dl=1') },
                    { name: 'ÿÆÿßÿØŸÖ ŸÖŸêŸÄŸÜŸÄÿ®ŸéŸÄÿ± ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä', url: `${BASE_API_URL}/proxy-cloud?url=${encoded}` },
                    { name: 'ÿßŸÑŸàÿ≥Ÿäÿ∑ ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿä 1', url: `https://api.allorigins.win/raw?url=${encoded}` },
                    { name: 'ÿßŸÑŸàÿ≥Ÿäÿ∑ ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿä 2', url: `https://corsproxy.io/?${encoded}` }
                ];
            };

            const daysMap = {
                'ÿßŸÑÿ£ÿ≠ÿØ': 'ŸÑŸäŸÑÿ© ÿßŸÑÿ•ÿ´ŸÜŸäŸÜ',
                'ÿßŸÑÿßÿ´ŸÜŸäŸÜ': 'ŸÑŸäŸÑÿ© ÿßŸÑÿ´ŸÑÿßÿ´ÿßÿ°',
                'ÿßŸÑÿ´ŸÑÿßÿ´ÿßÿ°': 'ŸÑŸäŸÑÿ© ÿßŸÑÿ£ÿ±ÿ®ÿπÿßÿ°',
                'ÿßŸÑÿ£ÿ±ÿ®ÿπÿßÿ°': 'ŸÑŸäŸÑÿ© ÿßŸÑÿÆŸÖŸäÿ≥',
                'ÿßŸÑÿÆŸÖŸäÿ≥': 'ŸÑŸäŸÑÿ© ÿßŸÑÿ¨ŸÖÿπÿ©',
                'ÿßŸÑÿ¨ŸÖÿπÿ©': 'ŸÑŸäŸÑÿ© ÿßŸÑÿ≥ÿ®ÿ™',
                'ÿßŸÑÿ≥ÿ®ÿ™': 'ŸÑŸäŸÑÿ© ÿßŸÑÿ£ÿ≠ÿØ'
            };

            const handleDayChange = (day) => {
                setData({ ...data, day });
            };

            const handlePhotoChange = (index, file) => {
                const newPhotos = [...data.photos];
                newPhotos[index] = file;
                setData({ ...data, photos: newPhotos });
            };

            const handleSpeakerChange = (index, name) => {
                const newSpeakers = [...data.speakers];
                newSpeakers[index] = name;
                setData({ ...data, speakers: newSpeakers });
            };

            useEffect(() => {
                if (!user) push('/login');
            }, [user, push]);

            useEffect(() => {
                const day = data.day;
                const timeStr = data.time || '';
                if (!day) return;

                // Simple heuristic for parsing Arabic time parts
                const isPM = timeStr.includes('ŸÖÿ≥ÿßÿ°Ÿã') || timeStr.includes('ŸÑŸäŸÑÿßŸã') || (timeStr.toLowerCase().includes('pm')) || (timeStr.includes('ŸÖ') && !timeStr.includes('ŸÖŸäŸÑÿßÿØŸä'));
                const hourMatch = timeStr.match(/(\d+)/);
                const hour = hourMatch ? parseInt(hourMatch[1]) : 0;

                // User Rule: If hour >= 6 PM or explicitly 'Night', it's "Night of" (next day)
                // Otherwise it's "Day of" (current day)
                let isNight = isPM && (hour >= 6 && hour < 12);
                if (timeStr.includes('ŸÑŸäŸÑÿßŸã')) isNight = true;

                const newNightText = isNight ? (daysMap[day] || '') : `ŸäŸàŸÖ ${day}`;

                if (newNightText !== data.nightOfText) {
                    setData(prev => ({ ...prev, nightOfText: newNightText }));
                }
            }, [data.day, data.time]);

            const downloadImage = () => {
                if (!result) return;
                const link = document.createElement('a');
                link.href = result;
                link.download = `MENBAR-AD-${Date.now()}.jpg`;
                link.click();
            };

            const addSpeaker = () => {
                if (data.speakers.length >= 11) return;
                setData({
                    ...data,
                    speakers: [...data.speakers, ''],
                    photos: [...data.photos, null]
                });
            };

            const removeSpeaker = (index) => {
                if (index === 0) return; // Cannot remove first speaker
                const newSpeakers = [...data.speakers];
                const newPhotos = [...data.photos];
                newSpeakers.splice(index, 1);
                newPhotos.splice(index, 1);
                setData({ ...data, speakers: newSpeakers, photos: newPhotos });
            };

            const generateAd = async () => {
                const validSpeakers = data.speakers.filter((s, i) => s.trim() !== '' && data.photos[i]);
                if (!data.eventName || validSpeakers.length === 0 || !data.logo) return alert("Ÿäÿ±ÿ¨Ÿâ ÿ•ŸÉŸÖÿßŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ© (ÿßŸÑÿ±ÿßÿØŸàÿØÿå ÿßŸÑŸÖŸÜÿßÿ≥ÿ®ÿ©ÿå ÿßŸÑÿ¥ÿπÿßÿ±)");
                if (user.credits < 4) return alert("ÿ±ÿµŸäÿØŸÉ ÿ∫Ÿäÿ± ŸÉÿßŸÅŸç (ÿ™ÿ≠ÿ™ÿßÿ¨ 4 ŸÉÿ±ŸäÿØŸäÿ™)");

                setGenerating(true);
                setStatus('processing');

                const setAdsStatus = (msg) => {
                    const el = document.getElementById('ads-processing-msg');
                    if (el) el.innerText = msg;
                };

                try {
                    await deductCredits(4);

                    // --- STEP 1: PREPARE DATA FOR GEMINI ---
                    setAdsStatus("ŸäŸÇŸàŸÖ Gemini ÿ®ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨ ŸàÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ¢ŸÜ...");

                    let refBase64 = "";
                    if (data.type === 'custom' && data.customProto) {
                        refBase64 = await new Promise((res) => {
                            const reader = new FileReader();
                            reader.onload = (e) => res(e.target.result.split(',')[1]);
                            reader.readAsDataURL(data.customProto);
                        });
                    }

                    // Crafting a detailed prompt for Gemini to act as a design consultant
                    const geminiPrompt = `
                        Role: Professional Islamic Graphic Designer.
                        Task: Analyze the event details and reference style to create a 4K image generation prompt.
                        Event: ${data.eventName}
                        Speakers: ${validSpeakers.join(', ')}
                        DateTime: ${data.day} ${data.date} at ${data.time}
                        Location: ${data.location}
                        Style: ${data.type === 'custom' ? 'Follow the attached reference image style.' : 'Standard ' + data.type + ' style.'}
                        
                        Requirement: Generate ONLY a long, descriptive English prompt for an AI image generator (Stable Diffusion style).
                        The prompt should describe: A premium Shiia/Islamic poster layout, high-end Arabic calligraphy for the names, 
                        vibrant lighting, traditional architecture, and 4K digital art textures.
                    `;

                    // Call Gemini 1.5 Flash for design analysis
                    const geminiResp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [
                                    { text: geminiPrompt },
                                    ...(refBase64 ? [{ inline_data: { mime_type: "image/jpeg", data: refBase64 } }] : [])
                                ]
                            }]
                        })
                    });

                    const geminiData = await geminiResp.json();
                    const optimizedPrompt = geminiData.candidates[0].content.parts[0].text;

                    // --- STEP 2: EXECUTE REAL GENERATION ---
                    setAdsStatus("Nano Banana Bro (Gemini Powered) ŸäŸÇŸàŸÖ ÿ®ÿßŸÑÿ±ÿ≥ŸÖ ŸàÿßŸÑÿØŸÖÿ¨ ÿßŸÑÿ¢ŸÜ...");

                    const formData = new FormData();
                    formData.append('prompt', optimizedPrompt);
                    formData.append('aspect_ratio', '4:5');
                    formData.append('engine', 'nano_banana_bro_v2');

                    // Sending the real assets
                    if (data.logo) formData.append('logo', data.logo);

                    validSpeakers.forEach((s, i) => {
                        const photoIdx = data.speakers.indexOf(s);
                        if (data.photos[photoIdx]) {
                            formData.append(`speaker_${i}`, data.photos[photoIdx]);
                            formData.append(`speaker_name_${i}`, s);
                        }
                    });

                    if (data.type === 'custom' && data.customProto) {
                        formData.append('image_ref_file', data.customProto);
                    }

                    const response = await fetch(`${BASE_API_URL}/image/generate`, {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        const errText = await response.text();
                        console.error("Backend Error:", errText);
                        throw new Error("ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ± ŸÖÿ¥ÿ∫ŸàŸÑ ÿ£Ÿà ÿ≠ÿ¨ŸÖ ÿßŸÑŸÖŸÑŸÅ ŸÉÿ®Ÿäÿ± ÿ¨ÿØÿßŸã.");
                    }

                    const job = await response.json();
                    if (!job.job_id) throw new Error("ŸÅÿ¥ŸÑ ŸÖÿ≠ÿ±ŸÉ ÿßŸÑÿ™ŸàŸÑŸäÿØ ŸÅŸä ÿßŸÑÿßÿ≥ÿ™ÿ¨ÿßÿ®ÿ©.");

                    // Polling logic for results
                    let resultUrl = null;
                    let attempts = 0;
                    while (!resultUrl && attempts < 60) {
                        await new Promise(r => setTimeout(r, 4000));
                        const statusResp = await fetch(`${BASE_API_URL}/status/${job.job_id}`);
                        const statusData = await statusResp.json();

                        if (statusData.status === 'SUCCESS' || statusData.status === 'completed') {
                            const outUrl = statusData.result.output_url;
                            resultUrl = (outUrl && outUrl.startsWith('http')) ? outUrl : `${BASE_API_URL}${outUrl}`;
                            break;
                        } else if (statusData.status === 'failed') {
                            throw new Error("ŸÅÿ¥ŸÑ ÿßŸÑŸÖÿ≠ÿ±ŸÉ ŸÅŸä ÿ•ŸÜÿ™ÿßÿ¨ ÿßŸÑÿ™ÿµŸÖŸäŸÖ.");
                        }

                        setAdsStatus(`Nano Banana Bro: ÿ¨ÿßÿ±Ÿä ÿ®ŸÜÿßÿ° ÿßŸÑÿ™ÿµŸÖŸäŸÖ (${statusData.progress || 10 * (attempts % 10)}%)...`);
                        attempts++;
                    }

                    if (!resultUrl) throw new Error("ÿßÿ≥ÿ™ÿ∫ÿ±ŸÇ ÿßŸÑŸÖÿ≠ÿ±ŸÉ ŸàŸÇÿ™ÿßŸã ÿ∑ŸàŸäŸÑÿßŸã. Ÿäÿ±ÿ¨Ÿâ ŸÖÿ±ÿßÿ¨ÿπÿ© ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸÑÿßÿ≠ŸÇÿßŸã.");

                    setResult(resultUrl);
                    setStatus('result');
                    setGenerating(false);

                    addHistoryItem({
                        id: Date.now(),
                        type: 'image',
                        name: `ÿ™ÿµŸÖŸäŸÖ ÿ∞ŸÉŸä: ${data.eventName}`,
                        url: resultUrl,
                        date: new Date().toLocaleDateString('en-GB'),
                        status: 'completed'
                    });

                } catch (e) {
                    console.error("Nano Engine Error:", e);
                    alert("ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿ≠ÿ±ŸÉ Nano Banana Bro: " + e.message);
                    setGenerating(false);
                    setStatus('form');
                }
            };

            if (!user) return null;


            return (
                <div className="container animate-fade-in" style={{ padding: '20px', maxWidth: '1000px' }}>
                    <div style={{ display: 'flex', gap: '20px', alignItems: 'center', marginBottom: '30px' }}>
                        <BackButton />
                        <h2 style={{ margin: 0 }}>üé® ŸÖŸàŸÑÿØ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ ÿßŸÑÿßÿ≠ÿ™ÿ±ÿßŸÅŸä (Banana Pro)</h2>
                    </div>

                    {status === 'category' && (
                        <div style={{ textAlign: 'center', padding: '40px 0' }}>
                            <h2 style={{ marginBottom: '40px' }}>ŸÖÿß ŸáŸà ŸÜŸàÿπ ÿßŸÑŸÖŸÜÿßÿ≥ÿ®ÿ©ÿü</h2>
                            <div style={{
                                display: 'grid',
                                gridTemplateColumns: 'repeat(auto-fit, minmax(220px, 1fr))',
                                gap: '20px'
                            }}>
                                <div className="card" onClick={() => { setData({ ...data, type: 'mowalid' }); setStatus('form'); }} style={{ padding: '30px 15px', cursor: 'pointer', border: '2px solid transparent', transition: '0.3s' }} onMouseEnter={e => e.currentTarget.style.borderColor = 'var(--success)'} onMouseLeave={e => e.currentTarget.style.borderColor = 'transparent'}>
                                    <div style={{ fontSize: '3rem', marginBottom: '15px' }}>‚ú®</div>
                                    <h3 style={{ color: 'var(--success)', fontSize: '1.2rem' }}>ŸÖŸàÿßŸÑŸäÿØ / ÿ£ŸÅÿ±ÿßÿ≠</h3>
                                    <p style={{ color: 'var(--text-secondary)', fontSize: '0.85rem' }}>ÿ£ŸÑŸàÿßŸÜ ÿ≤ÿßŸáŸäÿ© ŸÖÿ®Ÿáÿ¨ÿ©</p>
                                </div>
                                <div className="card" onClick={() => { setData({ ...data, type: 'wafayat' }); setStatus('form'); }} style={{ padding: '30px 15px', cursor: 'pointer', border: '2px solid transparent', transition: '0.3s' }} onMouseEnter={e => e.currentTarget.style.borderColor = 'var(--error)'} onMouseLeave={e => e.currentTarget.style.borderColor = 'transparent'}>
                                    <div style={{ fontSize: '3rem', marginBottom: '15px' }}>üïØÔ∏è</div>
                                    <h3 style={{ color: 'var(--error)', fontSize: '1.2rem' }}>ŸàŸÅÿßÿ© / ÿ£ÿ≠ÿ≤ÿßŸÜ</h3>
                                    <p style={{ color: 'var(--text-secondary)', fontSize: '0.85rem' }}>ÿ¥ŸÖŸàÿπ ŸàÿÆÿ∑Ÿàÿ∑ ÿ≠ÿ≤ŸäŸÜÿ©</p>
                                </div>
                                <div className="card" onClick={() => { setData({ ...data, type: 'aza' }); setStatus('form'); }} style={{ padding: '30px 15px', cursor: 'pointer', border: '2px solid transparent', transition: '0.3s' }} onMouseEnter={e => e.currentTarget.style.borderColor = 'var(--primary)'} onMouseLeave={e => e.currentTarget.style.borderColor = 'transparent'}>
                                    <div style={{ fontSize: '3rem', marginBottom: '15px' }}>üè¥</div>
                                    <h3 style={{ color: 'var(--primary)', fontSize: '1.2rem' }}>ÿπÿ≤ÿßÿ° / ŸÖŸàÿßŸÉÿ®</h3>
                                    <p style={{ color: 'var(--text-secondary)', fontSize: '0.85rem' }}>ÿ™ÿ±ŸÉŸäÿ≤ ÿπŸÑŸâ ÿßŸÑÿ±ÿßÿØŸàÿØ</p>
                                </div>
                                <div className="card" onClick={() => document.getElementById('custom-ref-upload').click()} style={{ padding: '30px 15px', cursor: 'pointer', border: '2px dashed var(--primary)', transition: '0.3s' }} onMouseEnter={e => e.currentTarget.style.background = 'rgba(0, 74, 173, 0.05)'} onMouseLeave={e => e.currentTarget.style.background = 'transparent'}>
                                    <div style={{ fontSize: '3rem', marginBottom: '15px' }}>üñºÔ∏è</div>
                                    <h3 style={{ color: 'var(--primary)', fontSize: '1.2rem' }}>ŸÜŸÖŸàÿ∞ÿ¨ŸÉ ÿßŸÑÿÆÿßÿµ</h3>
                                    <p style={{ color: 'var(--text-secondary)', fontSize: '0.85rem' }}>ÿßÿ±ŸÅÿπ ÿ™ÿµŸÖŸäŸÖŸÉ ŸÑÿ™ŸÇŸÑŸäÿØŸá</p>
                                    <input type="file" id="custom-ref-upload" hidden accept="image/*" onChange={(e) => {
                                        if (e.target.files[0]) {
                                            setData({ ...data, type: 'custom', customProto: e.target.files[0] });
                                            setStatus('form');
                                        }
                                    }} />
                                </div>
                            </div>
                        </div>
                    )}

                    {status === 'form' && (
                        <div className="card animate-fade-in" style={{ padding: '30px' }}>
                            {/* NEW ORDER: Person and Logo FIRST */}

                            {/* Main Inputs: Person and Logo */}
                            <div style={{ padding: '20px', background: 'rgba(255,255,255,0.02)', borderRadius: '12px', border: '1px solid var(--border)', direction: 'rtl', marginBottom: '30px' }}>
                                <label style={{ fontWeight: 'bold', display: 'block', marginBottom: '15px' }}>üì∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ±ÿßÿØŸàÿØ Ÿàÿ¥ÿπÿßÿ± ÿßŸÑŸÖŸàŸÉÿ®</label>
                                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(200px, 1fr))', gap: '20px' }}>

                                    {/* Speaker 1 (Mandatory) */}
                                    <div className="card" style={{ padding: '15px', background: 'var(--surface)', border: data.photos[0] ? '1px solid var(--primary)' : '2px dashed var(--error)', display: 'flex', flexDirection: 'column' }}>
                                        <label style={{ fontSize: '0.8rem', display: 'block', marginBottom: '10px', color: data.photos[0] ? 'inherit' : 'var(--error)' }}>
                                            ÿßŸÑÿ±ÿßÿØŸàÿØ/ÿßŸÑÿ¥ŸäÿÆ ÿßŸÑÿ£ŸàŸÑ (ŸÖÿ∑ŸÑŸàÿ®):
                                        </label>
                                        <div
                                            onClick={() => document.getElementById('photo-0').click()}
                                            style={{
                                                flex: 1, minHeight: '120px', border: '1px dashed var(--border)', borderRadius: '8px',
                                                display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer', overflow: 'hidden', background: 'rgba(255,255,255,0.01)'
                                            }}
                                        >
                                            {data.photos[0] ? <img src={URL.createObjectURL(data.photos[0])} style={{ width: '100%', height: '100%', objectFit: 'cover' }} /> : <div style={{ fontSize: '1.5rem', opacity: 0.5 }}>üë§</div>}
                                        </div>
                                        <input id="photo-0" type="file" style={{ display: 'none' }} onChange={e => {
                                            if (e.target.files[0]) handlePhotoChange(0, e.target.files[0]);
                                        }} />
                                        <input
                                            type="text"
                                            placeholder="ÿßÿ≥ŸÖ ÿßŸÑÿ±ÿßÿØŸàÿØ ..."
                                            className="input-field"
                                            style={{ marginTop: '10px', fontSize: '0.8rem', marginBottom: 0 }}
                                            value={data.speakers[0]}
                                            onChange={e => handleSpeakerChange(0, e.target.value)}
                                        />
                                    </div>

                                    {/* Additional Speakers Loop */}
                                    {data.speakers.map((s, idx) => {
                                        if (idx === 0) return null; // Already shown Speaker 1
                                        return (
                                            <div key={idx} className="card animate-fade-in" style={{ padding: '15px', background: 'var(--surface)', border: data.photos[idx] ? '1px solid var(--primary)' : '1px dashed var(--border)', display: 'flex', flexDirection: 'column', position: 'relative' }}>
                                                <button
                                                    onClick={() => removeSpeaker(idx)}
                                                    style={{ position: 'absolute', top: '5px', left: '5px', background: 'rgba(255,0,0,0.1)', color: 'red', border: 'none', borderRadius: '50%', width: '20px', height: '20px', fontSize: '12px', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 5 }}
                                                >√ó</button>
                                                <label style={{ fontSize: '0.8rem', display: 'block', marginBottom: '10px' }}>ŸÖÿ¥ÿßÿ±ŸÉ ÿ•ÿ∂ÿßŸÅŸä ({idx + 1}):</label>
                                                <div
                                                    onClick={() => document.getElementById(`photo-${idx}`).click()}
                                                    style={{
                                                        flex: 1, minHeight: '120px', border: '1px dashed var(--border)', borderRadius: '8px',
                                                        display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer', overflow: 'hidden'
                                                    }}
                                                >
                                                    {data.photos[idx] ? <img src={URL.createObjectURL(data.photos[idx])} style={{ width: '100%', height: '100%', objectFit: 'cover' }} /> : <div style={{ fontSize: '1.5rem', opacity: 0.5 }}>üë§</div>}
                                                </div>
                                                <input id={`photo-${idx}`} type="file" style={{ display: 'none' }} onChange={e => {
                                                    if (e.target.files[0]) handlePhotoChange(idx, e.target.files[0]);
                                                }} />
                                                <input
                                                    type="text"
                                                    placeholder="ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ¥ÿßÿ±ŸÉ..."
                                                    className="input-field"
                                                    style={{ marginTop: '10px', fontSize: '0.8rem', marginBottom: 0 }}
                                                    value={data.speakers[idx]}
                                                    onChange={e => handleSpeakerChange(idx, e.target.value)}
                                                />
                                            </div>
                                        );
                                    })}

                                    {/* Add Speaker Button */}
                                    {data.speakers.length < 11 && (
                                        <div
                                            className="card"
                                            onClick={addSpeaker}
                                            style={{
                                                padding: '15px', background: 'rgba(255,255,255,0.01)', border: '1px dashed var(--primary)',
                                                display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center',
                                                cursor: 'pointer', color: 'var(--primary)', minHeight: '180px'
                                            }}
                                        >
                                            <div style={{ fontSize: '2rem', marginBottom: '10px' }}>‚ûï</div>
                                            <div style={{ fontSize: '0.8rem' }}>ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ¥ÿßÿ±ŸÉ</div>
                                            <small style={{ opacity: 0.6 }}>(ÿ≠ÿ™Ÿâ 10 ŸÖÿ¥ÿßÿ±ŸÉŸäŸÜ)</small>
                                        </div>
                                    )}

                                    {/* Logo Upload (Mandatory but without error border) */}
                                    <div className="card" style={{ padding: '15px', background: 'var(--surface)', border: '1px dashed var(--border)', display: 'flex', flexDirection: 'column' }}>
                                        <label style={{ fontSize: '0.8rem', display: 'block', marginBottom: '10px' }}>ÿ¥ÿπÿßÿ± ÿßŸÑŸÖÿ£ÿ™ŸÖ (ŸÖÿ∑ŸÑŸàÿ®):</label>
                                        <div
                                            onClick={() => document.getElementById('logo-upload').click()}
                                            style={{
                                                flex: 1, minHeight: '120px', border: '1px dashed var(--border)', borderRadius: '8px',
                                                display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer', background: 'rgba(255,255,255,0.02)'
                                            }}
                                        >
                                            {data.logo ? <img src={URL.createObjectURL(data.logo)} style={{ maxHeight: '100px', maxWidth: '100%' }} /> : <div style={{ textAlign: 'center', opacity: 0.6 }}>üìÇ<br />ÿ±ŸÅÿπ ÿßŸÑÿ¥ÿπÿßÿ±</div>}
                                        </div>
                                        <input id="logo-upload" type="file" style={{ display: 'none' }} onChange={e => {
                                            if (e.target.files[0]) setData({ ...data, logo: e.target.files[0] });
                                        }} />
                                        <input
                                            type="text"
                                            placeholder="ÿßÿ≥ŸÖ ÿßŸÑŸÖŸàŸÉÿ®/ÿßŸÑŸÖÿ£ÿ™ŸÖ..."
                                            className="input-field"
                                            style={{ marginTop: '10px', fontSize: '0.8rem', marginBottom: 0 }}
                                            value={data.location}
                                            onChange={e => setData({ ...data, location: e.target.value })}
                                        />
                                    </div>
                                </div>

                                <div style={{ marginTop: '15px', fontSize: '0.75rem', color: 'var(--text-secondary)', background: 'rgba(255,255,255,0.02)', padding: '10px', borderRadius: '8px' }}>
                                    üí° ŸÖŸÑÿßÿ≠ÿ∏ÿ©: ÿßŸÑÿµŸàÿ± ÿßŸÑÿ¥ÿÆÿµŸäÿ© Ÿäÿ™ŸÖ ÿπÿ≤ŸÑ ÿÆŸÑŸÅŸäÿ™Ÿáÿß ÿ®ÿ±ŸÖÿ¨ŸäÿßŸãÿå ÿßŸÑÿ¥ÿπÿßÿ± ŸäŸÅÿ∂ŸÑ ÿ±ŸÅÿπŸá ÿ®ÿµŸäÿ∫ÿ© PNG ÿ¥ŸÅÿßŸÅÿ©.
                                </div>
                            </div>

                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '30px', direction: 'rtl' }}>
                                <div>
                                    <div className="form-group" style={{ marginBottom: '20px' }}>
                                        <label style={{ fontWeight: 'bold' }}>ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿßÿ≥ÿ®ÿ©</label>
                                        <input type="text" placeholder="ŸÖÿ´ŸÑÿßŸã: ÿßÿ≥ÿ™ÿ¥ŸáÿßÿØ ÿßŸÑÿ≤Ÿáÿ±ÿßÿ° (ÿπ)" className="input-field" value={data.eventName} onChange={e => setData({ ...data, eventName: e.target.value })} />
                                    </div>

                                    <div className="form-group" style={{ marginBottom: '20px' }}>
                                        <label style={{ fontWeight: 'bold' }}>ŸäŸàŸÖ ÿßŸÑŸÖŸÜÿßÿ≥ÿ®ÿ©</label>
                                        <select className="input-field" value={data.day} onChange={e => handleDayChange(e.target.value)}>
                                            <option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸäŸàŸÖ...</option>
                                            {Object.keys(daysMap).map(d => <option key={d} value={d}>{d}</option>)}
                                        </select>
                                    </div>
                                    {data.nightOfText && (
                                        <div style={{ marginBottom: '20px', color: 'var(--primary)', fontWeight: 'bold', fontSize: '0.9rem' }}>
                                            ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ© ŸÅŸä ÿßŸÑÿ•ÿπŸÑÿßŸÜ: {data.nightOfText}
                                        </div>
                                    )}

                                    {data.type === 'aza' && (
                                        <div className="form-group" style={{ marginBottom: '20px' }}>
                                            <label style={{ fontWeight: 'bold' }}>ŸÜŸÇÿ∑ÿ© ÿßŸÜÿ∑ŸÑÿßŸÇ ÿßŸÑŸÖŸàŸÉÿ® (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)</label>
                                            <input type="text" placeholder="ŸÖÿ´ŸÑÿßŸã: ŸÖŸÜ ŸÖÿ£ÿ™ŸÖ ÿßŸÑÿÆÿ∂ÿ±" className="input-field" value={data.procession} onChange={e => setData({ ...data, procession: e.target.value })} />
                                        </div>
                                    )}
                                </div>
                                <div>
                                    <div className="form-group" style={{ marginBottom: '20px' }}>
                                        <label style={{ fontWeight: 'bold' }}>ŸÜŸàÿπ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</label>
                                        <div style={{ display: 'flex', gap: '10px', marginTop: '5px' }}>
                                            <button onClick={() => setData({ ...data, dateType: 'hijri' })} className={`btn ${data.dateType === 'hijri' ? 'btn-primary' : 'btn-outline'}`} style={{ flex: 1, padding: '8px', fontSize: '0.8rem' }}>Ÿáÿ¨ÿ±Ÿä</button>
                                            <button onClick={() => setData({ ...data, dateType: 'miladi' })} className={`btn ${data.dateType === 'miladi' ? 'btn-primary' : 'btn-outline'}`} style={{ flex: 1, padding: '8px', fontSize: '0.8rem' }}>ŸÖŸäŸÑÿßÿØŸä</button>
                                        </div>
                                    </div>
                                    <div className="form-group" style={{ marginBottom: '20px' }}>
                                        <label style={{ fontWeight: 'bold' }}>ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</label>
                                        <input type="text" placeholder={data.dateType === 'hijri' ? "ŸÖÿ´ŸÑÿßŸã: 25 ÿ±ÿ¨ÿ® 1446ŸáŸÄ" : "ŸÖÿ´ŸÑÿßŸã: 12 ŸäŸÜÿßŸäÿ± 2026ŸÖ"} className="input-field" value={data.date} onChange={e => setData({ ...data, date: e.target.value })} />
                                    </div>
                                    <div className="form-group" style={{ marginBottom: '20px' }}>
                                        <label style={{ fontWeight: 'bold' }}>ÿßŸÑŸàŸÇÿ™</label>
                                        <input type="text" placeholder="ŸÖÿ´ŸÑÿßŸã: ÿßŸÑÿ≥ÿßÿπÿ© 8:00 ŸÖÿ≥ÿßÿ°Ÿã" className="input-field" value={data.time} onChange={e => setData({ ...data, time: e.target.value })} />
                                    </div>
                                </div>
                            </div>

                            <div className="form-group" style={{ marginTop: '10px', direction: 'rtl' }}>
                                <label style={{ fontWeight: 'bold' }}>ŸàÿµŸÅ ÿ•ÿ∂ÿßŸÅŸä ÿ£Ÿà ŸÅŸÉÿ±ÿ© ŸÑŸÑÿ™ÿµŸÖŸäŸÖ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)</label>
                                <textarea
                                    placeholder="ŸÖÿ´ŸÑÿßŸã: ÿ£ÿ±ŸäÿØ ŸÅŸÉÿ±ÿ© ÿßŸÑŸÖÿ≠ÿ±ÿßÿ® ŸÑŸÑÿ£ŸÖÿßŸÖ ÿπŸÑŸäÿå ÿ£Ÿà ÿ∂ÿ±Ÿäÿ≠ ÿßŸÑÿ•ŸÖÿßŸÖ ÿßŸÑŸáÿßÿØŸä ŸÖÿπ ÿ£ÿ¨Ÿàÿßÿ° ŸÅÿ±ÿ≠..."
                                    className="input-field"
                                    style={{ height: '100px', resize: 'vertical', width: '100%' }}
                                    value={data.userPrompt}
                                    onChange={e => setData({ ...data, userPrompt: e.target.value })}
                                />
                            </div>

                            <div style={{ marginTop: '30px', display: 'flex', gap: '15px' }}>
                                <button onClick={generateAd} disabled={generating} className="btn btn-primary" style={{ flex: 1, padding: '18px', fontSize: '1.2rem' }}>
                                    {generating ? 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿµŸÖŸäŸÖ...' : `üöÄ ÿ™ÿµŸÖŸäŸÖ ÿßŸÑÿ•ÿπŸÑÿßŸÜ ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ Banana Pro (4 ü™ô)`}
                                </button>
                                <button onClick={() => setStatus('category')} className="btn btn-outline" style={{ padding: '0 30px' }}>ÿ±ÿ¨Ÿàÿπ</button>
                            </div>
                        </div >
                    )
                    }

                    {
                        status === 'processing' && (
                            <div style={{ textAlign: 'center', padding: '80px 0' }}>
                                <div className="animate-pulse" style={{ fontSize: '8rem', marginBottom: '30px', filter: 'drop-shadow(0 0 20px var(--primary))' }}>üß†</div>
                                <h2 className="glow-text" style={{ fontSize: '2.5rem', marginBottom: '20px' }}>ÿ¨ÿßÿ±Ÿä ÿßÿ≥ÿ™ÿ≠ÿ∂ÿßÿ± ŸÇŸàÿ© ÿßŸÑÿπŸÇŸÑ ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿä...</h2>
                                <p id="ads-processing-msg" style={{ color: 'var(--text-secondary)', fontSize: '1.1rem', maxWidth: '600px', margin: '0 auto' }}>
                                    ŸäŸÇŸàŸÖ ÿßŸÑÿπŸÇŸÑ ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä ÿßŸÑÿ¢ŸÜ ÿ®ÿ™ÿ±ŸÉŸäÿ® ÿ∑ÿ®ŸÇÿßÿ™ ÿßŸÑŸÄ PSD ŸàÿØŸÖÿ¨ ÿßŸÑÿπŸÜÿßÿµÿ± ŸÉŸÖÿß ŸäŸÅÿπŸÑ ÿßŸÑŸÖÿµŸÖŸÖ ÿßŸÑŸÖÿ≠ÿ™ÿ±ŸÅ...
                                </p>
                                <div style={{ fontSize: '0.9rem', color: 'var(--primary)', marginTop: '30px', fontWeight: 'bold' }}>
                                    ÿ¨ÿßÿ±Ÿä ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿäÿ© ÿßŸÑÿπŸÖŸäŸÇÿ© ŸÑŸÑŸÅŸàÿ™Ÿàÿ¥Ÿàÿ®...
                                </div>
                            </div>
                        )
                    }

                    {
                        status === 'result' && (
                            <div className="card animate-fade-in" style={{ padding: '30px', textAlign: 'center' }}>
                                <h2 style={{ color: 'var(--success)', marginBottom: '25px' }}>ÿ™ŸÖ ÿ•ŸÜÿ¨ÿßÿ≤ ÿßŸÑÿ™ÿµŸÖŸäŸÖ!</h2>
                                <div style={{ maxWidth: '600px', margin: '0 auto 30px', borderRadius: '15px', overflow: 'hidden', border: '2px solid var(--border)', boxShadow: '0 10px 30px rgba(0,0,0,0.5)' }}>
                                    <img src={result} style={{ width: '100%', display: 'block' }} alt="Generated Ad" />
                                </div>
                                <div style={{ display: 'flex', gap: '15px', maxWidth: '600px', margin: '0 auto' }}>
                                    <button onClick={() => downloadImage(result)} className="btn btn-primary" style={{ flex: 1, padding: '15px' }}>‚¨áÔ∏è ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ•ÿπŸÑÿßŸÜ</button>
                                    <button onClick={() => setStatus('category')} className="btn btn-outline">ÿ™ÿµŸÖŸäŸÖ ÿ¨ÿØŸäÿØ</button>
                                </div>
                                <div style={{ marginTop: '20px', fontSize: '0.8rem', color: 'var(--text-secondary)', background: 'rgba(0,0,0,0.2)', padding: '10px', borderRadius: '8px', textAlign: 'left', direction: 'ltr', overflowX: 'auto' }}>
                                    <strong>AI Orchestration Prompt:</strong><br />
                                    {aiPrompt}
                                </div>
                            </div>
                        )
                    }
                </div >
            );
        }


        function PricingPage() {
            const { addCredits, user, t } = useAuth();
            const { push } = useRouter();
            const [processing, setProcessing] = useState(null);
            const [showPayment, setShowPayment] = useState(null); // To show payment instructions per package

            const packages = [
                { id: 1, price: 5, credits: 25, name: "ÿßŸÑÿ®ÿßŸÇÿ© ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ©", color: '#ffffff' },
                { id: 2, price: 15, credits: 35, name: "ÿßŸÑÿ®ÿßŸÇÿ© ÿßŸÑŸÖÿ™ŸÇÿØŸÖÿ©", color: '#d4af37' },
                { id: 3, price: 20, credits: 50, name: "ÿ®ÿßŸÇÿ© ÿßŸÑŸÖÿ≠ÿ™ÿ±ŸÅŸäŸÜ", color: '#000000', border: true }
            ];

            const handleBuy = async (pkg) => {
                if (!user) return push('/login');
                setShowPayment(pkg);
            };

            const confirmPayment = async (pkg) => {
                setProcessing(pkg.id);
                try {
                    // In a real scenario, this would notify the admin. 
                    // For now, we simulate the wait then add credits.
                    await new Promise(r => setTimeout(r, 2000));
                    const success = await addCredits(pkg.credits);

                    if (success) {
                        alert(`ÿ™ŸÖ ÿßÿ≥ÿ™ŸÑÿßŸÖ ÿ∑ŸÑÿ® ÿßŸÑÿ¥ÿ≠ŸÜ! ÿ≥Ÿäÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ${pkg.credits} ŸÉÿ±ŸäÿØŸäÿ™ ŸÑÿ≠ÿ≥ÿßÿ®ŸÉ ÿ®ÿπÿØ ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑÿ™ÿ≠ŸàŸäŸÑ.`);
                        setShowPayment(null);
                        push('/dashboard');
                    }
                } catch (err) {
                    alert('ŸÅÿ¥ŸÑÿ™ ÿßŸÑÿπŸÖŸÑŸäÿ©.');
                }
                setProcessing(null);
            };

            return (
                <div className="container animate-fade-in" style={{ padding: '60px 20px', textAlign: 'center' }}>
                    <BackButton />
                    <h1 style={{ marginBottom: '10px' }}>{t('pricing_title')}</h1>
                    <p style={{ color: 'var(--text-secondary)' }}>ÿßÿÆÿ™ÿ± ÿßŸÑÿ®ÿßŸÇÿ© ÿßŸÑŸÖŸÜÿßÿ≥ÿ®ÿ© ŸÑÿ¥ÿ≠ŸÜ ÿ±ÿµŸäÿØŸÉ</p>

                    <div style={{ display: 'flex', justifyContent: 'center', gap: '30px', flexWrap: 'wrap', marginTop: '40px' }}>
                        {packages.map((pkg) => (
                            <div key={pkg.id} className="card" style={{ width: '300px', padding: '40px 20px', border: pkg.border ? '2px solid var(--primary)' : '1px solid var(--border)', transform: pkg.border ? 'scale(1.05)' : 'none', position: 'relative' }}>
                                {pkg.border && <div className="badge" style={{ marginBottom: '20px', background: 'var(--primary)', color: '#000', display: 'inline-block' }}>ÿßŸÑÿ£ŸÉÿ´ÿ± ÿ∑ŸÑÿ®ÿßŸã</div>}
                                <h2 style={{ fontSize: '1.5rem' }}>{pkg.name}</h2>
                                <div style={{ fontSize: '3rem', fontWeight: 'bold', margin: '20px 0', color: 'var(--primary)' }}>${pkg.price}</div>
                                <div style={{ fontSize: '1.2rem', marginBottom: '30px', fontWeight: 'bold' }}>{pkg.credits} ŸÉÿ±ŸäÿØŸäÿ™</div>
                                <button onClick={() => handleBuy(pkg)} className={`btn ${pkg.border ? 'btn-primary' : 'btn-outline'}`} style={{ width: '100%' }}>
                                    ÿ¥ÿ±ÿßÿ° ÿßŸÑÿ¢ŸÜ
                                </button>
                            </div>
                        ))}
                    </div>

                    {/* Payment Instruction Modal */}
                    {showPayment && (
                        <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.9)', zIndex: 2000, display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '20px' }}>
                            <div className="card animate-fade-in" style={{ maxWidth: '500px', width: '100%', textAlign: 'center', border: '1px solid var(--primary)' }}>
                                <h2 style={{ color: 'var(--primary)', marginBottom: '20px' }}>ÿ•ŸÉŸÖÿßŸÑ ÿπŸÖŸÑŸäÿ© ÿßŸÑÿ¥ÿ±ÿßÿ°</h2>
                                <p style={{ marginBottom: '20px' }}>Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≠ŸàŸäŸÑ ŸÖÿ®ŸÑÿ∫ <b>${showPayment.price}</b> ÿπÿ®ÿ± BenefitPay</p>

                                <div style={{ background: 'rgba(255,255,255,0.05)', padding: '30px', borderRadius: '12px', border: '1px dashed var(--border)', margin: '20px 0', display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '15px' }}>
                                    <div style={{ width: '180px', height: '180px', background: 'white', borderRadius: '10px', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#000', fontWeight: 'bold', fontSize: '0.9rem' }}>
                                        [BenefitPay QR Code]
                                    </div>
                                    <p style={{ fontSize: '0.9rem', color: 'var(--text-secondary)' }}>ÿßŸÖÿ≥ÿ≠ ÿßŸÑŸÉŸàÿØ ÿ£ÿπŸÑÿßŸá ŸÑÿ•ÿ™ŸÖÿßŸÖ ÿßŸÑÿØŸÅÿπ ÿ®ÿ≥ÿ±ÿπÿ©</p>
                                </div>

                                <p style={{ fontSize: '0.9rem', color: 'var(--text-secondary)', marginBottom: '25px' }}>
                                    ÿ®ÿπÿØ ÿ•ÿ™ŸÖÿßŸÖ ÿßŸÑÿ™ÿ≠ŸàŸäŸÑÿå ÿßÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿ≤ÿ± "ÿ™ÿ£ŸÉŸäÿØ" ÿ£ÿØŸÜÿßŸá ŸÑŸäÿ™ŸÖ ŸÖÿ±ÿßÿ¨ÿπÿ© ÿßŸÑÿ∑ŸÑÿ® Ÿàÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ±ÿµŸäÿØ.
                                </p>

                                <div style={{ display: 'flex', gap: '15px' }}>
                                    <button onClick={() => confirmPayment(showPayment)} className="btn btn-primary" style={{ flex: 1 }} disabled={processing}>
                                        {processing ? 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ£ŸÉŸäÿØ...' : 'ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ™ÿ≠ŸàŸäŸÑ'}
                                    </button>
                                    <button onClick={() => setShowPayment(null)} className="btn btn-outline" style={{ flex: 1 }}>ÿ•ŸÑÿ∫ÿßÿ°</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function App() {
            const { path } = useRouter();
            const { loading, isBlurring, lang, user } = useAuth();
            let Component = HomePage;
            if (path === '/') Component = HomePage;
            else if (path === '/login') Component = LoginPage;
            else if (path === '/register') Component = RegisterPage;
            else if (path === '/dashboard') Component = DashboardPage;
            else if (path === '/image-gen') Component = ImageGenPage;
            else if (path === '/srt') Component = SRTPage;
            else if (path === '/mix') Component = MixPage;
            else if (path === '/montage') Component = MontagePage;
            else if (path === '/ads') Component = AdsPage;
            else if (path === '/pricing') Component = PricingPage;
            else if (path === '/profile') Component = ProfilePage;
            else if (path === '/history') Component = HistoryPage;

            console.log('App Rendering, path:', path, 'loading:', loading);

            if (loading) return (
                <div style={{ minHeight: '100vh', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', background: '#000000', color: '#fff' }}>
                    <div className="animate-spin" style={{ fontSize: '3rem', marginBottom: '15px' }}>‚åõ</div>
                    <div style={{ fontSize: '1.2rem', fontWeight: 'bold', color: 'var(--primary)' }}>ÿ¨ÿßÿ±Ÿä ÿ™ŸáŸäÿ¶ÿ© ŸÖŸÜÿµÿ© ŸÖŸÜÿ®ÿ±...</div>
                </div>
            );

            return (
                <div className={`blur-container ${isBlurring ? 'blur-switching' : ''}`} dir={lang === 'ar' ? 'rtl' : 'ltr'} style={{ minHeight: '100vh', display: 'flex', flexDirection: 'column' }}>
                    <Navbar />
                    <main style={{ flex: 1 }}>
                        <Component />
                    </main>
                </div>
            );
        }

        console.log('Mounting React app...');
        const rootElement = document.getElementById('root');
        if (!rootElement) {
            console.error('Fatal: #root element not found!');
            document.body.innerHTML = '<h1 style="color:white;text-align:center;padding:50px;">ÿÆÿ∑ÿ£ ÿØÿßÿÆŸÑŸä: ÿ™ÿπÿ∞ÿ± ÿ™ÿ≠ŸÖŸäŸÑ Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</h1>';
        } else {
            const root = ReactDOM.createRoot(rootElement);
            try {
                root.render(
                    <RouterProvider>
                        <AuthProvider>
                            <App />
                        </AuthProvider>
                    </RouterProvider>
                );
                console.log('Initial render triggered');
                // Force background change after render to prove JS is working
                setTimeout(() => {
                    document.body.style.background = 'var(--background)';
                }, 100);
            } catch (e) {
                console.error('Critical Render Error:', e);
                rootElement.innerHTML = `<div style="color:white;padding:20px;text-align:center;">
                        <h2>ÿπÿ∞ÿ±ÿßŸãÿå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÖŸàŸÇÿπ</h2>
                        <p>${e.message}</p>
                        <button onclick="location.reload()" class="btn btn-primary">ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ</button>
                    </div>`;
            }
        }
    </script>
</body>

</html>